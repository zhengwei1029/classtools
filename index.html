
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰›å¥½å­¸ï¼šèª²å ‚äº’å‹•so easy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        /* --- å…¨æ–°åˆå§‹ç•«é¢ç¾åŒ–æ¨£å¼ --- */
        body.initial-view-background {
            background-color: #f0f4f8; /* Fallback */
            background-image:
                radial-gradient(circle at 1px 1px, #d1d5db 1px, transparent 0),
                radial-gradient(circle at 20px 20px, #d1d5db 1px, transparent 0);
            background-size: 40px 40px;
        }

        .role-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #ffffff;
            padding: 2rem 1.5rem;
            border-radius: 1rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05);
            transition: all 0.3s ease-in-out;
            text-align: center;
        }
        .role-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.05);
            border-color: #93c5fd; /* Light blue border on hover */
        }
        .role-card-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            transition: all 0.3s ease-in-out;
        }
        .role-card .btn {
            font-size: 1.1rem;
            padding-top: 0.625rem;
            padding-bottom: 0.625rem;
        }
        /* --- åˆå§‹ç•«é¢æ¨£å¼çµæŸ --- */

        /* è‡ªè¨‚æ¨£å¼ */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f4f8; /* æŸ”å’Œçš„èƒŒæ™¯è‰² */
        }
        /* éš±è—å…ƒç´ çš„é€šç”¨ class */
        .hidden {
            display: none;
        }
        /* æŒ‰éˆ•æ¨£å¼ (ç›´æ¥åœ¨ HTML ä¸­ä½¿ç”¨ Tailwind classï¼Œä¸ä½¿ç”¨ @apply) */
        .btn {
            display: inline-block;
            width: 100%;
            padding: 1rem 1.5rem;
            font-size: 1.25rem;
            line-height: 1.75rem;
            font-weight: 700;
            color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: transform 0.2s ease-in-out;
        }
        .btn:hover {
            transform: scale(1.05);
        }
        .btn-primary { background-color: #2563eb; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-green { background-color: #16a34a; }
        .btn-green:hover { background-color: #15803d; }
        .btn-orange { background-color: #ea580c; }
        .btn-orange:hover { background-color: #c2410c; }
        .btn-purple { background-color: #9333ea; }
        .btn-purple:hover { background-color: #7e22ce; }
        .btn-red { background-color: #dc2626; }
        .btn-red:hover { background-color: #b91c1c; }
        .btn-teal { background-color: #0d9488; } /* New Teal color */
        .btn-teal:hover { background-color: #0f766e; }
        .btn-gray { background-color: #9ca3af; cursor: not-allowed; }

        /* æ¶ç­”æŒ‰éˆ•æ¨£å¼ */
        .quick-answer-btn {
            position: absolute;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            font-size: 24px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            pointer-events: auto;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }
        .quick-answer-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.4);
        }
        .quick-answer-btn:active {
            transform: scale(0.95);
        }
        .quick-answer-btn.locked {
            background: #9ca3af;
            cursor: not-allowed;
            animation: none;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* ç¹ªåœ–æ¿ Canvas æ¨£å¼ */
        #drawing-canvas {
            border: 2px solid #cbd5e1;
            border-radius: 0.5rem;
            cursor: crosshair;
            touch-action: none; /* é˜²æ­¢åœ¨ canvas ä¸Šç¹ªåœ–æ™‚è§¸ç™¼é é¢æ»¾å‹• */
            display: block; /* Ensures it takes up its own line and respects margins */
            margin: 0 auto; /* Center the canvas */
            background-color: white; /* ç¹ªåœ–ç•«å¸ƒèƒŒæ™¯è‰² */
            flex-grow: 1; /* Allow canvas to take available vertical space */
            width: 100%; /* Ensure canvas takes full width within its container */
        }
        /* å­¸ç”Ÿä½œç­”çµæœå¡ç‰‡ */
        .student-card {
            background-color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            margin-bottom: 0.75rem;
            word-break: break-all;
        }

        /* æ–°å¢ï¼šç”¨æ–¼å­¸ç”Ÿä½œç­”åˆ—è¡¨çš„å¡ç‰‡æ¨£å¼ */
        .student-response-item {
            background-color: #fff;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* å°‡å…§å®¹å‘å·¦å°é½Š */
            justify-content: flex-start; /* å°‡å…§å®¹å‘ä¸Šå°é½Š */
            text-align: left; /* å°‡æ–‡æœ¬å‘å·¦å°é½Š */
            transition: border 0.3s ease-in-out, box-shadow 0.3s ease-in-out; /* Add transition for smooth border change */
        }
        .student-response-item .name-box {
            background-color: #d1e7dd; /* Light green for name */
            color: #0f5132; /* Dark green text */
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            width: 100%; /* Take full width within its grid column */
            max-width: 150px; /* Max width for name box */
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
            text-align: center; /* è®“å§“ååœ¨æ¡†å…§ç½®ä¸­ */
        }
        .student-response-item .answer-box {
            background-color: white; /* Changed to white */
            color: #0e7490; /* Dark blue text */
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            width: 100%; /* Take full width within its grid column */
            word-break: break-word;
            flex-grow: 1; /* Allow answer box to take available space */
            min-height: 48px; /* Ensure a consistent height regardless of content */
            display: flex; /* To vertically center content */
            align-items: center;
            justify-content: center;
        }
        .student-response-item .answer-box img {
            max-width: 100%; /* Make images responsive within the answer box */
            height: auto;
            max-height: 120px; /* Limit image height to prevent large images */
            object-fit: contain; /* Ensure image fits without cropping */
            display: block; /* Remove extra space below image */
            margin: 0 auto; /* Center image if it's smaller than max-width */
        }
        .student-response-item .answer-box audio {
            width: 100%;
            max-width: 200px; /* Limit audio player width */
        }
        /* New: Styles for custom multiple choice answers in teacher monitor */
        .student-response-item .mc-question-answer {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
            color: #334155;
        }
        .student-response-item .mc-question-answer .icon {
            font-size: 1.1rem;
        }
        .student-response-item .mc-question-answer .correct-icon {
            color: #16a34a; /* Green */
        }
        .student-response-item .mc-question-answer .incorrect-icon {
            color: #dc2626; /* Red */
        }
        .student-response-item .mc-question-answer .question-text {
            font-weight: 500;
        }
        .student-response-item .mc-question-answer .student-choice {
            font-weight: bold;
            color: #2563eb; /* Blue */
        }

        /* äº’è©•æŠ•ç¥¨ç›¸é—œæ¨£å¼ */
        .peer-review-work-item {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            border: 2px solid transparent;
        }
        
        .peer-review-work-item:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        
        .peer-review-work-item .work-author {
            background-color: #e0f2fe;
            color: #0369a1;
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            font-weight: bold;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }
        
        .peer-review-work-item .work-content {
            flex-grow: 1;
            margin-bottom: 0.75rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .peer-review-work-item .work-content img {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .peer-review-work-item .work-content p {
            padding: 0.5rem;
            background-color: #f8fafc;
            border-radius: 0.5rem;
            color: #374151;
            line-height: 1.5;
        }
        
        .peer-review-work-item .vote-section {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .peer-review-work-item .vote-btn {
            background: none;
            border: 2px solid transparent;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 0.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 3rem;
            height: 3rem;
            position: relative;
        }
        
        .peer-review-work-item .vote-btn:hover {
            background-color: #fef7f7;
            transform: scale(1.1);
            border-color: #fca5a5;
        }
        
        .peer-review-work-item .vote-btn.voted {
            color: #dc2626;
            background-color: #fef2f2;
            border-color: #dc2626;
            animation: pulse 2s infinite;
        }
        
        .peer-review-work-item .vote-btn:not(.voted) {
            color: #9ca3af;
            border-color: #e5e7eb;
        }
        
        .peer-review-work-item .vote-btn:not(.voted):hover {
            color: #dc2626;
            background-color: #fef7f7;
        }
        
        /* Pulse animation for voted buttons */
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        
        /* Tooltip for vote buttons */
        .peer-review-work-item .vote-btn::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: -2rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #374151;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
            z-index: 10;
        }
        
        .peer-review-work-item .vote-btn:hover::after {
            opacity: 1;
            visibility: visible;
        }
        
        .peer-review-work-item .vote-count {
            font-weight: bold;
            color: #dc2626;
            font-size: 1.1rem;
        }
        
        .peer-review-work-item .vote-count.zero {
            color: #9ca3af;
        }

        /* æ•™å¸«ç«¯æŠ•ç¥¨çµ±è¨ˆæ¨£å¼ */
        .vote-stats-item {
            background-color: #f8fafc;
            border-radius: 0.75rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            border: 1px solid #e2e8f0;
            position: relative;
        }
        
        .vote-stats-item .stats-author {
            background-color: #dbeafe;
            color: #1e40af;
            padding: 0.375rem 0.75rem;
            border-radius: 0.75rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }
        
        .vote-stats-item .stats-content {
            flex-grow: 1;
            margin-bottom: 0.5rem;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .vote-stats-item .stats-content img {
            max-width: 100%;
            height: auto;
            border-radius: 0.375rem;
            max-height: 120px;
            object-fit: contain;
        }
        
        .vote-stats-item .stats-content p {
            padding: 0.375rem;
            background-color: white;
            border-radius: 0.375rem;
            color: #374151;
            font-size: 0.875rem;
            line-height: 1.4;
        }
        
        .vote-stats-item .stats-votes {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.5rem;
            background-color: #fef2f2;
            border-radius: 0.5rem;
            border: 1px solid #fecaca;
        }
        
        .vote-stats-item .stats-votes .vote-icon {
            color: #dc2626;
            font-size: 1.2rem;
        }
        
        .vote-stats-item .stats-votes .vote-count {
            font-weight: bold;
            color: #dc2626;
            font-size: 1.1rem;
        }
        
        .vote-stats-item .stats-votes .vote-count.zero {
            color: #9ca3af;
        }


        /* æ”¾å¤§ç¹ªåœ– Modal æ¨£å¼ */
        .magnified-image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        .magnified-image-modal-content {
            position: relative;
            background-color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto; /* Allow scrolling for large content */
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
        }

        /* æ’åºé¡Œå’Œé…å°é¡Œçš„æ¨¡æ…‹æ¡†æ¨£å¼ */
        #sequencing-settings-modal-content,
        #matching-settings-modal-content {
            max-width: 95%;
            max-height: 95vh;
            width: 1200px;
            justify-content: flex-start;
            align-items: stretch;
        }
        .magnified-image-modal-content img {
            max-width: 100%;
            max-height: 80vh; /* Limit image height within modal */
            object-fit: contain;
        }
        .magnified-image-modal-close {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            font-size: 2rem;
            color: #333;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
        }
        .magnified-image-modal-close:hover {
            background-color: #eee;
        }

        /* Dropdown styles for drawing tools */
        .drawing-tool-select {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            background-color: white;
            font-size: 1rem;
            height: 44px; /* Match button height for alignment */
            cursor: pointer;
            min-width: 100px; /* Ensure dropdown has minimum width */
            appearance: none; /* Remove default dropdown arrow */
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.25em 1.25em;
        }

        /* Styles for color swatch in dropdown */
        .color-option-text {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .color-swatch {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 1px solid #ccc;
            flex-shrink: 0; /* Prevent shrinking when text is long */
        }
        /* Hidden select for visual color swatch */
        #current-color-swatch {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #2563eb; /* Highlight selected color */
            margin-right: 8px;
            display: inline-block;
            vertical-align: middle;
            flex-shrink: 0;
        }

        /* Made by link styling */
        .made-by-text {
            background-color: #e0f7fa; /* Light blue background */
            color: #007bff; /* Blue text */
            padding: 8px 15px;
            border-radius: 12px; /* Rounded corners */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-decoration: none; /* Remove underline */
            transition: background-color 0.3s ease;
        }
        .made-by-text:hover {
            background-color: #cceeff; /* Lighter blue on hover */
            color: #0056b3;
        }

        /* Modal for student list */
        #student-list-modal-content {
            padding: 1rem;
            max-width: 700px; /* Adjusted max-width for 5 columns */
            width: 100%;
        }
        /* Applying grid to modal-student-names */
        #modal-student-names {
            display: grid;
            /* Changed to fixed 5 columns on larger screens, responsive down to 100px min width */
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.5rem; /* Gap between grid items */
            padding: 0.5rem; /* Padding for the grid container */
            max-height: 64vh; /* Adjusted to fit more height */
            overflow-y: auto;
            background-color: #f8fafc; /* Light background */
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
        }
        @media (min-width: 768px) { /* md breakpoint */
            #modal-student-names {
                grid-template-columns: repeat(5, 1fr); /* Fixed 5 columns for md and larger */
            }
        }
        #modal-student-names p {
            background-color: #e0f2f7; /* Light blue background for each name */
            padding: 0.5rem;
            border-radius: 0.375rem;
            text-align: center;
            font-size: 0.9rem;
            color: #0e7490;
            font-weight: 500;
            overflow: hidden; /* Hide overflow text */
            text-overflow: ellipsis; /* Add ellipsis for overflow */
            white-space: nowrap; /* Prevent text wrapping */
            border-bottom: none; /* Remove individual border-bottom, handled by grid gap */
            margin: 0; /* Remove default paragraph margin */
            transition: all 0.2s ease-in-out; /* Add transition for smooth highlight */
        }
        /* No specific styling for the last-child within the grid items, as gap handles spacing */

        /* NEW: Styles for Unsubmitted Students Modal */
        #modal-unsubmitted-student-names {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.5rem;
            padding: 0.5rem;
            max-height: 64vh;
            overflow-y: auto;
            background-color: #fef2f2; /* Light red background */
            border-radius: 0.5rem;
            border: 1px solid #fca5a5; /* Red border */
        }
        #modal-unsubmitted-student-names p {
            background-color: #fee2e2; /* Lighter red background for each name */
            padding: 0.5rem;
            border-radius: 0.375rem;
            text-align: center;
            font-size: 0.9rem;
            color: #b91c1c; /* Darker red text */
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin: 0;
        }
        @media (min-width: 768px) { /* md breakpoint */
            #modal-unsubmitted-student-names {
                grid-template-columns: repeat(5, 1fr);
            }
        }


        /* Styles for Chart Modal */
        #statistics-modal-content { /* Changed ID to match HTML */
            padding: 1rem;
            max-width: 600px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        #chart-svg {
            display: block;
            margin: 0 auto;
            background-color: #fff; /* Ensure chart background is white */
            border-radius: 0.5rem;
            flex-shrink: 0; /* Prevent shrinking */
        }
        #students-by-answer-list-container {
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.75rem;
            background-color: #f8fafc;
        }
        #students-by-answer-list-container h5 {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #334155;
        }
        /* New style for the paragraph containing names */
        #students-by-answer-names {
            word-wrap: break-word; /* Allow long names to wrap */
            color: #475569;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* New CSS for selected student border */
        .selected-student-border {
            border: 4px solid #ef4444; /* Tailwind red-500 */
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.6); /* Optional: add a glow effect */
        }

        /* NEW CSS for selected student border in the modal */
        .modal-selected-student-border {
            border: 2px solid #ef4444; /* Red border */
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.4); /* Optional: add a glow effect */
            background-color: #fef2f2; /* Light red background */
        }


        /* AI Text Summary Modal Styles */
        #ai-summary-modal-content {
            padding: 1.5rem;
            max-width: 500px;
            width: 90%;
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            position: relative; /* Needed for close button positioning */
        }
        #ai-summary-modal-content h4 {
            font-size: 1.75rem;
            font-weight: bold;
            color: #334155;
            text-align: center;
            margin-bottom: 0.5rem;
        }
        #ai-summary-result-list {
            list-style-type: none; /* Removed decimal numbering */
            padding-left: 0; /* Removed default padding for list */
            font-size: 1rem;
        }
        /* Default style for list items (successful results) */
        #ai-summary-result-list li {
            margin-bottom: 0.4rem;
            padding: 0.2rem 0;
            border-bottom: 1px dashed #e2e8f0;
            color: black; /* Changed to black */
            font-weight: bold; /* Added bold */
        }
        #ai-summary-result-list li:last-child {
            border-bottom: none;
        }
        /* Style for error messages within the list */
        #ai-summary-result-list li.error-message {
            color: white; /* White color for error messages */
            background-color: #dc2626; /* A red background for visual emphasis (optional, but good for error) */
            padding: 0.5rem;
            border-radius: 0.25rem;
            text-align: center;
        }
        #ai-loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100px; /* Ensure some height for spinner */
            color: #2563eb;
            font-size: 1.1rem;
        }

        /* AI Settings Modal Styles */
        #ai-settings-modal-content {
            padding: 1.5rem;
            max-width: 400px;
            width: 90%;
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            position: relative;
        }
        #ai-settings-modal-content h4 {
            font-size: 1.75rem;
            font-weight: bold;
            color: #334155;
            text-align: center;
            margin-bottom: 0.5rem;
        }
        #ai-settings-modal-content label {
            font-weight: 500;
            color: #475569;
            margin-bottom: 0.25rem;
            display: block;
        }
        #ai-settings-modal-content select,
        #ai-settings-modal-content input[type="password"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            background-color: white;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.25em 1.25em;
        }
        #ai-settings-modal-content input[type="password"] {
            background-image: none; /* Remove dropdown arrow for password field */
        }
        .settings-button-group {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 1rem;
        }
        .settings-button-group .btn {
            width: auto;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
        }

        /* New: URL Dispatch Modal Styles */
        #url-dispatch-settings-modal-content {
            padding: 1.5rem;
            max-width: 500px;
            width: 90%;
        }
        #url-dispatch-settings-modal-content h4 {
            font-size: 1.75rem;
            font-weight: bold;
            color: #334155;
            text-align: center;
            margin-bottom: 1.5rem;
        }
        #url-dispatch-settings-modal-content label {
            font-weight: 500;
            color: #475569;
            margin-bottom: 0.25rem;
            display: block;
        }
        #url-dispatch-settings-modal-content input[type="text"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-top: 1rem;
            gap: 0.5rem;
        }
        .checkbox-container input[type="checkbox"] {
            height: 1.25rem;
            width: 1.25rem;
            border-radius: 0.25rem;
            border-color: #d1d5db;
            color: #2563eb;
        }

        /* New: Student-side URL Dispatch Styles */
        #interaction-url-dispatch {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            padding: 1rem;
        }
        .url-card {
            background-color: #ffffff;
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            text-decoration: none;
            color: inherit;
        }
        .url-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }
        .url-card-icon {
            font-size: 4rem;
            color: #2563eb;
        }
        .url-card-text {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e3a8a;
        }
        .url-card-link {
            font-size: 1rem;
            color: #6b7280;
            word-break: break-all;
        }
        .youtube-embed-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            background-color: #000; /* æ·»åŠ é»‘è‰²èƒŒæ™¯ï¼Œå¦‚æœå½±ç‰‡è¼‰å…¥å¤±æ•—æœƒçœ‹åˆ° */
        }
        .youtube-embed-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }

        /* NEW: Pause Overlay for Student */
        .pause-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9); /* Semi-transparent white */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 999; /* Below modals */
            border-radius: 0.5rem; /* Match container border-radius */
            text-align: center;
            padding: 1rem;
        }
        .pause-overlay p {
            font-size: 2rem;
            font-weight: bold;
            color: #dc2626; /* Red text */
            margin-bottom: 1rem;
        }
        .pause-overlay i {
            font-size: 4rem;
            color: #ef4444; /* Lighter red icon */
        }

        /* NEW: HTML Dispatch Styles */
        /* This ID is now reused for the combined dispatch, but the content will be in the iframe */
        #interaction-html-dispatch {
            position: fixed; /* Use fixed positioning to cover entire screen */
            top: 0;
            left: 0;
            width: 100vw; /* Full viewport width */
            height: 100vh; /* Full viewport height */
            margin: 0;
            padding: 0;
            border: none;
            overflow: hidden; /* Prevent scrolling at container level */
            background-color: white;
            z-index: 1000; /* Ensure it's above other content */
        }
        #html-content-iframe {
            width: 100vw; /* Full viewport width */
            height: 100vh; /* Full viewport height */
            margin: 0;
            padding: 0;
            border: none;
            background-color: white;
            display: block; /* Ensure no inline spacing */
        }

        /* HTML Dispatch Status Indicator */
        .html-dispatch-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background-color: rgba(239, 68, 68, 0.9); /* Red background with transparency */
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1001; /* Above the HTML content */
            animation: blink-glow 1.5s ease-in-out infinite alternate;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        @keyframes blink-glow {
            0% {
                opacity: 0.7;
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
            }
            100% {
                opacity: 1;
                transform: scale(1.05);
                box-shadow: 0 4px 16px rgba(239, 68, 68, 0.6);
            }
        }

        /* NEW: Styles for enlarged default multiple-choice buttons */
        #interaction-multiple-choice.enlarged-buttons #default-mc-options .answer-btn {
            width: 12rem; /* Double the original 6rem (h-24) */
            height: 12rem; /* Double the original 6rem (h-24) */
            font-size: 8rem; /* Double the original 4rem (text-7xl) */
        }
        
        /* MODIFIED: MC Settings Modal for AI Question Generation */
        #multiple-choice-settings-modal {
            align-items: center; /* Center modal vertically */
        }

        #multiple-choice-settings-modal-content {
            max-width: 800px; /* Wider modal for two columns */
            max-height: 95vh; /* Increase max height */
            height: auto; /* Allow dynamic height */
            justify-content: flex-start; /* Align content to top */
            align-items: stretch; /* Stretch to full width */
            padding: 1.5rem; /* Increase padding */
            margin-top: 0; /* Remove top margin */
        }

        /* Sequencing Question Styles */
        .sequencing-item {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1rem 1.5rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            cursor: grab;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1.125rem;
            font-weight: 500;
        }
        .sequencing-item:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        .sequencing-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        .sequencing-item.drag-over {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .sequencing-item-number {
            background-color: #3b82f6;
            color: white;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }
        .sequencing-container {
            max-width: 600px;
            margin: 0 auto;
        }

        /* Matching Question Styles */
        .matching-container {
            max-width: 900px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            position: relative;
        }
        .matching-column {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .matching-item {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1rem 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.2s ease;
            border: 3px solid transparent;
            font-size: 1.125rem;
            font-weight: 500;
            min-height: 4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .matching-item:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        .matching-item.selected {
            border-color: #ec4899;
            background-color: #fdf2f8;
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.2);
        }
        .matching-item.matched {
            border-color: #10b981;
            background-color: #ecfdf5;
            cursor: default;
        }
        .matching-item.matched:hover {
            transform: none;
        }
        #matching-svg-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        .matching-line {
            stroke: #ec4899;
            stroke-width: 3;
            fill: none;
            stroke-linecap: round;
        }
        .matching-line.correct {
            stroke: #10b981;
        }
        .matching-line.incorrect {
            stroke: #ef4444;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <div id="app-container" class="w-full max-w-4xl mx-auto p-4 md:p-6">

        <div id="entry-view" class="w-full h-screen flex flex-col items-center justify-center p-4">
            <!-- å»ºç½®èªªæ˜æŒ‰éˆ• -->
            <div class="absolute top-4 right-4 z-10">
                <a href="https://filedn.com/laMtL9jmKf7JrDEQG0A6OPy/html/%E5%89%9B%E5%A5%BD%E5%AD%B8%E6%9C%80%E6%96%B0%E7%89%88-%E5%BB%BA%E7%BD%AE%E6%89%8B%E5%86%8A/%E5%89%9B%E5%A5%BD%E5%AD%B8%E6%95%99%E5%B8%AB%E4%BD%BF%E7%94%A8%E5%BB%BA%E7%BD%AE%E6%89%8B%E5%86%8ANew.html" target="_blank" rel="noopener noreferrer" 
                   class="inline-flex items-center px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium rounded-lg shadow-md transition-all duration-200 hover:shadow-lg">
                    <i class="fas fa-play-circle mr-2"></i>
                    å»ºç½®æ“ä½œæ‰‹å†Š
                </a>
            </div>
            
            <div class="w-full max-w-3xl bg-white/80 backdrop-blur-sm p-8 md:p-12 rounded-2xl shadow-xl text-center border border-gray-200">
        
                <div class="flex flex-col md:flex-row items-center justify-center mb-6">
                    <i class="fas fa-rocket text-5xl text-indigo-500 mb-4 md:mb-0 md:mr-6"></i>
                    <div>
                        <h1 class="text-4xl md:text-5xl font-bold text-gray-800">å‰›å¥½å­¸ï¼šèª²å ‚äº’å‹•so easy</h1>
                        <p class="text-lg text-gray-600 mt-2">ä¸€å€‹å°ˆç‚ºç¾ä»£èª²å ‚è¨­è¨ˆçš„å³æ™‚äº’å‹•å·¥å…·</p>
                    </div>
                </div>
                
                <hr class="my-8 border-gray-200">
        
                <p class="text-xl font-medium text-gray-700 mb-6">è«‹é¸æ“‡æ‚¨çš„è§’è‰²ä»¥é–‹å§‹</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="role-card group">
                        <div class="role-card-icon bg-blue-100 text-blue-500 group-hover:bg-blue-500 group-hover:text-white">
                            <i class="fas fa-chalkboard-teacher"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800 mt-4">æˆ‘æ˜¯æ•™å¸«</h2>
                        <p class="text-gray-500 my-2 h-12">å»ºç«‹æ•™å®¤ï¼Œç™¼èµ·äº’å‹•ï¼Œå³æ™‚æŸ¥çœ‹å­¸ç”Ÿåé¥‹ã€‚</p>
                        <button id="teacher-entry-btn" class="btn btn-primary !w-full">å»ºç«‹æˆ–é€²å…¥æ•™å®¤</button>
                    </div>
                    <div class="role-card group">
                         <div class="role-card-icon bg-green-100 text-green-500 group-hover:bg-green-500 group-hover:text-white">
                            <i class="fas fa-user-graduate"></i>
                         </div>
                         <h2 class="text-2xl font-bold text-gray-800 mt-4">æˆ‘æ˜¯å­¸ç”Ÿ</h2>
                         <p class="text-gray-500 my-2 h-12">è¼¸å…¥æ•™å®¤ä»£ç¢¼ï¼Œåƒèˆ‡èª²å ‚å•ç­”èˆ‡äº’å‹•ã€‚</p>
                        <button id="student-entry-btn" class="btn btn-green !w-full">åŠ å…¥èª²å ‚</button>
                    </div>
                </div>
            </div>
        
            <div class="text-center mt-6 text-gray-600">
                <p class="text-xs">App ID: <span id="app-id-display"></span> &nbsp;&bull;&nbsp; User ID: <span id="user-id-display"></span></p>
                <div class="mt-2">
                    <a href="https://kentxchang.blogspot.tw" target="_blank" rel="noopener noreferrer" class="made-by-text !bg-white/50 !text-indigo-600 hover:!bg-white">
                       Made by é˜¿å‰›è€å¸«V2.5
                    </a>
                </div>
            </div>
        </div>

        <div id="teacher-classroom-code-view" class="hidden text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">æ•™å¸«ç™»å…¥ï¼šè«‹è¼¸å…¥æ•™å®¤ä»£ç¢¼</h2>
            <div class="max-w-sm mx-auto">
                <input type="text" id="teacher-classroom-code-input" placeholder="è«‹è¼¸å…¥è‡ªè¨‚æ•™å®¤ä»£ç¢¼" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="teacher-classroom-code-submit-btn" class="btn btn-primary mt-4">é€²å…¥æ•™å¸«é¢æ¿ â¡ï¸</button>
                <button id="teacher-classroom-code-back-btn" class="btn btn-gray mt-2">è¿”å› â†©ï¸</button>
            </div>
        </div>

        <div id="teacher-menu-view" class="hidden text-center relative">
            <h2 class="text-3xl font-bold text-gray-800 mb-8">æ•™å¸«é¢æ¿ï¼šè«‹é¸æ“‡äº’å‹•æ¨¡å¼</h2>
            <div class="absolute top-4 right-4 flex flex-col items-end">
                <div class="flex items-center gap-2 p-2 rounded-md bg-white shadow-sm">
                    <div id="student-status-area" class="text-gray-600 text-lg cursor-pointer flex items-center justify-center hover:bg-gray-200 transition-colors">
                        <span>ç›®å‰æœ‰ <span id="active-student-count" class="font-bold text-blue-700">0</span> ä½å­¸ç”Ÿåœ¨ç·š</span>
                    </div>
                    <button id="refresh-student-count-btn" class="text-gray-500 hover:text-blue-700 transition-colors" title="æ›´æ–°çµ±è¨ˆ">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                </div>

            <div class="absolute top-4 left-4">
                <button id="end-class-session-menu-btn" class="btn btn-red !w-auto text-base h-11 px-4 py-2 flex items-center justify-center" title="ä¸‹èª²ä¸¦æ¸…ç©ºè³‡æ–™">
                    <i class="fas fa-door-open mr-2"></i> <span id="end-class-button-text">ä¸‹èª² ğŸ”š</span>
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mx-auto w-fit">
                <button data-mode="true_false" class="btn btn-primary !w-40 !h-40 flex items-center justify-center text-4xl">A. æ˜¯éé¡Œ</button>
                <button id="choice-sequencing-matching-menu-btn" class="btn btn-green !w-40 !h-40 flex items-center justify-center text-3xl">B. é¸æ“‡/æ’åº/é…å°</button>
                <button data-mode="text_input" class="btn btn-orange !w-40 !h-40 flex items-center justify-center text-4xl">C. æ–‡å­—é¡Œ</button>
                <button data-mode="drawing" class="btn btn-purple !w-40 !h-40 flex items-center justify-center text-4xl">D. ç¹ªåœ–é¡Œ</button>
                <button data-mode="url_dispatch" class="btn btn-teal !w-40 !h-40 flex items-center justify-center text-4xl">E. æ´¾é€ç¶²å€/HTML</button>
                <button data-mode="recording" class="btn bg-indigo-600 hover:bg-indigo-700 !w-40 !h-40 flex items-center justify-center text-4xl">F. éŒ„éŸ³é¡Œ</button>
                <button id="reading-comprehension-settings-btn" class="btn bg-red-500 hover:bg-red-600 !w-40 !h-40 flex items-center justify-center text-4xl">G. é–±è®€æ¸¬é©—</button>
                <button data-mode="quick_answer" class="btn bg-orange-500 hover:bg-orange-600 !w-40 !h-40 flex items-center justify-center text-4xl">H. æ¶ç­”</button>
                <button id="quick-poll-settings-btn" class="btn bg-lime-500 hover:bg-lime-600 !w-40 !h-40 flex items-center justify-center text-4xl">I. å¿«é€ŸæŠ•ç¥¨</button>
            </div>
            <div class="mt-8 flex flex-col items-center">
                <div class="flex gap-4 mb-4">
                    <label for="teacher-image-upload-input" class="btn btn-purple !w-auto text-base h-11 px-4 py-2 flex items-center justify-center cursor-pointer">
                        <i class="fas fa-upload mr-2"></i> ä¸Šå‚³ç¹ªåœ–èƒŒæ™¯åœ–ç‰‡ (æ•™å¸«ç”¨) ğŸ–¼ï¸
                    </label>
                    <input type="file" id="teacher-image-upload-input" accept="image/*" class="hidden">
                    <button id="clear-teacher-background-btn" class="btn btn-red !w-auto text-base h-11 px-4 py-2 flex items-center justify-center">
                        <i class="fas fa-trash mr-2"></i> æ¸…é™¤èƒŒæ™¯åœ– ğŸ—‘ï¸
                    </button>
                </div>
                <p id="teacher-image-status" class="text-gray-600 text-sm mt-2">ç›®å‰æ²’æœ‰èƒŒæ™¯åœ–ç‰‡ã€‚å¯é¸æ“‡æª”æ¡ˆæˆ–ç›´æ¥è²¼ä¸Š(Ctrl+V)ã€‚</p>
                <div id="teacher-image-preview-container" class="mt-4 hidden border border-gray-300 rounded-lg p-2 max-w-xs">
                    <img id="teacher-image-preview" src="" alt="èƒŒæ™¯åœ–ç‰‡é è¦½" class="w-full h-auto rounded-md object-contain">
                </div>
            </div>

            <div class="absolute bottom-4 left-4">
                <button id="ai-settings-btn" class="text-gray-500 hover:text-blue-700 transition-colors text-3xl" title="AI è¨­å®š">
                    <i class="fas fa-robot"></i>
                </button>
            </div>
            <div class="absolute bottom-4 right-4">
                 <button id="url-dispatch-settings-btn" class="text-gray-500 hover:text-teal-700 transition-colors text-3xl" title="è¨­å®šæ´¾é€ç¶²å€/HTML">
                    <i class="fas fa-link"></i>
                </button>
            </div>
        </div>
        
        <div id="teacher-monitor-view" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-4"> <button id="end-class-session-monitor-btn" class="btn btn-red !w-auto text-base h-11 px-4 py-2 flex items-center justify-center" title="ä¸‹èª²ä¸¦æ¸…ç©ºè³‡æ–™">
                        <i class="fas fa-door-open mr-2"></i> <span id="end-class-monitor-button-text">ä¸‹èª² ğŸ”š</span>
                    </button>
                    <h2 class="text-3xl font-bold text-gray-800"></h2>
                </div>
                <div class="flex gap-2">
                     <button id="toggle-pause-btn" class="btn bg-gray-500 hover:bg-gray-600 !w-auto text-sm">
                        <i class="fas fa-pause mr-2"></i> <span id="toggle-pause-btn-text">æš«åœå›è¦† â¸ï¸</span>
                     </button>
                     <button id="draw-lottery-btn" class="btn btn-orange !w-auto text-sm">æŠ½ç±¤ ğŸ²</button> <button id="show-unsubmitted-students-btn" class="btn btn-orange !w-auto text-sm hidden">æœªä½œç­”å­¸ç”Ÿ ğŸ“</button>
                     <button id="ai-text-summary-btn" class="btn btn-purple !w-auto text-sm hidden">AI æ–‡å­—åˆ†æ ğŸ¤–</button> 
                     <button id="download-media-btn" class="btn btn-purple !w-auto text-sm hidden">ä¸‹è¼‰æ‰€æœ‰åª’é«” ğŸ’¾</button> 
                     <button id="show-statistics-btn" class="btn btn-primary !w-auto text-sm hidden">é¡¯ç¤ºçµ±è¨ˆ ğŸ“Š</button>
                     <button id="start-peer-review-btn" class="btn btn-teal !w-auto text-sm hidden">é–‹å§‹äº’è©• â¤ï¸</button>
                     <button id="view-questions-btn" class="btn bg-indigo-600 hover:bg-indigo-700 !w-auto text-sm hidden">æŸ¥çœ‹é¡Œç›® ğŸ“</button>
                     <button id="view-reading-questions-btn" class="btn bg-red-600 hover:bg-red-700 !w-auto text-sm hidden">é¡¯ç¤ºé¡Œç›® ğŸ“–</button>
                     <button id="download-responses-btn" class="btn btn-green !w-auto text-sm hidden">ä¸‹è¼‰å›æ‡‰ ğŸ“¥</button>
                     <button id="end-interaction-btn" class="btn btn-red !w-auto text-sm">çµæŸäº’å‹• ğŸ›‘</button>
                 </div>
            </div>
            <div id="student-responses-container" class="bg-gray-100 p-4 rounded-lg h-96 overflow-y-auto grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                <p class="text-gray-500 text-center col-span-full">æ­£åœ¨ç­‰å¾…å­¸ç”Ÿä½œç­”...</p>
            </div>
            
            <div id="peer-review-stats-container" class="hidden mt-6">
                <div class="bg-white p-4 rounded-lg border">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">ğŸ“Š å³æ™‚æŠ•ç¥¨çµ±è¨ˆ</h3>
                    <div id="peer-review-stats-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                        <p class="text-gray-500 text-center col-span-full">å°šæœªé–‹å§‹äº’è©•...</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="student-name-view" class="text-center hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">è«‹è¼¸å…¥æ•™å®¤ä»£ç¢¼èˆ‡æ‚¨çš„å§“å</h2>
            <div class="max-w-sm mx-auto space-y-4">
                <input type="text" id="student-classroom-code-input" placeholder="è«‹è¼¸å…¥æ•™å®¤ä»£ç¢¼" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="text" id="student-name-input" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="submit-name-btn" class="btn btn-primary mt-4">é€²å…¥æ•™å®¤ ğŸšª</button>
            </div>
        </div>
        
        <div id="student-waiting-view" class="text-center hidden">
             <h2 id="student-welcome-msg" class="text-3xl font-bold text-gray-800 mb-6"></h2>
             <div class="flex items-center justify-center space-x-3 text-xl text-gray-600">
                <i class="fas fa-spinner fa-spin"></i>
                <p>è«‹ç­‰å¾…è€å¸«é–‹å§‹äº’å‹•...</p>
            </div>
        </div>
        
        <div id="student-interaction-view" class="hidden relative">
            <div id="student-pause-overlay" class="pause-overlay hidden">
                <p>è€å¸«å·²æš«åœå›è¦†</p>
                <i class="fas fa-hand-paper"></i>
            </div>

            <div id="interaction-true-false" class="hidden">
                <h3 class="text-2xl font-bold text-center mb-6">æ˜¯éé¡Œ</h3>
                <div class="flex justify-center gap-4">
                    <button data-answer="O" class="answer-btn text-6xl w-32 h-32 rounded-full bg-green-500 text-white flex items-center justify-center shadow-lg transform hover:scale-110 transition">O</button>
                    <button data-answer="X" class="answer-btn text-6xl w-32 h-32 rounded-full bg-red-500 text-white flex items-center justify-center shadow-lg transform hover:scale-110 transition">X</button>
                </div>
            </div>
            <div id="interaction-multiple-choice" class="hidden flex flex-col items-center">
                <h3 class="text-2xl font-bold text-center mb-6">é¸æ“‡é¡Œ</h3>
                <div id="default-mc-options" class="grid grid-cols-2 gap-4">
                     <button data-answer="1" class="answer-btn btn bg-blue-500 hover:bg-blue-600 h-24 text-7xl">1</button>
                     <button data-answer="2" class="answer-btn btn bg-yellow-500 hover:bg-yellow-600 h-24 text-7xl">2</button>
                     <button data-answer="3" class="answer-btn btn bg-green-500 hover:bg-green-600 h-24 text-7xl">3</button>
                     <button data-answer="4" class="answer-btn btn bg-red-500 hover:bg-red-600 h-24 text-7xl">4</button>
                </div>
                <div id="custom-mc-questions-container" class="hidden w-full max-w-2xl space-y-6 text-left">
                    </div>
                <button id="submit-custom-mc-btn" class="btn btn-primary mt-6 hidden max-w-sm mx-auto">é€å‡ºå…¨éƒ¨ç­”æ¡ˆ âœ‰ï¸</button>
            </div>
            <div id="interaction-text-input" class="hidden text-center">
                 <h3 class="text-2xl font-bold text-center mb-6">æ–‡å­—é¡Œ</h3>
                 <textarea id="text-input-area" rows="6" class="w-full p-3 border rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ‚¨çš„å›ç­”..."></textarea>
                 <button id="submit-text-btn" class="btn btn-primary mt-4 max-w-sm mx-auto">é€å‡ºå›ç­” âœ‰ï¸</button>
            </div>
            <div id="interaction-drawing" class="hidden text-center flex flex-col h-full min-h-screen">
                <h3 class="text-2xl font-bold text-center mb-4">ç¹ªåœ–é¡Œ</h3>
                <div class="flex flex-wrap justify-center md:justify-start items-center gap-4 mb-4 p-2 bg-gray-50 rounded-lg shadow-sm flex-shrink-0">
                    <button id="pen-tool-btn" class="p-2 rounded-lg border-2 border-blue-500 transition-all duration-150 ease-in-out h-11 flex items-center" title="ç•«ç­†">
                        <i class="fas fa-paint-brush mr-1"></i> ç•«ç­† âœï¸
                    </button>
                    <div class="flex items-center gap-2">
                        <label class="text-gray-700 font-medium flex items-center" for="color-select">
                            <span id="current-color-swatch" class="color-swatch mr-2 bg-black"></span> é¡è‰²:
                        </label>
                        <select id="color-select" class="drawing-tool-select">
                            <option value="black" style="background-color: black; color: white;">é»‘è‰²</option>
                            <option value="red" style="background-color: red; color: white;">ç´…è‰²</option>
                            <option value="blue" style="background-color: blue; color: white;">è—è‰²</option>
                            <option value="green" style="background-color: green; color: white;">ç¶ è‰²</option>
                            <option value="yellow" style="background-color: yellow; color: black;">é»ƒè‰²</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-gray-700 font-medium" for="size-select">ç²—ç´°:</label>
                        <select id="size-select" class="drawing-tool-select">
                            <option value="2">ç´°</option>
                            <option value="5">ä¸­</option>
                            <option value="10">ç²—</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="eraser-btn" class="p-2 rounded-lg border-2 border-transparent hover:bg-gray-200 transition-all duration-150 ease-in-out h-11" title="æ©¡çš®æ“¦"><i class="fas fa-eraser mr-1"></i> æ©¡çš®æ“¦ ğŸ§¼</button>
                        <button id="clear-canvas-btn" class="p-2 rounded-lg border-2 border-transparent hover:bg-gray-200 transition-all duration-150 ease-in-out h-11" title="æ¸…é™¤ç•«å¸ƒ"><i class="fas fa-trash mr-1"></i> æ¸…é™¤ ğŸ§¹</button>
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="student-image-upload-input" class="btn btn-purple !w-auto text-base h-11 px-4 py-2 flex items-center justify-center cursor-pointer">
                            <i class="fas fa-upload mr-2"></i> ä¸Šå‚³åœ–ç‰‡ ğŸ–¼ï¸
                        </label>
                        <input type="file" id="student-image-upload-input" accept="image/*" class="hidden">
                        <button id="clear-student-image-btn" class="btn btn-red !w-auto text-base h-11 px-4 py-2 flex items-center justify-center">
                            <i class="fas fa-trash mr-2"></i> æ¸…é™¤åœ–ç‰‡ ğŸ—‘ï¸
                        </button>
                    </div>
                    <div class="flex items-center gap-2 mt-2 md:mt-0 ml-auto">
                        <button id="submit-drawing-btn" class="btn btn-primary !w-auto text-base h-11 px-4 py-2 flex items-center justify-center">é€å‡º ğŸš€</button> </div>
                </div>
                <canvas id="drawing-canvas"></canvas>
            </div>
            <div id="interaction-url-dispatch" class="hidden">
                </div>
            <div id="interaction-recording" class="hidden text-center flex flex-col items-center justify-center h-full min-h-screen p-4">
                <h3 class="text-2xl font-bold text-center mb-6">éŒ„éŸ³é¡Œ</h3>
                <div class="flex items-center justify-center space-x-3 text-xl text-gray-600 mb-6">
                    <i id="recording-status-icon" class="fas fa-microphone-alt text-gray-400"></i>
                    <p id="recording-status-text">æº–å‚™éŒ„éŸ³...</p>
                </div>
                <div class="flex flex-wrap justify-center gap-4 mb-6">
                    <button id="start-recording-btn" class="btn btn-green !w-40 !h-16 flex items-center justify-center text-lg">
                        <i class="fas fa-play mr-2"></i> é–‹å§‹éŒ„éŸ³ â–¶ï¸
                    </button>
                    <button id="stop-recording-btn" class="btn btn-red !w-40 !h-16 flex items-center justify-center text-lg" disabled>
                        <i class="fas fa-stop mr-2"></i> åœæ­¢éŒ„éŸ³ â¹ï¸
                    </button>
                    <button id="play-recording-btn" class="btn btn-primary !w-40 !h-16 flex items-center justify-center text-lg" disabled>
                        <i class="fas fa-volume-up mr-2"></i> è©¦è½ ğŸ”Š
                    </button>
                    <button id="reset-recording-btn" class="btn btn-orange !w-40 !h-10 flex items-center justify-center text-lg" disabled>
                        <i class="fas fa-redo mr-2"></i> é‡éŒ„ ğŸ”„
                    </button>
                </div>
                <audio id="audio-preview" controls class="w-full max-w-md mb-6 hidden"></audio>
                <button id="submit-recording-btn" class="btn btn-primary mt-4 max-w-sm mx-auto" disabled>
                    <i class="fas fa-paper-plane mr-2"></i> é€å‡ºéŒ„éŸ³ âœ‰ï¸
                </button>
            </div>
            <div id="interaction-reading-comprehension" class="hidden text-center p-4">
                <h3 class="text-2xl font-bold text-center mb-4">é–±è®€æ¸¬é©—</h3>

                <!-- é–±è®€æ–‡æœ¬é¡¯ç¤º -->
                <div class="max-w-4xl mx-auto mb-6">
                    <div id="reading-text-display" class="bg-gray-50 p-6 rounded-lg border text-left text-base leading-relaxed whitespace-pre-wrap"></div>
                </div>

                <!-- é¡Œç›®é¡¯ç¤º -->
                <div id="reading-questions-container" class="max-w-4xl mx-auto space-y-6">
                    <!-- é¡Œç›®å°‡å‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
                </div>

                <button id="submit-reading-btn" class="btn btn-primary mt-6 max-w-sm mx-auto">é€å‡ºç­”æ¡ˆ âœ‰ï¸</button>
            </div>
            <div id="interaction-quick-answer" class="hidden text-center flex flex-col items-center justify-center h-full min-h-screen p-4 relative">
                <h3 class="text-2xl font-bold text-center mb-6">æ¶ç­”é¡Œ</h3>
                <p id="quick-answer-status-text" class="text-lg text-gray-600 mb-6">ç­‰å¾…æ¶ç­”é–‹å§‹...</p>
                <div id="quick-answer-button-container" class="absolute inset-0 pointer-events-none">
                    <!-- æ¶ç­”æŒ‰éˆ•å°‡æœƒå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
                </div>
                <div id="quick-answer-result" class="hidden">
                    <h2 class="text-4xl font-bold text-green-600 mb-4">ğŸ‰ æ¶ç­”æˆåŠŸï¼</h2>
                    <p class="text-xl text-gray-700">ä½ æ˜¯ç¬¬ä¸€å€‹é»åˆ°æŒ‰éˆ•çš„å­¸ç”Ÿï¼</p>
                </div>
                <div id="quick-answer-locked" class="hidden">
                    <h2 class="text-4xl font-bold text-red-600 mb-4">â° æ¶ç­”çµæŸ</h2>
                    <p class="text-xl text-gray-700">å…¶ä»–åŒå­¸å·²ç¶“æ¶ç­”æˆåŠŸäº†ï¼</p>
                </div>
            </div>
            <div id="interaction-sequencing" class="hidden text-center">
                <h3 class="text-2xl font-bold text-center mb-2">æ’åºé¡Œ</h3>
                <p id="sequencing-question-text" class="text-lg text-gray-700 mb-6"></p>
                <div class="sequencing-container">
                    <div id="sequencing-items-container" class="mb-6">
                        <!-- æ’åºé …ç›®å°‡å‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
                    </div>
                    <button id="submit-sequencing-btn" class="btn btn-primary max-w-sm mx-auto">é€å‡ºç­”æ¡ˆ âœ‰ï¸</button>
                </div>
            </div>
            <div id="interaction-matching" class="hidden text-center">
                <h3 class="text-2xl font-bold text-center mb-2">é…å°é¡Œ</h3>
                <p id="matching-question-text" class="text-lg text-gray-700 mb-6"></p>
                <div class="matching-container">
                    <svg id="matching-svg-canvas"></svg>
                    <div class="matching-column" id="matching-column-a" style="z-index: 2;">
                        <!-- Aé …ç›®åˆ—è¡¨ -->
                    </div>
                    <div class="matching-column" id="matching-column-b" style="z-index: 2;">
                        <!-- Bé …ç›®åˆ—è¡¨ -->
                    </div>
                </div>
                <button id="submit-matching-btn" class="btn btn-primary max-w-sm mx-auto mt-6">é€å‡ºç­”æ¡ˆ âœ‰ï¸</button>
            </div>

            <div id="interaction-quick-poll" class="hidden text-center flex flex-col items-center justify-center h-full min-h-screen p-4">
                <h3 class="text-2xl font-bold text-center mb-4">å¿«é€ŸæŠ•ç¥¨</h3>
                <p id="quick-poll-question-display" class="text-xl text-gray-800 mb-8 font-medium px-4"></p>

                <!-- æŠ•ç¥¨é¸é …å®¹å™¨ -->
                <div id="quick-poll-options-container" class="w-full max-w-2xl">
                    <!-- é¸é …æŒ‰éˆ•å°‡æœƒå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
                </div>

                <!-- å·²æŠ•ç¥¨ç‹€æ…‹ -->
                <div id="quick-poll-voted-status" class="hidden mt-8">
                    <div class="bg-green-100 border-2 border-green-500 rounded-lg p-6">
                        <i class="fas fa-check-circle text-green-600 text-5xl mb-3"></i>
                        <h4 class="text-2xl font-bold text-green-700 mb-2">æŠ•ç¥¨æˆåŠŸï¼</h4>
                        <p class="text-gray-700">æ„Ÿè¬æ‚¨çš„åƒèˆ‡</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="student-peer-review-view" class="hidden">
            <div class="flex flex-col h-full min-h-screen">
                <div class="flex-shrink-0 mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 text-center mb-4">ä½œå“è§€æ‘©èˆ‡æŠ•ç¥¨</h2>
                    <p class="text-lg text-gray-600 text-center mb-6">é»æ“Šæ„›å¿ƒæŠ•ç¥¨ï¼Œå†é»æ“Šå¯å–æ¶ˆï¼æœ€å¤šå¯æŠ• <span class="font-bold text-red-600">3</span> å€‹ä¸åŒä½œå“</p>
                    <div class="text-center mb-4">
                        <span class="inline-block bg-blue-100 text-blue-800 px-4 py-2 rounded-full text-sm font-medium">
                            å·²æŠ•ç¥¨ï¼š<span id="current-vote-count">0</span> / 3
                        </span>
                    </div>
                </div>
                
                <div id="peer-review-works-container" class="flex-1 bg-gray-100 p-4 rounded-lg overflow-y-auto">
                    <div id="peer-review-works-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <p class="text-gray-500 text-center col-span-full">è¼‰å…¥ä½œå“ä¸­...</p>
                    </div>
                </div>
                
                <div class="flex-shrink-0 mt-4 text-center">
                    <button id="exit-peer-review-btn" class="btn btn-gray !w-auto text-base h-11 px-6 py-2">
                        <i class="fas fa-arrow-left mr-2"></i> è¿”å›ç­‰å¾…
                    </button>
                </div>
            </div>
        </div>

    </div>

    <div id="message-box" class="fixed top-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg hidden z-50 transition-all duration-300 transform" role="alert">
        <p id="message-content"></p>
        <button id="close-message-btn" class="absolute top-1 right-2 text-white text-xl leading-none">Ã—</button>
    </div>

    <div id="magnified-image-modal" class="magnified-image-modal hidden">
        <div class="magnified-image-modal-content">
            <button id="magnified-image-modal-close-btn" class="magnified-image-modal-close">Ã—</button>
            <img id="magnified-image" src="" alt="æ”¾å¤§ç¹ªåœ–">
        </div>
    </div>

    <div id="student-list-modal" class="magnified-image-modal hidden">
        <div id="student-list-modal-content" class="magnified-image-modal-content">
            <button id="student-list-modal-close-btn" class="magnified-image-modal-close">Ã—</button>
            <h4 class="text-2xl font-bold mb-4 text-gray-800">ç›®å‰åœ¨ç·šå­¸ç”Ÿ</h4>
            <button id="modal-draw-lottery-btn" class="btn btn-orange !w-auto text-sm mb-4">æŠ½ç±¤ ğŸ²</button> <div id="modal-student-names">
                <p class="text-gray-500 text-sm">æ²’æœ‰å­¸ç”Ÿåœ¨ç·š</p>
            </div>
        </div>
    </div>

    <div id="statistics-modal" class="magnified-image-modal hidden">
        <div id="statistics-modal-content" class="magnified-image-modal-content">
            <button id="chart-modal-close-btn" class="magnified-image-modal-close">Ã—</button>
            <h4 id="chart-title" class="text-2xl font-bold mb-4 text-gray-800">ä½œç­”çµ±è¨ˆ</h4>
            <svg id="chart-svg" width="550" height="400"></svg>
            <div id="students-by-answer-list-container" class="hidden">
                <h5 id="students-by-answer-list-title"></h5>
                <p id="students-by-answer-names" class="text-gray-700"></p> 
            </div>
        </div>
    </div>

    <div id="ai-summary-modal" class="magnified-image-modal hidden">
        <div id="ai-summary-modal-content">
            <button id="ai-summary-modal-close-btn" class="magnified-image-modal-close">Ã—</button>
            <h4>AI æ–‡å­—åˆ†æ - ç†±é–€è©å½™</h4>
            <div id="ai-loading-spinner" class="hidden">
                <p>æ–‡å­—åˆ†æä¸­....</p>
            </div>
            <ul id="ai-summary-result-list">
                </ul>
        </div>
    </div>

    <div id="ai-settings-modal" class="magnified-image-modal hidden">
        <div id="ai-settings-modal-content" class="magnified-image-modal-content">
            <button id="ai-settings-modal-close-btn" class="magnified-image-modal-close">Ã—</button>
            <h4>AI è¨­å®š</h4>
            <div class="space-y-4">
                <div>
                    <label for="ai-source-select">AI æ¨¡å‹ä¾†æº:</label>
                    <select id="ai-source-select" class="drawing-tool-select">
                        <option value="gemini-default">ä½¿ç”¨ç›®å‰ Gemini (ä¸å¯ä½¿ç”¨)</option>
                        <option value="gemini-custom" selected>è‡ªè¨‚ Gemini API Key</option>
                    </select>
                </div>
                <div id="gemini-api-key-group" class="hidden">
                    <label for="gemini-api-key-input">Gemini API Key:</label>
                    <input type="password" id="gemini-api-key-input" placeholder="è«‹è²¼ä¸Šæ‚¨çš„ Gemini API Key" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div class="settings-button-group">
                <button id="save-ai-settings-btn" class="btn btn-primary">å„²å­˜è¨­å®š ğŸ’¾</button>
            </div>
        </div>
    </div>

    <div id="url-dispatch-settings-modal" class="magnified-image-modal hidden">
        <div id="url-dispatch-settings-modal-content" class="magnified-image-modal-content">
            <button id="url-dispatch-settings-modal-close-btn" class="magnified-image-modal-close">Ã—</button>
            <h4>è¨­å®šæ´¾é€ç¶²å€/HTML</h4>
            <div class="w-full space-y-4">
                <div class="flex items-center justify-center gap-6 mb-4">
                    <label class="inline-flex items-center">
                        <input type="radio" name="dispatchType" value="url" class="form-radio text-blue-600 h-5 w-5" checked>
                        <span class="ml-2 text-gray-700 font-medium">æ´¾é€ç¶²å€</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="dispatchType" value="html" class="form-radio text-blue-600 h-5 w-5">
                        <span class="ml-2 text-gray-700 font-medium">æ´¾é€ HTML</span>
                    </label>
                </div>

                <div id="url-dispatch-section">
                    <div>
                        <label for="dispatch-url-input">ç¶²å€:</label>
                        <input type="text" id="dispatch-url-input" placeholder="è«‹è²¼ä¸Šè¦æ´¾é€çš„ç¶²å€" class="w-full">
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" id="is-youtube-checkbox">
                        <label for="is-youtube-checkbox">æ­¤é€£çµç‚º YouTube å½±ç‰‡</label>
                    </div>
                </div>

                <div id="html-dispatch-section" class="hidden">
                    <div class="flex flex-col items-center">
                        <div class="flex gap-4 mb-4">
                            <label for="dispatch-html-upload-input" class="btn bg-yellow-600 !w-auto text-base h-11 px-4 py-2 flex items-center justify-center cursor-pointer">
                                <i class="fas fa-file-upload mr-2"></i> ä¸Šå‚³ HTML æª”æ¡ˆ â¬†ï¸
                            </label>
                            <input type="file" id="dispatch-html-upload-input" accept=".html" class="hidden">
                            <button id="clear-dispatch-html-btn" class="btn btn-red !w-auto text-base h-11 px-4 py-2 flex items-center justify-center">
                                <i class="fas fa-trash mr-2"></i> æ¸…é™¤ HTML ğŸ—‘ï¸
                            </button>
                        </div>
                        <p id="dispatch-html-status" class="text-gray-600 text-sm mt-2">ç›®å‰æ²’æœ‰ HTML æª”æ¡ˆã€‚</p>
                    </div>
                </div>
            </div>
            <div class="settings-button-group mt-6 w-full">
                <button id="clear-dispatch-settings-btn" class="btn btn-red">æ¸…é™¤è¨­å®š ğŸ§¹</button>
                <button id="save-dispatch-settings-btn" class="btn btn-primary">å„²å­˜è¨­å®š ğŸ’¾</button>
            </div>
        </div>
    </div>

    <div id="unsubmitted-students-modal" class="magnified-image-modal hidden">
        <div id="unsubmitted-students-modal-content" class="magnified-image-modal-content">
            <button id="unsubmitted-students-modal-close-btn" class="magnified-image-modal-close">Ã—</button>
            <h4 class="text-2xl font-bold mb-4 text-gray-800">æœªä½œç­”å­¸ç”Ÿåå–®</h4>
            <div id="modal-unsubmitted-student-names">
                <p class="text-gray-500 text-sm">æ‰€æœ‰å­¸ç”Ÿçš†å·²ä½œç­”æˆ–ç„¡å­¸ç”Ÿåœ¨ç·š</p>
            </div>
        </div>
    </div>

    <!-- æŸ¥çœ‹é¡Œç›®æ¨¡æ…‹æ¡† -->
    <div id="view-questions-modal" class="magnified-image-modal hidden">
        <div id="view-questions-modal-content" class="magnified-image-modal-content">
            <button id="view-questions-modal-close-btn" class="magnified-image-modal-close">Ã—</button>
            <h4 class="text-2xl font-bold mb-4 text-gray-800">æŸ¥çœ‹é¡Œç›®èˆ‡æ­£ç¢ºç­”æ¡ˆ</h4>
            <div id="questions-display-container" class="w-full space-y-4 max-h-96 overflow-y-auto">
                <!-- é¡Œç›®å…§å®¹å°‡å‹•æ…‹å¡«å…¥ -->
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="save-correct-answers-btn" class="btn btn-green !w-auto px-6">å„²å­˜ä¿®æ”¹</button>
                <button id="cancel-questions-view-btn" class="btn bg-gray-500 hover:bg-gray-600 !w-auto px-6">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æŸ¥çœ‹é–±è®€æ¸¬é©—é¡Œç›®æ¨¡æ…‹æ¡† -->
    <div id="view-reading-questions-modal" class="magnified-image-modal hidden">
        <div id="view-reading-questions-modal-content" class="magnified-image-modal-content" style="max-width: 900px;">
            <button id="view-reading-questions-modal-close-btn" class="magnified-image-modal-close">Ã—</button>
            <h4 class="text-2xl font-bold mb-4 text-gray-800">ğŸ“– é–±è®€æ¸¬é©—é¡Œç›®</h4>

            <!-- é–±è®€æ–‡æœ¬é¡¯ç¤º -->
            <div class="mb-6">
                <h5 class="text-lg font-bold text-gray-700 mb-2">é–±è®€æ–‡æœ¬ï¼š</h5>
                <div id="view-reading-text-display" class="bg-gray-50 p-4 rounded-lg border text-base leading-relaxed whitespace-pre-wrap max-h-64 overflow-y-auto"></div>
            </div>

            <!-- é¡Œç›®é¡¯ç¤º -->
            <div>
                <h5 class="text-lg font-bold text-gray-700 mb-2">é¡Œç›®ï¼š</h5>
                <div id="view-reading-questions-display" class="space-y-4 max-h-96 overflow-y-auto">
                    <!-- é¡Œç›®å…§å®¹å°‡å‹•æ…‹å¡«å…¥ -->
                </div>
            </div>

            <div class="flex justify-end gap-4 mt-6">
                <button id="close-reading-questions-view-btn" class="btn btn-primary !w-auto px-6">é—œé–‰</button>
            </div>
        </div>
    </div>

    <div id="multiple-choice-settings-modal" class="magnified-image-modal hidden">
        <div id="multiple-choice-settings-modal-content" class="magnified-image-modal-content">
            <button id="multiple-choice-settings-modal-close-btn" class="magnified-image-modal-close">Ã—</button>
            <h4 class="text-2xl font-bold mb-4 text-gray-800">é¸æ“‡é¡Œè¨­å®š</h4>
            <div class="w-full space-y-4">
                <div class="flex items-center justify-center gap-6 mb-4">
                    <label class="inline-flex items-center">
                        <input type="radio" name="mcQuestionType" value="none" class="form-radio text-blue-600 h-5 w-5" checked>
                        <span class="ml-2 text-gray-700 font-medium">ç„¡é¡Œç›®å‡ºé¡Œ (é è¨­ 1-4 é¸é …)</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="mcQuestionType" value="custom" class="form-radio text-blue-600 h-5 w-5">
                        <span class="ml-2 text-gray-700 font-medium">è‡ªè¨‚é¡Œç›®å‡ºé¡Œ</span>
                    </label>
                </div>

                <div id="custom-mc-questions-section" class="hidden w-full">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                        <div class="flex flex-col space-y-2">
                            <label for="custom-mc-questions-textarea" class="block text-gray-700 text-sm font-bold">
                                è«‹è¼¸å…¥é¡Œç›® (æˆ–ç”± AI ç”Ÿæˆ)
                            </label>
                            <p class="text-gray-600 text-xs">æ ¼å¼: é¡Œç›®,æ­£ç¢ºç­”æ¡ˆ(1-4æˆ–A-D),é¸é …1,é¸é …2,é¸é …3,é¸é …4 (æ¯è¡Œä¸€é¡Œ)</p>
                            <textarea id="custom-mc-questions-textarea" rows="6" class="w-full p-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-blue-500 flex-grow" placeholder="ä¾‹å¦‚ï¼š
å°ç£çš„é¦–éƒ½åœ¨å“ªè£¡?,1,å°åŒ—,å°ä¸­,å°å—,é«˜é›„
2+2=?,B,3,4,5,6"></textarea>
                            <p id="custom-mc-questions-status" class="text-red-500 text-sm mt-2 hidden">æ ¼å¼éŒ¯èª¤æˆ–é¡Œç›®ç‚ºç©ºï¼Œè«‹æª¢æŸ¥è¼¸å…¥ã€‚</p>
                        </div>

                        <div class="flex flex-col space-y-4 bg-gray-50 p-4 rounded-lg border">
                            <h5 class="text-lg font-bold text-gray-800 text-center">ğŸ¤– AI æ™ºèƒ½å‡ºé¡Œ</h5>
                            <div>
                                <label for="ai-mc-topic-textarea" class="block text-gray-700 text-sm font-bold mb-2">å‡ºé¡Œä¸»é¡Œã€ç¯„åœæˆ–è¦æ±‚:</label>
                                <textarea id="ai-mc-topic-textarea" rows="3" class="w-full p-2 border rounded-md text-base focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="ä¾‹å¦‚ï¼š
- é—œæ–¼å°ç£æ­·å²çš„é¸æ“‡é¡Œ
- é—œæ–¼å…‰åˆä½œç”¨çš„åœ‹ä¸­ç¨‹åº¦æ˜¯éé¡Œ
- è«‹å‡ºæœ‰é—œè–èª•ç¯€çš„è‹±æ–‡å–®å­—é¸æ“‡é¡Œ"></textarea>
                            </div>
                            <div>
                                <label for="ai-mc-count-input" class="block text-gray-700 text-sm font-bold mb-2">å‡ºé¡Œæ•¸é‡ (1-10):</label>
                                <input type="number" id="ai-mc-count-input" min="1" max="10" value="5" class="w-full p-2 border rounded-md text-base focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                            <div class="text-center">
                                <button id="ai-generate-mc-btn" class="btn btn-purple !w-auto text-base h-11 px-4 py-2 flex items-center justify-center mx-auto">
                                    <i id="ai-mc-btn-icon" class="fas fa-magic mr-2"></i>
                                    <span id="ai-mc-btn-text">AI é–‹å§‹å‡ºé¡Œ</span>
                                </button>
                            </div>
                            <div id="ai-mc-loading-spinner" class="hidden flex items-center justify-center text-purple-600 pt-2">
                                <i class="fas fa-spinner fa-spin mr-2"></i>
                                <span>AI æ€è€ƒä¸­ï¼Œè«‹ç¨å€™...</span>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- é¡Œåº«ç®¡ç†å€å¡Š -->
                <div id="question-bank-management-section" class="hidden w-full mt-6 bg-blue-50 p-4 rounded-lg border">
                    <h5 class="text-lg font-bold text-gray-800 text-center mb-4">ğŸ“š é¡Œåº«ç®¡ç†</h5>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- é¡Œåº«è¼‰å…¥å€ -->
                        <div class="flex flex-col space-y-2">
                            <label class="block text-gray-700 text-sm font-bold">å¾æª”æ¡ˆè¼‰å…¥é¡Œåº«</label>
                            <input type="file" id="question-bank-file-input" accept=".txt" class="w-full p-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button id="load-question-bank-btn" class="btn bg-blue-600 hover:bg-blue-700 text-white text-sm h-8 px-3 py-1">è¼‰å…¥é¡Œåº«</button>
                        </div>

                        <!-- é¡Œåº«å„²å­˜å€ -->
                        <div class="flex flex-col space-y-2">
                            <label class="block text-gray-700 text-sm font-bold">å„²å­˜ç›®å‰é¡Œç›®ç‚ºé¡Œåº«</label>
                            <input type="text" id="question-bank-name-input" placeholder="è¼¸å…¥é¡Œåº«åç¨±" class="w-full p-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button id="save-question-bank-btn" class="btn bg-green-600 hover:bg-green-700 text-white text-sm h-8 px-3 py-1">å„²å­˜é¡Œåº«</button>
                        </div>
                    </div>

                    <!-- é¡Œåº«åˆ—è¡¨ -->
                    <div class="mt-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">å·²å„²å­˜çš„é¡Œåº«</label>
                        <div id="question-bank-list" class="space-y-2 max-h-32 overflow-y-auto border rounded-md p-2 bg-white">
                            <div class="text-gray-500 text-sm italic text-center">ç›®å‰æ²’æœ‰å„²å­˜çš„é¡Œåº«</div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="settings-button-group mt-6 w-full">
                <button id="start-mc-interaction-btn" class="btn btn-primary">ç¢ºèªä¸¦é–‹å§‹äº’å‹• ğŸš€</button>
                <button id="cancel-mc-settings-btn" class="btn btn-gray">å–æ¶ˆ â†©ï¸</button>
            </div>
        </div>
    </div>

    <!-- B. é¸æ“‡/æ’åº/é…å°é¡Œé¸å–®æ¨¡æ…‹æ¡† -->
    <div id="choice-sequencing-matching-menu-modal" class="magnified-image-modal hidden">
        <div class="magnified-image-modal-content" style="max-width: 400px;">
            <button id="choice-sequencing-matching-menu-close-btn" class="magnified-image-modal-close">Ã—</button>
            <h4 class="text-2xl font-bold mb-6 text-gray-800 text-center">B. è«‹é¸æ“‡é¡Œå‹</h4>
            <div class="space-y-4">
                <button id="open-multiple-choice-settings-btn" class="btn btn-green w-full text-xl py-4">âœ“ é¸æ“‡é¡Œ</button>
                <button id="open-sequencing-settings-btn" class="btn bg-cyan-500 hover:bg-cyan-600 w-full text-xl py-4">ğŸ“‹ æ’åºé¡Œ</button>
                <button id="open-matching-settings-btn" class="btn bg-pink-500 hover:bg-pink-600 w-full text-xl py-4">ğŸ”— é…å°é¡Œ</button>
            </div>
        </div>
    </div>

    <!-- æ’åº/é…å°é¡Œé¸å–®æ¨¡æ…‹æ¡† -->
    <div id="sequencing-matching-menu-modal" class="magnified-image-modal hidden">
        <div class="magnified-image-modal-content" style="max-width: 400px;">
            <button id="sequencing-matching-menu-close-btn" class="magnified-image-modal-close">Ã—</button>
            <h4 class="text-2xl font-bold mb-6 text-gray-800 text-center">è«‹é¸æ“‡é¡Œå‹</h4>
            <div class="space-y-4">
                <button id="sequencing-settings-btn" class="btn bg-cyan-500 hover:bg-cyan-600 w-full text-xl py-4">ğŸ“‹ æ’åºé¡Œ</button>
                <button id="matching-settings-btn" class="btn bg-pink-500 hover:bg-pink-600 w-full text-xl py-4">ğŸ”— é…å°é¡Œ</button>
            </div>
        </div>
    </div>

    <!-- æ’åºé¡Œè¨­å®šæ¨¡æ…‹æ¡† -->
    <div id="sequencing-settings-modal" class="magnified-image-modal hidden">
        <div id="sequencing-settings-modal-content" class="magnified-image-modal-content">
            <button id="sequencing-settings-modal-close-btn" class="magnified-image-modal-close">Ã—</button>
            <div class="w-full">
                <!-- é¡Œå‹åˆ‡æ›æŒ‰éˆ• -->
                <div class="flex justify-center mb-4 gap-2">
                    <button id="switch-to-matching-btn" class="btn bg-pink-500 hover:bg-pink-600 text-white px-6 py-2 text-sm">
                        ğŸ”— åˆ‡æ›åˆ°é…å°é¡Œ
                    </button>
                </div>
                <h4 class="text-2xl font-bold mb-4 text-gray-800">æ’åºé¡Œè¨­å®š</h4>

                <!-- ä¸Šæ–¹ï¼šå·¦å³å…©æ¬„å¸ƒå±€ -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                <!-- å·¦æ¬„ï¼šé¡Œç›®è¼¸å…¥ -->
                <div class="bg-gray-50 p-4 rounded-lg border">
                    <label for="sequencing-items-textarea" class="block text-gray-700 text-sm font-bold mb-2">ğŸ“ æ’åºé …ç›®ï¼ˆæ¯è¡Œä¸€å€‹ï¼ŒæŒ‰æ­£ç¢ºé †åºè¼¸å…¥ï¼‰</label>
                    <textarea id="sequencing-items-textarea" rows="6" class="w-full p-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-cyan-500" placeholder="ä¾‹å¦‚ï¼š
æ‰“é–‹æª”æ¡ˆ
ç·¨è¼¯å…§å®¹
å„²å­˜æª”æ¡ˆ
é—œé–‰æª”æ¡ˆ"></textarea>
                    <p class="text-gray-600 text-xs mt-1">ğŸ’¡ æç¤ºï¼šè«‹ä¾ç…§æ­£ç¢ºé †åºè¼¸å…¥é …ç›®ï¼Œç³»çµ±æœƒè‡ªå‹•æ‰“äº‚çµ¦å­¸ç”Ÿä½œç­”</p>
                </div>

                <!-- å³æ¬„ï¼šAIæ™ºèƒ½å‡ºé¡Œ -->
                <div class="bg-purple-50 p-4 rounded-lg border">
                    <h5 class="text-lg font-bold text-gray-800 mb-3">ğŸ¤– AI æ™ºèƒ½å‡ºé¡Œ</h5>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">å‡ºé¡Œä¸»é¡Œæˆ–è¦æ±‚ï¼š</label>
                            <textarea id="ai-seq-topic-textarea" rows="2" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="ä¾‹å¦‚ï¼šè«‹ç”Ÿæˆå…‰åˆä½œç”¨çš„æ­¥é©Ÿæ’åº"></textarea>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">é …ç›®æ•¸é‡ (3-10):</label>
                            <input type="number" id="ai-seq-count-input" min="3" max="10" value="5" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div class="text-center">
                            <button id="ai-generate-seq-btn" class="btn btn-purple w-full text-base h-11 px-4 py-2 flex items-center justify-center">
                                <i id="ai-seq-btn-icon" class="fas fa-magic mr-2"></i>
                                <span id="ai-seq-btn-text">AI é–‹å§‹å‡ºé¡Œ</span>
                            </button>
                        </div>
                        <div id="ai-seq-loading-spinner" class="hidden flex items-center justify-center text-purple-600 pt-2">
                            <i class="fas fa-spinner fa-spin mr-2"></i>
                            <span>AI æ€è€ƒä¸­ï¼Œè«‹ç¨å€™...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¸‹æ–¹ï¼šé¡Œåº«ç®¡ç†å€å¡Šï¼ˆå…¨å¯¬ï¼‰ -->
            <div class="w-full bg-blue-50 p-4 rounded-lg border">
                <h5 class="text-lg font-bold text-gray-800 mb-3">ğŸ“š é¡Œåº«ç®¡ç†</h5>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex flex-col space-y-2">
                        <label class="block text-gray-700 text-sm font-bold">å¾æª”æ¡ˆè¼‰å…¥é¡Œåº«</label>
                        <input type="file" id="seq-bank-file-input" accept=".txt" class="w-full p-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="load-seq-bank-btn" class="btn bg-blue-600 hover:bg-blue-700 text-white text-sm h-8 px-3 py-1">è¼‰å…¥é¡Œåº«</button>
                    </div>
                    <div class="flex flex-col space-y-2">
                        <label class="block text-gray-700 text-sm font-bold">å„²å­˜ç›®å‰é¡Œç›®ç‚ºé¡Œåº«</label>
                        <input type="text" id="seq-bank-name-input" placeholder="è¼¸å…¥é¡Œåº«åç¨±" class="w-full p-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="save-seq-bank-btn" class="btn bg-green-600 hover:bg-green-700 text-white text-sm h-8 px-3 py-1">å„²å­˜é¡Œåº«</button>
                    </div>
                </div>
                <div class="mt-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">å·²å„²å­˜çš„é¡Œåº«</label>
                    <div id="seq-bank-list" class="space-y-2 max-h-20 overflow-y-auto border rounded-md p-2 bg-white">
                        <div class="text-gray-500 text-sm italic text-center">ç›®å‰æ²’æœ‰å„²å­˜çš„é¡Œåº«</div>
                    </div>
                </div>
            </div>

                <div class="settings-button-group mt-4">
                    <button id="start-sequencing-interaction-btn" class="btn bg-cyan-500 hover:bg-cyan-600">ç¢ºèªä¸¦é–‹å§‹äº’å‹• ğŸš€</button>
                    <button id="cancel-sequencing-settings-btn" class="btn btn-gray">å–æ¶ˆ â†©ï¸</button>
                </div>
            </div>
        </div>
    </div>

    <!-- é…å°é¡Œè¨­å®šæ¨¡æ…‹æ¡† -->
    <div id="matching-settings-modal" class="magnified-image-modal hidden">
        <div id="matching-settings-modal-content" class="magnified-image-modal-content">
            <button id="matching-settings-modal-close-btn" class="magnified-image-modal-close">Ã—</button>
            <div class="w-full">
                <!-- é¡Œå‹åˆ‡æ›æŒ‰éˆ• -->
                <div class="flex justify-center mb-4 gap-2">
                    <button id="switch-to-sequencing-btn" class="btn bg-cyan-500 hover:bg-cyan-600 text-white px-6 py-2 text-sm">
                        ğŸ“‹ åˆ‡æ›åˆ°æ’åºé¡Œ
                    </button>
                </div>
                <h4 class="text-2xl font-bold mb-4 text-gray-800">é…å°é¡Œè¨­å®š</h4>

                <!-- ä¸Šæ–¹ï¼šå·¦å³å…©æ¬„å¸ƒå±€ -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                <!-- å·¦æ¬„ï¼šé¡Œç›®è¼¸å…¥ -->
                <div class="bg-gray-50 p-4 rounded-lg border">
                    <label for="matching-pairs-textarea" class="block text-gray-700 text-sm font-bold mb-2">ğŸ“ é…å°é …ç›®ï¼ˆæ¯è¡Œä¸€å°ï¼Œç”¨é€—è™Ÿæˆ–Tabåˆ†éš”ï¼‰</label>
                    <textarea id="matching-pairs-textarea" rows="6" class="w-full p-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="ä¾‹å¦‚ï¼š
å°åŒ—,å°ç£é¦–éƒ½
æ±äº¬,æ—¥æœ¬é¦–éƒ½
é¦–çˆ¾,éŸ“åœ‹é¦–éƒ½
åŒ—äº¬,ä¸­åœ‹é¦–éƒ½"></textarea>
                    <p class="text-gray-600 text-xs mt-1">ğŸ’¡ æç¤ºï¼šæ¯è¡Œä¸€å°é…å°é …ç›®ï¼Œç”¨é€—è™Ÿï¼ˆ,ï¼‰æˆ–Tabéµåˆ†éš”å·¦å³å…©å´</p>
                </div>

                <!-- å³æ¬„ï¼šAIæ™ºèƒ½å‡ºé¡Œ -->
                <div class="bg-purple-50 p-4 rounded-lg border">
                    <h5 class="text-lg font-bold text-gray-800 mb-3">ğŸ¤– AI æ™ºèƒ½å‡ºé¡Œ</h5>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">å‡ºé¡Œä¸»é¡Œæˆ–è¦æ±‚ï¼š</label>
                            <textarea id="ai-match-topic-textarea" rows="2" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="ä¾‹å¦‚ï¼šåœ‹å®¶èˆ‡é¦–éƒ½çš„é…å°"></textarea>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">é…å°æ•¸é‡ (3-10):</label>
                            <input type="number" id="ai-match-count-input" min="3" max="10" value="5" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div class="text-center">
                            <button id="ai-generate-match-btn" class="btn btn-purple w-full text-base h-11 px-4 py-2 flex items-center justify-center">
                                <i id="ai-match-btn-icon" class="fas fa-magic mr-2"></i>
                                <span id="ai-match-btn-text">AI é–‹å§‹å‡ºé¡Œ</span>
                            </button>
                        </div>
                        <div id="ai-match-loading-spinner" class="hidden flex items-center justify-center text-purple-600 pt-2">
                            <i class="fas fa-spinner fa-spin mr-2"></i>
                            <span>AI æ€è€ƒä¸­ï¼Œè«‹ç¨å€™...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¸‹æ–¹ï¼šé¡Œåº«ç®¡ç†å€å¡Šï¼ˆå…¨å¯¬ï¼‰ -->
            <div class="w-full bg-blue-50 p-4 rounded-lg border">
                <h5 class="text-lg font-bold text-gray-800 mb-3">ğŸ“š é¡Œåº«ç®¡ç†</h5>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex flex-col space-y-2">
                        <label class="block text-gray-700 text-sm font-bold">å¾æª”æ¡ˆè¼‰å…¥é¡Œåº«</label>
                        <input type="file" id="match-bank-file-input" accept=".txt" class="w-full p-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="load-match-bank-btn" class="btn bg-blue-600 hover:bg-blue-700 text-white text-sm h-8 px-3 py-1">è¼‰å…¥é¡Œåº«</button>
                    </div>
                    <div class="flex flex-col space-y-2">
                        <label class="block text-gray-700 text-sm font-bold">å„²å­˜ç›®å‰é¡Œç›®ç‚ºé¡Œåº«</label>
                        <input type="text" id="match-bank-name-input" placeholder="è¼¸å…¥é¡Œåº«åç¨±" class="w-full p-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="save-match-bank-btn" class="btn bg-green-600 hover:bg-green-700 text-white text-sm h-8 px-3 py-1">å„²å­˜é¡Œåº«</button>
                    </div>
                </div>
                <div class="mt-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">å·²å„²å­˜çš„é¡Œåº«</label>
                    <div id="match-bank-list" class="space-y-2 max-h-20 overflow-y-auto border rounded-md p-2 bg-white">
                        <div class="text-gray-500 text-sm italic text-center">ç›®å‰æ²’æœ‰å„²å­˜çš„é¡Œåº«</div>
                    </div>
                </div>
            </div>

                <div class="settings-button-group mt-4">
                    <button id="start-matching-interaction-btn" class="btn bg-pink-500 hover:bg-pink-600">ç¢ºèªä¸¦é–‹å§‹äº’å‹• ğŸš€</button>
                    <button id="cancel-matching-settings-btn" class="btn btn-gray">å–æ¶ˆ â†©ï¸</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ•™å¸«å¯†ç¢¼é©—è­‰æ¨¡æ…‹æ¡† -->
    <div id="teacher-password-modal" class="magnified-image-modal hidden">
        <div id="teacher-password-modal-content" class="magnified-image-modal-content">
            <button id="teacher-password-modal-close-btn" class="magnified-image-modal-close">Ã—</button>
            <h4 class="text-2xl font-bold mb-4 text-gray-800">æ•™å¸«ç™»å…¥é©—è­‰</h4>
            <div class="w-full space-y-4">
                <input type="password" id="teacher-password-input" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div class="flex justify-center gap-4">
                    <button id="teacher-password-submit-btn" class="btn btn-primary px-8">ç¢ºèª</button>
                    <button id="teacher-password-cancel-btn" class="btn btn-gray px-8">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- é–±è®€æ¸¬é©—è¨­å®šæ¨¡æ…‹æ¡† -->
    <div id="reading-comprehension-settings-modal" class="magnified-image-modal hidden">
        <div id="reading-comprehension-settings-modal-content" class="magnified-image-modal-content" style="max-width: 900px;">
            <button id="reading-comprehension-settings-modal-close-btn" class="magnified-image-modal-close">Ã—</button>
            <h4 class="text-2xl font-bold mb-4 text-gray-800">é–±è®€æ¸¬é©—è¨­å®š</h4>
            <div class="w-full space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                    <!-- å·¦å´ï¼šæ–‡æœ¬èˆ‡é¡Œç›®è¼¸å…¥ -->
                    <div class="flex flex-col space-y-4">
                        <!-- æ–‡æœ¬è¼¸å…¥æ¡† -->
                        <div>
                            <label for="reading-text-textarea" class="block text-gray-700 text-sm font-bold mb-2">
                                é–±è®€æ–‡æœ¬ï¼š
                            </label>
                            <textarea id="reading-text-textarea" rows="8" class="w-full p-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="è«‹è¼¸å…¥é–±è®€æ–‡æœ¬å…§å®¹..."></textarea>
                        </div>

                        <!-- é¡Œç›®è¼¸å…¥æ¡† -->
                        <div>
                            <label for="reading-questions-textarea" class="block text-gray-700 text-sm font-bold mb-2">
                                é¡Œç›®è¨­å®šï¼š
                            </label>
                            <p class="text-gray-600 text-xs mb-2">æ ¼å¼: é¡Œç›®,æ­£ç¢ºç­”æ¡ˆ(1-4æˆ–A-D),é¸é …1,é¸é …2,é¸é …3,é¸é …4<span class="text-gray-500">,[å±¤æ¬¡(1-4)é¸å¡«]</span><br>
                            <span class="text-gray-500">æ”¯æ´é€—è™Ÿ(,)æˆ–Tabåˆ†éš”ï¼Œæ¯è¡Œä¸€é¡Œ</span></p>
                            <textarea id="reading-questions-textarea" rows="8" class="w-full p-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="ä¾‹å¦‚ï¼š
ä¸»è§’çš„åå­—æ˜¯ä»€éº¼?,2,å°æ˜,å°è¯,å°ç¾,å°å¼·,1
æœ¬æ–‡çš„ä¸»æ—¨æ˜¯?,A,å‹èª¼çš„é‡è¦,ç«¶çˆ­çš„æ„ç¾©,å­¸ç¿’çš„åƒ¹å€¼,å®¶åº­çš„æº«æš–
æ•…äº‹ç™¼ç”Ÿçš„åœ°é»åœ¨å“ªè£¡?,3,å­¸æ ¡,å…¬åœ’,åœ–æ›¸é¤¨,å®¶è£¡"></textarea>
                            <p id="reading-questions-status" class="text-red-500 text-sm mt-2 hidden">æ ¼å¼éŒ¯èª¤æˆ–é¡Œç›®ç‚ºç©ºï¼Œè«‹æª¢æŸ¥è¼¸å…¥ã€‚</p>
                        </div>
                    </div>

                    <!-- å³å´ï¼šAIç”Ÿæˆèˆ‡é¡Œåº«ç®¡ç† -->
                    <div class="flex flex-col space-y-4">
                        <!-- AI ç”Ÿæˆå€å¡Š -->
                        <div class="bg-purple-50 p-4 rounded-lg border flex-1">
                            <h5 class="text-lg font-bold text-gray-800 text-center mb-4">ğŸ¤– PIRLS AI å‡ºé¡Œ</h5>
                            <div class="space-y-3">
                                <div>
                                    <label for="ai-reading-topic-textarea" class="block text-gray-700 text-sm font-bold mb-2">å‡ºé¡Œè¦æ±‚ï¼š</label>
                                    <textarea id="ai-reading-topic-textarea" rows="3" class="w-full p-2 border rounded-md text-base focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="ä¾‹å¦‚ï¼š
- æ ¹æ“šå·¦æ–¹æ–‡æœ¬ç”Ÿæˆ PIRLS é–±è®€ç†è§£é¡Œ
- æˆ–ç›´æ¥æè¿°ä¸»é¡Œï¼ŒAI æœƒç”Ÿæˆæ–‡æœ¬+é¡Œç›®"></textarea>
                                </div>
                                <div class="text-sm text-gray-600 bg-white p-2 rounded border">
                                    <p class="font-bold mb-1">PIRLS å››å±¤æ¬¡é…ç½®ï¼š</p>
                                    <ul class="list-disc list-inside text-xs space-y-1">
                                        <li>å±¤æ¬¡1 (ç›´æ¥æå–)ï¼š3é¡Œ</li>
                                        <li>å±¤æ¬¡2 (ç›´æ¥æ¨è«–)ï¼š3é¡Œ</li>
                                        <li>å±¤æ¬¡3 (è©®é‡‹æ•´åˆ)ï¼š2é¡Œ</li>
                                        <li>å±¤æ¬¡4 (æ¯”è¼ƒè©•ä¼°)ï¼š2é¡Œ</li>
                                    </ul>
                                </div>
                                <button id="ai-generate-reading-btn" class="btn btn-purple !w-full text-base h-11 px-4 py-2 flex items-center justify-center">
                                    <i id="ai-reading-btn-icon" class="fas fa-magic mr-2"></i>
                                    <span id="ai-reading-btn-text">AI é–‹å§‹å‡ºé¡Œ</span>
                                </button>
                                <div id="ai-reading-loading-spinner" class="hidden flex items-center justify-center text-purple-600 pt-2">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>
                                    <span>AI æ€è€ƒä¸­ï¼Œè«‹ç¨å€™...</span>
                                </div>
                            </div>
                        </div>

                        <!-- é¡Œåº«ç®¡ç†å€å¡Š -->
                        <div class="bg-blue-50 p-4 rounded-lg border">
                            <h5 class="text-lg font-bold text-gray-800 text-center mb-4">ğŸ“š é¡Œåº«ç®¡ç†</h5>
                            <div class="space-y-3">
                                <!-- è¼‰å…¥é¡Œåº« -->
                                <div>
                                    <label class="block text-gray-700 text-sm font-bold mb-2">å¾æª”æ¡ˆè¼‰å…¥é¡Œåº«</label>
                                    <div class="space-y-2">
                                        <div>
                                            <label class="block text-gray-600 text-xs mb-1">ä¸Šå‚³æ–‡æœ¬ (.txt)</label>
                                            <input type="file" id="reading-text-file-input" accept=".txt" class="w-full p-1 border rounded-md text-xs focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        </div>
                                        <div>
                                            <label class="block text-gray-600 text-xs mb-1">ä¸Šå‚³é¡Œç›® (.txt)</label>
                                            <input type="file" id="reading-questions-file-input" accept=".txt" class="w-full p-1 border rounded-md text-xs focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        </div>
                                        <button id="load-reading-files-btn" class="btn bg-blue-600 hover:bg-blue-700 text-white text-sm h-8 px-3 py-1 w-full">è¼‰å…¥æª”æ¡ˆ</button>
                                    </div>
                                </div>

                                <!-- å„²å­˜é¡Œåº« -->
                                <div>
                                    <label class="block text-gray-700 text-sm font-bold mb-2">å„²å­˜ç›®å‰é¡Œç›®ç‚ºé¡Œåº«</label>
                                    <input type="text" id="reading-question-bank-name-input" placeholder="è¼¸å…¥é¡Œåº«åç¨±" class="w-full p-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2">
                                    <button id="save-reading-question-bank-btn" class="btn bg-green-600 hover:bg-green-700 text-white text-sm h-8 px-3 py-1 w-full">å„²å­˜é¡Œåº«</button>
                                </div>

                                <!-- é¡Œåº«åˆ—è¡¨ -->
                                <div>
                                    <label class="block text-gray-700 text-sm font-bold mb-2">å·²å„²å­˜çš„é¡Œåº«</label>
                                    <div id="reading-question-bank-list" class="space-y-2 max-h-32 overflow-y-auto border rounded-md p-2 bg-white">
                                        <div class="text-gray-500 text-sm italic text-center">ç›®å‰æ²’æœ‰å„²å­˜çš„é¡Œåº«</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            <div class="settings-button-group mt-6 w-full">
                <button id="start-reading-interaction-btn" class="btn btn-primary">ç¢ºèªä¸¦é–‹å§‹äº’å‹• ğŸš€</button>
                <button id="cancel-reading-settings-btn" class="btn btn-gray">å–æ¶ˆ â†©ï¸</button>
            </div>
        </div>
    </div>

    <!-- å¿«é€ŸæŠ•ç¥¨è¨­å®šæ¨¡æ…‹æ¡† -->
    <div id="quick-poll-settings-modal" class="magnified-image-modal hidden">
        <div id="quick-poll-settings-modal-content" class="magnified-image-modal-content" style="max-width: 600px;">
            <button id="quick-poll-settings-modal-close-btn" class="magnified-image-modal-close">Ã—</button>
            <h4 class="text-2xl font-bold mb-4 text-gray-800">å¿«é€ŸæŠ•ç¥¨è¨­å®š</h4>
            <div class="w-full space-y-4">
                <!-- æŠ•ç¥¨é¡å‹é¸æ“‡ -->
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">æŠ•ç¥¨é¡å‹ï¼š</label>
                    <div class="space-y-2">
                        <label class="inline-flex items-center w-full p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="pollType" value="emoji" class="form-radio text-lime-600 h-5 w-5" checked>
                            <span class="ml-3 text-gray-700">å¿ƒæƒ…ç¬¦è™Ÿï¼ˆğŸ˜Š ğŸ˜ ğŸ˜•ï¼‰</span>
                        </label>
                        <label class="inline-flex items-center w-full p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="pollType" value="simple" class="form-radio text-lime-600 h-5 w-5">
                            <span class="ml-3 text-gray-700">ç°¡å–®é¸é …ï¼ˆåŒæ„ / ä¸åŒæ„ / ä¸ç¢ºå®šï¼‰</span>
                        </label>
                        <label class="inline-flex items-center w-full p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="pollType" value="rating5" class="form-radio text-lime-600 h-5 w-5">
                            <span class="ml-3 text-gray-700">æ•¸å­—ç­‰ç´šï¼ˆ1-5 åˆ†ï¼‰</span>
                        </label>
                        <label class="inline-flex items-center w-full p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="pollType" value="rating10" class="form-radio text-lime-600 h-5 w-5">
                            <span class="ml-3 text-gray-700">æ•¸å­—ç­‰ç´šï¼ˆ1-10 åˆ†ï¼‰</span>
                        </label>
                        <label class="inline-flex items-center w-full p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="pollType" value="custom" class="form-radio text-lime-600 h-5 w-5">
                            <span class="ml-3 text-gray-700">è‡ªè¨‚é¸é …</span>
                        </label>
                    </div>
                </div>

                <!-- è‡ªè¨‚é¸é …è¼¸å…¥å€ -->
                <div id="custom-poll-options-section" class="hidden">
                    <label for="custom-poll-options-input" class="block text-gray-700 text-sm font-bold mb-2">è‡ªè¨‚é¸é …ï¼ˆæ¯è¡Œä¸€å€‹ï¼‰ï¼š</label>
                    <textarea id="custom-poll-options-input" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-lime-500" placeholder="ä¾‹å¦‚ï¼š
é¸é … A
é¸é … B
é¸é … C"></textarea>
                </div>

                <!-- åŒ¿åè¨­å®š -->
                <div class="flex items-center">
                    <input type="checkbox" id="quick-poll-anonymous-checkbox" checked class="form-checkbox h-5 w-5 text-lime-600 rounded">
                    <label for="quick-poll-anonymous-checkbox" class="ml-2 text-gray-700 font-medium">åŒ¿åæŠ•ç¥¨ï¼ˆä¸è¨˜éŒ„å­¸ç”Ÿå§“åï¼‰</label>
                </div>
            </div>

            <div class="settings-button-group mt-6 w-full">
                <button id="start-quick-poll-btn" class="btn bg-lime-500 hover:bg-lime-600">é–‹å§‹æŠ•ç¥¨ ğŸš€</button>
                <button id="cancel-quick-poll-settings-btn" class="btn btn-gray">å–æ¶ˆ â†©ï¸</button>
            </div>
        </div>
    </div>

    <!-- å¿«é€ŸæŠ•ç¥¨çµ±è¨ˆæ¨¡æ…‹æ¡† -->
    <div id="quick-poll-stats-modal" class="magnified-image-modal hidden">
        <div id="quick-poll-stats-modal-content" class="magnified-image-modal-content" style="max-width: 900px; max-height: 90vh;">
            <button id="quick-poll-stats-modal-close-btn" class="magnified-image-modal-close">Ã—</button>
            <h4 class="text-2xl font-bold mb-4 text-gray-800 text-center">æŠ•ç¥¨çµ±è¨ˆçµæœ</h4>
            <p id="quick-poll-stats-question" class="text-lg text-gray-700 mb-4 text-center font-medium"></p>

            <!-- ä¸Šæ–¹å€å¡Šï¼šå·¦å³å…©æ¬„å¸ƒå±€ -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                <!-- å·¦æ¬„ï¼šåœ–è¡¨é¡å‹åˆ‡æ›å’Œçµ±è¨ˆè³‡è¨Š -->
                <div>
                    <!-- åœ–è¡¨é¡å‹åˆ‡æ› -->
                    <div class="flex justify-center gap-4 mb-4">
                        <button id="chart-type-bar-btn" class="btn bg-blue-500 hover:bg-blue-600 !w-auto text-sm h-10 px-4">é•·æ¢åœ–</button>
                        <button id="chart-type-pie-btn" class="btn btn-gray !w-auto text-sm h-10 px-4">åœ“é¤…åœ–</button>
                    </div>

                    <!-- æŠ•ç¥¨çµ±è¨ˆè³‡è¨Š -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div>
                                <p class="text-gray-600 text-sm">ç¸½æŠ•ç¥¨æ•¸</p>
                                <p id="poll-total-votes" class="text-3xl font-bold text-lime-600">0</p>
                            </div>
                            <div>
                                <p class="text-gray-600 text-sm">åœ¨ç·šå­¸ç”Ÿæ•¸</p>
                                <p id="poll-online-students" class="text-3xl font-bold text-blue-600">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å³æ¬„ï¼šè©³ç´°æ•¸æ“šè¡¨æ ¼ -->
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border px-4 py-2 text-left">é¸é …</th>
                                <th class="border px-4 py-2 text-right">ç¥¨æ•¸</th>
                                <th class="border px-4 py-2 text-right">ç™¾åˆ†æ¯”</th>
                            </tr>
                        </thead>
                        <tbody id="quick-poll-stats-table-body">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- D3.js åœ–è¡¨å®¹å™¨ -->
            <div class="bg-white border rounded-lg p-4 overflow-x-auto" style="min-height: 500px;">
                <svg id="quick-poll-chart-svg" width="800" height="450"></svg>
            </div>

            <div class="flex justify-center gap-4 mt-6">
                <button id="download-poll-results-btn" class="btn btn-green !w-auto text-base h-11 px-6">
                    <i class="fas fa-download mr-2"></i>ä¸‹è¼‰çµæœ (CSV)
                </button>
                <button id="end-quick-poll-btn" class="btn btn-red !w-auto text-base h-11 px-6">
                    <i class="fas fa-stop mr-2"></i>çµæŸæŠ•ç¥¨
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase è¨­å®šæª”ï¼ˆè«‹ä¿®æ”¹æ­¤æª”æ¡ˆä¾†ä½¿ç”¨æ‚¨è‡ªå·±çš„ Firebase å°ˆæ¡ˆï¼‰ -->
    <script src="firebase-config.js"></script>

    <script type="module">
        // Import Firebase SDK functions.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; // Added signOut
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc, getDoc, getDocs, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Variables ---
        // Max dimension (px) for user uploaded images to prevent excessively large files.
        const MAX_IMAGE_DIMENSION = 1024; 
        // JPEG compression quality (0.0 to 1.0).
        const JPEG_QUALITY = 0.8; 

        // Firebase configuration.
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : {
  apiKey: "AIzaSyCuBiHvunT50x0_GGjcCvhxCMHta7CwN9I",
  authDomain: "tools1029-4a3e9.firebaseapp.com",
  projectId: "tools1029-4a3e9",
  storageBucket: "tools1029-4a3e9.firebasestorage.app",
  messagingSenderId: "1026250315957",
  appId: "1:1026250315957:web:aa92eabb0be5a9bf8306fc"
};

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app); 
        const db = getFirestore(app);

        // Use __app_id for the base Firestore path.
        const baseAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-classroom-app';
        let userId = null;
        let studentName = null;
        let currentRole = null; // 'teacher' or 'student'
        let classroomCode = null; // NEW: Stores the teacher-defined or student-entered classroom code.
        let currentInteractionMode = null; // To track the active mode for statistics.
        let allStudentResponses = []; // Global variable to store all student responses for charting and lottery.
        let activeStudentNames = []; // NEW: Global variable to store names of all currently active students.
        let lastSelectedStudentCard = null; // To track the previously selected card for the lottery feature.
        let isResponsePaused = false; // NEW: Global state for response pause.
        let lastSelectedModalStudent = null; // NEW: To track the previously selected student in the modal for lottery.

        let interactionModeUnsubscribe = null;
        let questionBanks = []; // Question Bank storage in memory (will be cleared when class ends)
        let sequencingQuestionBanks = []; // Sequencing Question Bank storage
        let matchingQuestionBanks = []; // Matching Question Bank storage
        let studentResponsesUnsubscribe = null;
        let classroomPresenceUnsubscribe = null; // Unsubscribe function for classroom presence listener.

        // Quick Poll variables
        let quickPollActive = false;
        let quickPollData = null; // Stores current poll configuration
        let quickPollVotesUnsubscribe = null; // Listener for vote updates
        let currentChartType = 'bar'; // 'bar' or 'pie'

        // Drawing specific variables.
        const canvas = document.getElementById('drawing-canvas'); // Main canvas for student display.
        const ctx = canvas.getContext('2d'); // 2D context of the main canvas.

        let backgroundCanvas = document.createElement('canvas'); // Canvas for teacher's background image.
        let backgroundCtx = backgroundCanvas.getContext('2d');

        let studentImageCanvas = document.createElement('canvas'); 
        let studentImageCtx = studentImageCanvas.getContext('2d');
        let studentUploadedImageDataURL = null; // Stores the scaled and compressed student uploaded image Data URL.

        let drawingCanvas = document.createElement('canvas'); // Canvas for student's drawing strokes.
        let drawingCtx = drawingCanvas.getContext('2d');

        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        
        let teacherUploadedBackgroundImageDataURL = null; // Stores the scaled and compressed background image Data URL from Firestore.

        // AI Settings Global Object
        let aiSettings = {
            aiSource: 'gemini-custom', // 'gemini-default' or 'gemini-custom'
            geminiApiKey: '' // Custom API key if 'gemini-custom' is selected
        };
        
        // MODIFIED: Combined Dispatch Settings Global Object
        let dispatchSettings = {
            type: 'url', // 'url' or 'html'
            url: '',
            isYoutube: false, // Only relevant if type is 'url'
            htmlContent: null // Only relevant if type is 'html'
        };

        // New: Recording specific variables
        let mediaRecorder;
        let audioChunks = [];
        let audioBlob = null;
        let audioDataURL = null;
        let audioStream = null; // To store the MediaStream object

        // NEW: Custom Multiple Choice Questions (Teacher side)
        let customMultipleChoiceQuestions = []; // Stores parsed questions from teacher input

        // NEW: Reading Comprehension Data (Teacher side)
        let readingComprehensionData = {
            text: '',
            questions: [] // Array of {question, correctAnswer, options, level}
        };

        // NEW: Store student's current answers (not yet submitted) for reading comprehension
        let currentReadingAnswers = [];

        // NEW: Reading Comprehension Question Banks
        let readingQuestionBanks = [];

        // NEW: Sequencing and Matching Questions (Teacher side)
        let sequencingData = {
            question: '',
            correctOrder: [] // Array of items in correct order
        };
        let matchingData = {
            question: '',
            pairs: [] // Array of {left, right} objects
        };
        let currentMatchingSelection = {
            leftItem: null,
            rightItem: null
        };
        let currentMultipleChoiceQuestions = null; // Stores questions from Firestore for student/teacher monitor

        // NEW: Peer Review System Variables
        let peerReviewActive = false; // Whether peer review is currently active
        let peerReviewUnsubscribe = null; // Unsubscribe function for peer review votes listener
        let studentVotedWorks = new Set(); // Track which works this student has voted for
        let allPeerReviewVotes = {}; // Global object to store all votes data
        const MAX_VOTES_PER_STUDENT = 3; // Maximum votes per student per interaction
        
        // Canvas content preservation
        let savedCanvasState = null; // Save student's drawing when switching to peer review
        

        // --- DOM Elements Caching ---
        const views = {
            entry: document.getElementById('entry-view'),
            teacherClassroomCode: document.getElementById('teacher-classroom-code-view'), // NEW VIEW
            teacherMenu: document.getElementById('teacher-menu-view'),
            teacherMonitor: document.getElementById('teacher-monitor-view'),
            studentName: document.getElementById('student-name-view'),
            studentWaiting: document.getElementById('student-waiting-view'),
            studentInteraction: document.getElementById('student-interaction-view'),
            studentPeerReview: document.getElementById('student-peer-review-view'), // NEW VIEW
        };

        const interactionUIs = {
            true_false: document.getElementById('interaction-true-false'),
            multiple_choice: document.getElementById('interaction-multiple-choice'),
            text_input: document.getElementById('interaction-text-input'),
            drawing: document.getElementById('interaction-drawing'),
            url_dispatch: document.getElementById('interaction-url-dispatch'), // Now handles both URL and HTML
            recording: document.getElementById('interaction-recording'), // New UI
            reading_comprehension: document.getElementById('interaction-reading-comprehension'), // Reading comprehension UI
            quick_answer: document.getElementById('interaction-quick-answer'), // Quick answer UI
            quick_poll: document.getElementById('interaction-quick-poll'), // Quick poll UI
            sequencing: document.getElementById('interaction-sequencing'), // Sequencing UI
            matching: document.getElementById('interaction-matching'), // Matching UI
        };

        // --- Core Logic Functions ---
        /**
         * Displays the specified view section.
         * @param {string} viewName - The name of the view to display (key in `views` object).
         */
        function showView(viewName) {
            const body = document.querySelector('body');
            body.classList.remove('initial-view-background');

            Object.values(views).forEach(view => view.classList.add('hidden'));
            if (views[viewName]) {
                views[viewName].classList.remove('hidden');
                if (viewName === 'entry') {
                    body.classList.add('initial-view-background');
                }
            }
        }
        
        /**
         * Displays the UI for a specific interaction mode within the student interface.
         * @param {string} mode - The interaction mode (e.g., 'true_false', 'drawing', 'recording', 'url_dispatch').
         * @param {boolean} [isResumingFromPause=false] - True if this is part of resuming from a paused state.
         */
        function showInteractionUI(mode, isResumingFromPause = false) {
             Object.values(interactionUIs).forEach(ui => ui.classList.add('hidden'));
             // Clear URL dispatch content if switching to another mode
             if (mode !== 'url_dispatch' && interactionUIs.url_dispatch) {
                interactionUIs.url_dispatch.innerHTML = ''; // Clear content for URL/HTML dispatch
                interactionUIs.url_dispatch.style.cssText = ''; // Reset container styles
             }

             if (interactionUIs[mode]) {
                interactionUIs[mode].classList.remove('hidden');
                resetStudentUIState(mode, isResumingFromPause); // Pass the flag

                // Special handling for quick answer mode
                if (mode === 'quick_answer') {
                    startQuickAnswer();
                    listenToQuickAnswerUpdates();
                }
             }
        }

        /**
         * Resets the student UI state, e.g., clears input fields or enables buttons.
         * @param {string} mode - The current interaction mode.
         * @param {boolean} [isResumingFromPause=false] - True if this reset is part of resuming from a paused state.
         */
        function resetStudentUIState(mode, isResumingFromPause = false) {
            const grayClass = 'bg-gray-400';
            const hoverClassMap = {
                '1': 'hover:bg-blue-600', '2': 'hover:bg-yellow-600',
                '3': 'hover:bg-green-600', '4': 'hover:bg-red-600'
            };
            
            // Ensure all interaction UIs are enabled by default before applying pause state
            document.querySelectorAll('#student-interaction-view button, #student-interaction-view textarea, #student-interaction-view input[type="file"], #student-interaction-view select, #student-interaction-view input[type="radio"]').forEach(el => {
                el.disabled = false;
                // Re-add original classes if they were removed by pause state
                if (el.classList.contains('btn-gray')) {
                    el.classList.remove('btn-gray');
                    el.classList.add('btn-primary'); // Assuming primary is default for many
                }
            });
            // Re-enable canvas interaction
            canvas.style.pointerEvents = 'auto';

            switch(mode) {
                case 'true_false':
                    interactionUIs[mode].querySelectorAll('.answer-btn').forEach(btn => {
                        btn.disabled = false;
                        btn.classList.remove(grayClass);
                        if (btn.dataset.answer === 'O') btn.classList.replace('bg-gray-400', 'bg-green-500');
                        if (btn.dataset.answer === 'X') btn.classList.replace('bg-gray-400', 'bg-red-500');
                    });
                    break;
                case 'multiple_choice':
                    // Reset default MC options
                    const defaultMcOptions = document.getElementById('default-mc-options');
                    defaultMcOptions.querySelectorAll('.answer-btn').forEach(btn => {
                        btn.disabled = false;
                        btn.classList.remove(grayClass);
                        if (btn.dataset.answer === '1') btn.classList.replace('bg-gray-400', 'bg-blue-500');
                        if (btn.dataset.answer === '2') btn.classList.replace('bg-gray-400', 'bg-yellow-500');
                        if (btn.dataset.answer === '3') btn.classList.replace('bg-gray-400', 'bg-green-500');
                        if (btn.dataset.answer === '4') btn.classList.replace('bg-gray-400', 'bg-red-500');
                        btn.classList.add(hoverClassMap[btn.dataset.answer]);
                    });
                    // Reset custom MC options (but preserve submission state)
                    document.getElementById('custom-mc-questions-container').innerHTML = '';
                    // NEW: åªæœ‰åœ¨ä¸æ˜¯å¾æš«åœç‹€æ…‹æ¢å¾©æ™‚æ‰é‡ç½®æŒ‰éˆ•ï¼Œé¿å…è¦†è“‹å·²æäº¤ç‹€æ…‹
                    if (!isResumingFromPause) {
                        const submitBtn = document.getElementById('submit-custom-mc-btn');
                        submitBtn.disabled = false;
                        submitBtn.classList.replace('btn-gray', 'btn-primary');
                        submitBtn.textContent = 'é€å‡ºå…¨éƒ¨ç­”æ¡ˆ âœ‰ï¸';
                    }
                    break;
                case 'text_input':
                    document.getElementById('text-input-area').value = '';
                    const submitTextBtn = document.getElementById('submit-text-btn');
                    submitTextBtn.disabled = false;
                    submitTextBtn.classList.remove('btn-gray');
                    submitTextBtn.classList.add('btn-primary');
                    break;
                case 'drawing':
                    // Only clear the drawing canvas if it's NOT resuming from a pause.
                    // If isResumingFromPause is true, it means we are re-enabling controls
                    // within the *same* drawing session after a pause, so preserve the drawing.
                    if (!isResumingFromPause) {
                         clearDrawingCanvas(); // Clears only the student's drawing layer.
                         studentUploadedImageDataURL = null; // Clear student uploaded image too
                         studentImageCtx.clearRect(0, 0, studentImageCanvas.width, studentImageCanvas.height);
                    }
                    
                    const submitDrawingBtn = document.getElementById('submit-drawing-btn');
                    submitDrawingBtn.disabled = false;
                    submitDrawingBtn.classList.replace('btn-gray', 'btn-primary');
                    
                    // Reset drawing tools to default values.
                    const colorSelect = document.getElementById('color-select');
                    const sizeSelect = document.getElementById('size-select');
                    const penToolBtn = document.getElementById('pen-tool-btn');
                    const eraserBtn = document.getElementById('eraser-btn');

                    colorSelect.value = 'black';
                    sizeSelect.value = '2';
                    drawingCtx.strokeStyle = 'black'; 
                    drawingCtx.lineWidth = 2;
                    drawingCtx.globalCompositeOperation = 'source-over'; 
                    
                    penToolBtn.classList.add('border-blue-500');
                    eraserBtn.classList.remove('border-blue-500');

                    updateColorSwatch(colorSelect.value);
                    break;
                case 'url_dispatch': // This mode now handles both URL and HTML
                    // Content is dynamically generated, no specific reset needed here beyond clearing in showInteractionUI
                    break;
                case 'recording':
                    // Reset recording state
                    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                        mediaRecorder.stop();
                    }
                    if (audioStream) {
                        audioStream.getTracks().forEach(track => track.stop());
                    }
                    audioChunks = [];
                    audioBlob = null;
                    audioDataURL = null;
                    document.getElementById('audio-preview').classList.add('hidden');
                    document.getElementById('audio-preview').src = '';
                    document.getElementById('start-recording-btn').disabled = false;
                    document.getElementById('stop-recording-btn').disabled = true;
                    document.getElementById('play-recording-btn').disabled = true;
                    document.getElementById('reset-recording-btn').disabled = true;
                    document.getElementById('submit-recording-btn').disabled = true;
                    recordingStatusText.textContent = 'æº–å‚™éŒ„éŸ³...';
                    recordingStatusIcon.classList.remove('fa-spin', 'text-red-500');
                    recordingStatusIcon.classList.add('text-gray-400');
                    break;
                case 'quick_answer':
                    // Reset quick answer state
                    document.getElementById('quick-answer-status-text').textContent = 'ç­‰å¾…æ¶ç­”é–‹å§‹...';
                    document.getElementById('quick-answer-result').classList.add('hidden');
                    document.getElementById('quick-answer-locked').classList.add('hidden');
                    document.getElementById('quick-answer-button-container').innerHTML = '';
                    document.getElementById('quick-answer-button-container').classList.add('pointer-events-none');
                    break;
                case 'sequencing':
                    // Reset sequencing state
                    document.getElementById('sequencing-items-container').innerHTML = '';
                    const submitSequencingBtn = document.getElementById('submit-sequencing-btn');
                    submitSequencingBtn.disabled = false;
                    submitSequencingBtn.classList.remove('btn-gray');
                    submitSequencingBtn.classList.add('btn-primary');
                    break;
                case 'matching':
                    // Reset matching state
                    document.getElementById('matching-column-a').innerHTML = '';
                    document.getElementById('matching-column-b').innerHTML = '';
                    document.getElementById('matching-svg-canvas').innerHTML = '';
                    const submitMatchingBtn = document.getElementById('submit-matching-btn');
                    submitMatchingBtn.disabled = false;
                    submitMatchingBtn.classList.remove('btn-gray');
                    submitMatchingBtn.classList.add('btn-primary');
                    currentMatchingSelection.leftItem = null;
                    currentMatchingSelection.rightItem = null;
                    break;
                case 'reading_comprehension':
                    // Only clear content if not resuming from pause
                    if (!isResumingFromPause) {
                        document.getElementById('reading-text-display').textContent = '';
                        document.getElementById('reading-questions-container').innerHTML = '';
                        // Clear local answers when switching to a new reading comprehension session
                        currentReadingAnswers = [];
                    }
                    const submitReadingBtn = document.getElementById('submit-reading-btn');
                    // Don't reset button state if resuming from pause (preserve submitted state)
                    if (!isResumingFromPause) {
                        submitReadingBtn.disabled = false;
                        submitReadingBtn.classList.remove('btn-gray');
                        submitReadingBtn.classList.add('btn-primary');
                    }
                    break;
                case 'quick_poll':
                    // Reset quick poll state
                    document.getElementById('quick-poll-options-container').innerHTML = '';
                    document.getElementById('quick-poll-options-container').classList.remove('hidden');
                    document.getElementById('quick-poll-voted-status').classList.add('hidden');
                    document.getElementById('quick-poll-question-display').textContent = '';
                    break;
            }
        }

        /**
         * Toggles the enabled/disabled state of student interaction elements.
         * @param {boolean} disable - True to disable, false to enable.
         */
        function toggleStudentInteractionElements(disable) {
            const studentInteractionView = document.getElementById('student-interaction-view');
            // Select all interactive elements within the student interaction view, excluding the pause overlay itself.
            const interactiveElements = studentInteractionView.querySelectorAll(
                'button, textarea, input[type="file"], select, input[type="radio"]' // Added input[type="radio"]
            );

            interactiveElements.forEach(el => {
                // Only disable if the element is not the pause overlay itself or its children
                if (!el.closest('#student-pause-overlay')) {
                    el.disabled = disable;
                    if (disable) {
                        // Add a class for visual feedback if needed, e.g., gray out
                        if (el.tagName === 'BUTTON' && !el.classList.contains('btn-gray')) {
                            el.classList.add('btn-gray');
                            el.classList.remove('btn-primary', 'btn-green', 'btn-orange', 'btn-purple', 'btn-teal', 'bg-indigo-600', 'hover:bg-indigo-700', 'bg-yellow-600', 'hover:bg-yellow-700'); // Remove original colors
                        }
                    } else {
                        // Re-enable and restore original styles
                        if (el.tagName === 'BUTTON' && el.classList.contains('btn-gray')) {
                            el.classList.remove('btn-gray');
                            // Restore based on common button types or specific IDs
                            if (el.id === 'submit-text-btn' || el.id === 'submit-drawing-btn' || el.id === 'submit-recording-btn' || el.id === 'submit-custom-mc-btn' || el.id === 'submit-reading-btn' || el.id === 'submit-sequencing-btn' || el.id === 'submit-matching-btn') {
                                el.classList.add('btn-primary');
                            } else if (el.classList.contains('answer-btn')) {
                                // For answer buttons, re-apply their specific colors
                                if (el.dataset.answer === 'O') el.classList.add('bg-green-500');
                                else if (el.dataset.answer === 'X') el.classList.add('bg-red-500');
                                else if (el.dataset.answer === '1') el.classList.add('bg-blue-500');
                                else if (el.dataset.answer === '2') el.classList.add('bg-yellow-500');
                                else if (el.dataset.answer === '3') el.classList.add('bg-green-500');
                                else if (el.dataset.answer === '4') el.classList.add('bg-red-500');
                            } else if (el.id === 'start-recording-btn') {
                                el.classList.add('btn-green');
                            } else if (el.id === 'stop-recording-btn') {
                                el.classList.add('btn-red');
                            } else if (el.id === 'play-recording-btn') {
                                el.classList.add('btn-primary');
                            } else if (el.id === 'reset-recording-btn') {
                                el.classList.add('btn-orange');
                            } else if (el.id === 'pen-tool-btn') {
                                el.classList.add('border-blue-500'); // Pen button border
                            }
                        }
                    }
                }
            });

            // Handle canvas interaction separately
            canvas.style.pointerEvents = disable ? 'none' : 'auto';

            // Handle recording specific buttons that might be disabled by default
            if (currentInteractionMode === 'recording' && !disable) {
                // Only enable start if not already recording
                if (mediaRecorder && mediaRecorder.state === 'inactive') {
                    document.getElementById('start-recording-btn').disabled = false;
                }
                // Other recording buttons remain disabled until recording starts/stops
            }
        }
        
        /**
         * Displays a custom message box.
         * @param {string} message - The message to display.
         * @param {'info' | 'success' | 'error'} type - The message type, influencing its color.
         */
        function showMessage(message, type = 'info') {
            const msgBox = document.getElementById('message-box');
            const msgContent = document.getElementById('message-content');
            msgContent.textContent = message;
            msgBox.className = 'fixed top-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 transform text-white';
            switch (type) {
                case 'success': msgBox.classList.add('bg-green-500'); break;
                case 'error': msgBox.classList.add('bg-red-500'); break;
                case 'info': msgBox.classList.add('bg-blue-500'); break;
                default: msgBox.classList.add('bg-blue-500'); break;
            }
            msgBox.classList.remove('hidden');
            setTimeout(() => {
                msgBox.classList.add('hidden');
            }, 3000); // Auto-hide after 3 seconds.
        }

        /**
         * Question Bank Management Functions
         */
        function updateQuestionBankList() {
            const list = document.getElementById('question-bank-list');
            if (questionBanks.length === 0) {
                list.innerHTML = '<div class="text-gray-500 text-sm italic text-center">ç›®å‰æ²’æœ‰å„²å­˜çš„é¡Œåº«</div>';
            } else {
                list.innerHTML = questionBanks.map((bank, index) => `
                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded border">
                        <span class="text-sm font-medium text-gray-700">${bank.name}</span>
                        <div class="flex gap-2">
                            <button onclick="loadQuestionBankToTextarea(${index})" class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded">è¼‰å…¥</button>
                            <button onclick="deleteQuestionBank(${index})" class="px-2 py-1 bg-red-500 hover:bg-red-600 text-white text-xs rounded">åˆªé™¤</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function loadQuestionBankFromFile() {
            const fileInput = document.getElementById('question-bank-file-input');
            const file = fileInput.files[0];

            if (!file) {
                showMessage('è«‹é¸æ“‡ä¸€å€‹txtæª”æ¡ˆ', 'error');
                return;
            }

            if (!file.name.toLowerCase().endsWith('.txt')) {
                showMessage('åªèƒ½ä¸Šå‚³txtæ ¼å¼çš„æª”æ¡ˆ', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const fileName = file.name.replace('.txt', '');

                // Check if bank with same name exists
                const existingIndex = questionBanks.findIndex(bank => bank.name === fileName);
                if (existingIndex !== -1) {
                    if (confirm(`é¡Œåº«ã€Œ${fileName}ã€å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦è¦†è“‹ï¼Ÿ`)) {
                        questionBanks[existingIndex] = { name: fileName, content: content };
                    } else {
                        return;
                    }
                } else {
                    questionBanks.push({ name: fileName, content: content });
                }

                updateQuestionBankList();
                showMessage(`é¡Œåº«ã€Œ${fileName}ã€è¼‰å…¥æˆåŠŸ`, 'success');
                fileInput.value = ''; // Clear file input
            };

            reader.onerror = function() {
                showMessage('è®€å–æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
            };

            reader.readAsText(file, 'UTF-8');
        }

        function saveQuestionBankFromTextarea() {
            const nameInput = document.getElementById('question-bank-name-input');
            const textarea = document.getElementById('custom-mc-questions-textarea');
            const name = nameInput.value.trim();
            const content = textarea.value.trim();

            if (!name) {
                showMessage('è«‹è¼¸å…¥é¡Œåº«åç¨±', 'error');
                return;
            }

            if (!content) {
                showMessage('é¡Œç›®å…§å®¹ä¸èƒ½ç‚ºç©º', 'error');
                return;
            }

            // Check if bank with same name exists
            const existingIndex = questionBanks.findIndex(bank => bank.name === name);
            if (existingIndex !== -1) {
                if (confirm(`é¡Œåº«ã€Œ${name}ã€å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦è¦†è“‹ï¼Ÿ`)) {
                    questionBanks[existingIndex] = { name: name, content: content };
                } else {
                    return;
                }
            } else {
                questionBanks.push({ name: name, content: content });
            }

            updateQuestionBankList();
            showMessage(`é¡Œåº«ã€Œ${name}ã€å„²å­˜æˆåŠŸ`, 'success');
            nameInput.value = ''; // Clear name input
        }

        function loadQuestionBankToTextarea(index) {
            if (index >= 0 && index < questionBanks.length) {
                const textarea = document.getElementById('custom-mc-questions-textarea');
                textarea.value = questionBanks[index].content;
                showMessage(`é¡Œåº«ã€Œ${questionBanks[index].name}ã€å·²è¼‰å…¥åˆ°è¼¸å…¥æ¡†`, 'success');
            }
        }

        function deleteQuestionBank(index) {
            if (index >= 0 && index < questionBanks.length) {
                const bankName = questionBanks[index].name;
                if (confirm(`ç¢ºå®šè¦åˆªé™¤é¡Œåº«ã€Œ${bankName}ã€å—ï¼Ÿ`)) {
                    questionBanks.splice(index, 1);
                    updateQuestionBankList();
                    showMessage(`é¡Œåº«ã€Œ${bankName}ã€å·²åˆªé™¤`, 'success');
                }
            }
        }

        // Make functions globally accessible for onclick handlers
        window.loadQuestionBankToTextarea = loadQuestionBankToTextarea;
        window.deleteQuestionBank = deleteQuestionBank;

        function clearAllQuestionBanks() {
            questionBanks = [];
            updateQuestionBankList();

            // Clear reading comprehension question banks
            readingQuestionBanks = [];
            localStorage.removeItem('readingQuestionBanks');
            updateReadingBankList();
        }

        // ==================== Sequencing Question Bank Functions ====================

        function updateSequencingBankList() {
            const list = document.getElementById('seq-bank-list');
            if (sequencingQuestionBanks.length === 0) {
                list.innerHTML = '<div class="text-gray-500 text-sm italic text-center">ç›®å‰æ²’æœ‰å„²å­˜çš„é¡Œåº«</div>';
            } else {
                list.innerHTML = sequencingQuestionBanks.map((bank, index) => `
                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded border">
                        <span class="text-sm font-medium text-gray-700">${bank.name}</span>
                        <div class="flex gap-2">
                            <button onclick="loadSequencingBankToTextarea(${index})" class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded">è¼‰å…¥</button>
                            <button onclick="deleteSequencingBank(${index})" class="px-2 py-1 bg-red-500 hover:bg-red-600 text-white text-xs rounded">åˆªé™¤</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function loadSequencingBankFromFile() {
            const fileInput = document.getElementById('seq-bank-file-input');
            const file = fileInput.files[0];

            if (!file) {
                showMessage('è«‹é¸æ“‡ä¸€å€‹txtæª”æ¡ˆ', 'error');
                return;
            }

            if (!file.name.toLowerCase().endsWith('.txt')) {
                showMessage('åªèƒ½ä¸Šå‚³txtæ ¼å¼çš„æª”æ¡ˆ', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const fileName = file.name.replace('.txt', '');
                const lines = content.split('\n').map(line => line.trim()).filter(line => line);

                if (lines.length < 2) {
                    showMessage('é¡Œåº«æ ¼å¼éŒ¯èª¤ï¼šè‡³å°‘éœ€è¦2å€‹æ’åºé …ç›®', 'error');
                    return;
                }

                const question = 'æ’åºé¡Œ';
                const items = lines.join('\n');

                const existingIndex = sequencingQuestionBanks.findIndex(bank => bank.name === fileName);
                if (existingIndex !== -1) {
                    if (confirm(`é¡Œåº«ã€Œ${fileName}ã€å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦è¦†è“‹ï¼Ÿ`)) {
                        sequencingQuestionBanks[existingIndex] = { name: fileName, question: question, items: items };
                    } else {
                        return;
                    }
                } else {
                    sequencingQuestionBanks.push({ name: fileName, question: question, items: items });
                }

                updateSequencingBankList();
                showMessage(`é¡Œåº«ã€Œ${fileName}ã€è¼‰å…¥æˆåŠŸ`, 'success');
                fileInput.value = '';
            };

            reader.onerror = function() {
                showMessage('è®€å–æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
            };

            reader.readAsText(file, 'UTF-8');
        }

        function saveSequencingBank() {
            const nameInput = document.getElementById('seq-bank-name-input');
            const itemsTextarea = document.getElementById('sequencing-items-textarea');

            const name = nameInput.value.trim();
            const question = 'æ’åºé¡Œ';
            const items = itemsTextarea.value.trim();

            if (!name) {
                showMessage('è«‹è¼¸å…¥é¡Œåº«åç¨±', 'error');
                return;
            }

            if (!items) {
                showMessage('æ’åºé …ç›®ä¸èƒ½ç‚ºç©º', 'error');
                return;
            }

            const existingIndex = sequencingQuestionBanks.findIndex(bank => bank.name === name);
            if (existingIndex !== -1) {
                if (confirm(`é¡Œåº«ã€Œ${name}ã€å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦è¦†è“‹ï¼Ÿ`)) {
                    sequencingQuestionBanks[existingIndex] = { name: name, question: question, items: items };
                } else {
                    return;
                }
            } else {
                sequencingQuestionBanks.push({ name: name, question: question, items: items });
            }

            updateSequencingBankList();
            showMessage(`é¡Œåº«ã€Œ${name}ã€å„²å­˜æˆåŠŸ`, 'success');
            nameInput.value = '';
        }

        function loadSequencingBankToTextarea(index) {
            if (index >= 0 && index < sequencingQuestionBanks.length) {
                const bank = sequencingQuestionBanks[index];
                document.getElementById('sequencing-items-textarea').value = bank.items;
                showMessage(`é¡Œåº«ã€Œ${bank.name}ã€å·²è¼‰å…¥åˆ°è¼¸å…¥æ¡†`, 'success');
            }
        }

        function deleteSequencingBank(index) {
            if (index >= 0 && index < sequencingQuestionBanks.length) {
                const bankName = sequencingQuestionBanks[index].name;
                if (confirm(`ç¢ºå®šè¦åˆªé™¤é¡Œåº«ã€Œ${bankName}ã€å—ï¼Ÿ`)) {
                    sequencingQuestionBanks.splice(index, 1);
                    updateSequencingBankList();
                    showMessage(`é¡Œåº«ã€Œ${bankName}ã€å·²åˆªé™¤`, 'success');
                }
            }
        }

        // ==================== Matching Question Bank Functions ====================

        function updateMatchingBankList() {
            const list = document.getElementById('match-bank-list');
            if (matchingQuestionBanks.length === 0) {
                list.innerHTML = '<div class="text-gray-500 text-sm italic text-center">ç›®å‰æ²’æœ‰å„²å­˜çš„é¡Œåº«</div>';
            } else {
                list.innerHTML = matchingQuestionBanks.map((bank, index) => `
                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded border">
                        <span class="text-sm font-medium text-gray-700">${bank.name}</span>
                        <div class="flex gap-2">
                            <button onclick="loadMatchingBankToTextarea(${index})" class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded">è¼‰å…¥</button>
                            <button onclick="deleteMatchingBank(${index})" class="px-2 py-1 bg-red-500 hover:bg-red-600 text-white text-xs rounded">åˆªé™¤</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function loadMatchingBankFromFile() {
            const fileInput = document.getElementById('match-bank-file-input');
            const file = fileInput.files[0];

            if (!file) {
                showMessage('è«‹é¸æ“‡ä¸€å€‹txtæª”æ¡ˆ', 'error');
                return;
            }

            if (!file.name.toLowerCase().endsWith('.txt')) {
                showMessage('åªèƒ½ä¸Šå‚³txtæ ¼å¼çš„æª”æ¡ˆ', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const fileName = file.name.replace('.txt', '');
                const lines = content.split('\n').map(line => line.trim()).filter(line => line);

                if (lines.length < 2) {
                    showMessage('é¡Œåº«æ ¼å¼éŒ¯èª¤ï¼šè‡³å°‘éœ€è¦2çµ„é…å°é …ç›®', 'error');
                    return;
                }

                const question = 'é…å°é¡Œ';
                const pairs = lines.join('\n');

                const existingIndex = matchingQuestionBanks.findIndex(bank => bank.name === fileName);
                if (existingIndex !== -1) {
                    if (confirm(`é¡Œåº«ã€Œ${fileName}ã€å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦è¦†è“‹ï¼Ÿ`)) {
                        matchingQuestionBanks[existingIndex] = { name: fileName, question: question, pairs: pairs };
                    } else {
                        return;
                    }
                } else {
                    matchingQuestionBanks.push({ name: fileName, question: question, pairs: pairs });
                }

                updateMatchingBankList();
                showMessage(`é¡Œåº«ã€Œ${fileName}ã€è¼‰å…¥æˆåŠŸ`, 'success');
                fileInput.value = '';
            };

            reader.onerror = function() {
                showMessage('è®€å–æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
            };

            reader.readAsText(file, 'UTF-8');
        }

        function saveMatchingBank() {
            const nameInput = document.getElementById('match-bank-name-input');
            const pairsTextarea = document.getElementById('matching-pairs-textarea');

            const name = nameInput.value.trim();
            const question = 'é…å°é¡Œ';
            const pairs = pairsTextarea.value.trim();

            if (!name) {
                showMessage('è«‹è¼¸å…¥é¡Œåº«åç¨±', 'error');
                return;
            }

            if (!pairs) {
                showMessage('é…å°é …ç›®ä¸èƒ½ç‚ºç©º', 'error');
                return;
            }

            const existingIndex = matchingQuestionBanks.findIndex(bank => bank.name === name);
            if (existingIndex !== -1) {
                if (confirm(`é¡Œåº«ã€Œ${name}ã€å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦è¦†è“‹ï¼Ÿ`)) {
                    matchingQuestionBanks[existingIndex] = { name: name, question: question, pairs: pairs };
                } else {
                    return;
                }
            } else {
                matchingQuestionBanks.push({ name: name, question: question, pairs: pairs });
            }

            updateMatchingBankList();
            showMessage(`é¡Œåº«ã€Œ${name}ã€å„²å­˜æˆåŠŸ`, 'success');
            nameInput.value = '';
        }

        function loadMatchingBankToTextarea(index) {
            if (index >= 0 && index < matchingQuestionBanks.length) {
                const bank = matchingQuestionBanks[index];
                document.getElementById('matching-pairs-textarea').value = bank.pairs;
                showMessage(`é¡Œåº«ã€Œ${bank.name}ã€å·²è¼‰å…¥åˆ°è¼¸å…¥æ¡†`, 'success');
            }
        }

        function deleteMatchingBank(index) {
            if (index >= 0 && index < matchingQuestionBanks.length) {
                const bankName = matchingQuestionBanks[index].name;
                if (confirm(`ç¢ºå®šè¦åˆªé™¤é¡Œåº«ã€Œ${bankName}ã€å—ï¼Ÿ`)) {
                    matchingQuestionBanks.splice(index, 1);
                    updateMatchingBankList();
                    showMessage(`é¡Œåº«ã€Œ${bankName}ã€å·²åˆªé™¤`, 'success');
                }
            }
        }

        // Make functions globally accessible
        window.loadSequencingBankToTextarea = loadSequencingBankToTextarea;
        window.deleteSequencingBank = deleteSequencingBank;
        window.loadMatchingBankToTextarea = loadMatchingBankToTextarea;
        window.deleteMatchingBank = deleteMatchingBank;

        /**
         * Hides the custom message box.
         */
        function hideMessage() {
            document.getElementById('message-box').classList.add('hidden');
        }

        // --- Firebase Functions ---

        /**
         * (Teacher) Sets the current interaction mode and clears old student response data.
         * @param {string} mode - 'true_false', 'multiple_choice', 'text_input', 'drawing', 'url_dispatch', 'recording', or 'waiting'.
         * @param {object} [options={}] - Optional settings for the mode, e.g., custom questions.
         */
        async function setInteractionMode(mode, options = {}) {
            console.log(`[Teacher] Setting mode to: ${mode}`);
            currentInteractionMode = mode; 
            // Use classroomCode in the Firestore path
            const controlRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
            const showStatisticsBtn = document.getElementById('show-statistics-btn');
            const downloadMediaBtn = document.getElementById('download-media-btn');
            const aiTextSummaryBtn = document.getElementById('ai-text-summary-btn');
            const showUnsubmittedStudentsBtn = document.getElementById('show-unsubmitted-students-btn'); // NEW
            const viewQuestionsBtn = document.getElementById('view-questions-btn'); // NEW
            const viewReadingQuestionsBtn = document.getElementById('view-reading-questions-btn'); // NEW
            const downloadResponsesBtn = document.getElementById('download-responses-btn'); // NEW

            // MODIFIED: Show statistics button for true_false, multiple_choice, and reading_comprehension
            showStatisticsBtn.classList.toggle('hidden', mode !== 'true_false' && mode !== 'multiple_choice' && mode !== 'reading_comprehension');

            // NEW: Show view questions button only for multiple_choice with custom questions
            const hasCustomQuestions = mode === 'multiple_choice' && options.customQuestions && options.customQuestions.length > 0;
            viewQuestionsBtn.classList.toggle('hidden', !hasCustomQuestions);

            // NEW: Show view reading questions button only for reading_comprehension
            viewReadingQuestionsBtn.classList.toggle('hidden', mode !== 'reading_comprehension');
            
            // NEW: Show peer review button only for text_input and drawing modes
            const startPeerReviewBtn = document.getElementById('start-peer-review-btn');
            startPeerReviewBtn.classList.toggle('hidden', mode !== 'text_input' && mode !== 'drawing');
            
            // NEW: Reset peer review button state when starting new interaction
            if (mode !== 'waiting') {
                peerReviewActive = false;
                startPeerReviewBtn.innerHTML = '<i class="fas fa-heart mr-2"></i> é–‹å§‹äº’è©• â¤ï¸';
                document.getElementById('peer-review-stats-container').classList.add('hidden');
                
                // Reset peer review status in Firebase for new interaction
                const peerReviewRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'peerReview');
                setDoc(peerReviewRef, { active: false }).catch(error => {
                    console.error('Error resetting peer review status:', error);
                });
                
                // Clear student voting history for new interaction
                studentVotedWorks.clear();
                
                // Clear saved canvas state for new interaction
                savedCanvasState = null;
            }
            downloadMediaBtn.classList.toggle('hidden', mode !== 'drawing' && mode !== 'recording');
            aiTextSummaryBtn.classList.toggle('hidden', mode !== 'text_input');
            // NEW: Show unsubmitted students button for specific modes
            showUnsubmittedStudentsBtn.classList.toggle('hidden', mode === 'waiting' || mode === 'url_dispatch');
            // NEW: Show download responses button for text_input, multiple_choice with custom questions, and reading_comprehension
            const showDownloadBtn = mode === 'text_input' || (mode === 'multiple_choice' && hasCustomQuestions) || mode === 'reading_comprehension';
            downloadResponsesBtn.classList.toggle('hidden', !showDownloadBtn);


            // NEW: Hide pause button for URL/HTML dispatch modes
            const togglePauseBtn = document.getElementById('toggle-pause-btn');
            togglePauseBtn.classList.toggle('hidden', mode === 'url_dispatch');


            try {
                // Clear previous student responses unless it's a waiting state.
                if (mode !== 'waiting') {
                    const studentsColRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses');
                    const querySnapshot = await getDocs(studentsColRef);
                    const deletePromises = [];
                    querySnapshot.forEach((doc) => {
                        deletePromises.push(deleteDoc(doc.ref));
                    });
                    await Promise.all(deletePromises);
                    console.log("[Teacher] Cleared all previous student responses.");
                    lastSelectedStudentCard = null; // Clear highlight on monitor view
                }

                // Prepare data payload for Firestore.
                const payload = { 
                    active_mode: mode,
                    backgroundImage: teacherUploadedBackgroundImageDataURL || null,
                    teacherId: userId, // Store teacher ID
                    isPaused: isResponsePaused // Use current local pause state
                };

                // MODIFIED: Add combined dispatch settings if in that mode.
                if (mode === 'url_dispatch') {
                    payload.dispatchSettings = dispatchSettings; // Send the entire dispatchSettings object
                } else {
                    payload.dispatchSettings = null; // Clear dispatch settings if not in URL_DISPATCH mode
                }

                // NEW: Add custom multiple choice questions if in that mode.
                // If mode is multiple_choice and options.customQuestions is explicitly null, it means no custom questions.
                if (mode === 'multiple_choice' && options.hasOwnProperty('customQuestions')) {
                    payload.multiple_choice_questions = options.customQuestions;
                } else {
                    payload.multiple_choice_questions = null; // Clear if not multiple_choice mode or if customQuestions not provided
                }
                currentMultipleChoiceQuestions = payload.multiple_choice_questions; // Update global for teacher monitor

                // NEW: Add sequencing settings if in that mode
                if (mode === 'sequencing' && options.question && options.correctOrder) {
                    payload.sequencingSettings = {
                        question: options.question,
                        correctOrder: options.correctOrder
                    };
                } else {
                    payload.sequencingSettings = null;
                }

                // NEW: Add matching settings if in that mode
                if (mode === 'matching' && options.question && options.pairs) {
                    payload.matchingSettings = {
                        question: options.question,
                        pairs: options.pairs
                    };
                } else {
                    payload.matchingSettings = null;
                }

                // NEW: Add reading comprehension data if in that mode
                if (mode === 'reading_comprehension' && options.readingData) {
                    payload.readingComprehensionData = options.readingData;
                } else {
                    payload.readingComprehensionData = null;
                }

                await setDoc(controlRef, payload, { merge: true });

                // Handle student responses listener based on mode
                if (studentResponsesUnsubscribe) {
                    studentResponsesUnsubscribe();
                    studentResponsesUnsubscribe = null;
                }

                if (mode === 'url_dispatch') { // Now handles both URL and HTML
                    // For URL/HTML dispatch, the monitor view shows online students, handled by presence listener.
                    // Clear existing responses display if any.
                    document.getElementById('student-responses-container').innerHTML = '<p class="text-gray-500 text-center col-span-full">æ­£åœ¨ç­‰å¾…å­¸ç”Ÿä½œç­”...</p>';
                } else if (mode === 'waiting') {
                    // When going to 'waiting' mode, ensure the student responses container is cleared
                    // and shows the "waiting" message.
                    document.getElementById('student-responses-container').innerHTML = '<p class="text-gray-500 text-center col-span-full">æ­£åœ¨ç­‰å¾…å­¸ç”Ÿä½œç­”...</p>';
                } else { // For other interaction modes (true_false, multiple_choice, text_input, drawing, recording, quick_answer)
                    listenToStudentSubmissions(mode); // Ensure this listener is active
                }

            } catch (error) {
                console.error("è¨­å®šäº’å‹•æ¨¡å¼æˆ–æ¸…é™¤å­¸ç”Ÿè³‡æ–™å¤±æ•—:", error);
                showMessage("æ“ä½œå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–è¯ç¹«ç®¡ç†å“¡ã€‚", "error");
            }
        }

        /**
         * (Student) Listens for changes in the teacher's interaction mode and switches the student interface accordingly.
         */
        function listenToInteractionMode() {
            // Use classroomCode in the Firestore path
            const controlRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
            // Ensure only one interaction mode listener is active for the student
            if (interactionModeUnsubscribe) interactionModeUnsubscribe(); 

            interactionModeUnsubscribe = onSnapshot(controlRef, async (docSnap) => {
                const studentPauseOverlay = document.getElementById('student-pause-overlay');
                const interactionMultipleChoice = document.getElementById('interaction-multiple-choice'); // Get the MC container

                if (!docSnap.exists()) {
                    // Teacher has ended the class session (control document deleted)
                    console.log("[Student] Teacher has ended the class session.");
                    classroomCode = null; // Clear student's classroom code
                    studentName = null; // Clear student's name
                    document.getElementById('user-id-display').textContent = userId; // Reset user ID display
                    showMessage('è€å¸«å·²çµæŸèª²ç¨‹ï¼Œè«‹é‡æ–°é¸æ“‡è§’è‰²ã€‚', 'info');
                    showView('entry'); // Go back to the initial entry screen
                    // Unsubscribe from student responses and presence if they were active
                    if (studentResponsesUnsubscribe) {
                        studentResponsesUnsubscribe();
                        studentResponsesUnsubscribe = null;
                    }
                    // IMPORTANT: Unsubscribe student's presence listener as well when class ends
                    if (classroomPresenceUnsubscribe) {
                        classroomPresenceUnsubscribe();
                        classroomPresenceUnsubscribe = null;
                    }
                    studentPauseOverlay.classList.add('hidden'); // Hide overlay if class ends
                    currentInteractionMode = null; // Reset global mode for student
                    isResponsePaused = false; // Reset global pause state for student
                    return; // Exit the function as the session is over
                }

                const data = docSnap.data();
                const newMode = data.active_mode || 'waiting';
                const newIsResponsePaused = data.isPaused || false;
                const newBackgroundImage = data.backgroundImage || null;
                const newMultipleChoiceQuestions = data.multiple_choice_questions || null;

                // Determine if the interaction mode itself has changed
                const modeChanged = (currentInteractionMode !== newMode);
                // Determine if the pause state has changed within the same mode
                const pauseStateChanged = (currentInteractionMode === newMode && isResponsePaused !== newIsResponsePaused);
                // Determine if we are resuming from a pause (mode is same, was paused, now not paused)
                const isResumingFromPause = (currentInteractionMode === newMode) && isResponsePaused && !newIsResponsePaused;


                // Update global states *before* acting on them
                currentInteractionMode = newMode;
                isResponsePaused = newIsResponsePaused;
                teacherUploadedBackgroundImageDataURL = newBackgroundImage; // Update teacher background image
                currentMultipleChoiceQuestions = newMultipleChoiceQuestions; // Update custom MC questions


                console.log(`[Student] Detected mode: ${currentInteractionMode}, Paused: ${isResponsePaused}, Mode Changed: ${modeChanged}, pauseStateChanged: ${pauseStateChanged}`);

                if (currentInteractionMode === 'waiting') {
                    showView('studentWaiting');
                    studentPauseOverlay.classList.add('hidden'); // Hide overlay in waiting view
                } else {
                    showView('studentInteraction');

                    // Call showInteractionUI if mode changed OR if this is the first time entering this mode
                    // We determine "first time" by checking if any interaction UI is currently visible
                    const anyUIVisible = Object.values(interactionUIs).some(ui => !ui.classList.contains('hidden'));

                    if (modeChanged || !anyUIVisible) {
                        showInteractionUI(currentInteractionMode, false); // Not resuming from pause if mode changed
                    }
                    // If mode hasn't changed and a UI is already visible, we don't need to call showInteractionUI
                    // This preserves the DOM state (including content) during pause/resume


                    console.log('[Student] Setting pause overlay, isResponsePaused:', isResponsePaused);
                    if (isResponsePaused) {
                        studentPauseOverlay.classList.remove('hidden');
                        toggleStudentInteractionElements(true); // Disable elements if paused
                    } else {
                        studentPauseOverlay.classList.add('hidden');
                        toggleStudentInteractionElements(false); // Enable elements if not paused
                    }

                    // Specific UI updates that need to happen on every snapshot change
                    if (currentInteractionMode === 'drawing') {
                        requestAnimationFrame(() => {
                            // BUG FIX: Only call setupCanvas (which resizes and clears the drawing canvas)
                            // when the mode truly changes to 'drawing'.
                            // On other updates (like pause/resume or background image change),
                            // we only need to reload images and redraw the combined canvas,
                            // preserving the student's existing drawing.
                            if (modeChanged) {
                                setupCanvas();
                            }
                            loadBackgroundImage(); // Reload background in case teacher changed it
                            loadStudentImage();    // Reload student-uploaded image
                            drawCombinedCanvas();  // Redraw all layers
                        });
                    } else if (currentInteractionMode === 'url_dispatch') { // This mode now handles both URL and HTML
                        const currentDispatchSettings = data.dispatchSettings; // Get the combined settings
                        if (currentDispatchSettings) {
                            if (currentDispatchSettings.type === 'url' && currentDispatchSettings.url) {
                                displayDispatchedUrl(currentDispatchSettings);
                            } else if (currentDispatchSettings.type === 'html' && currentDispatchSettings.htmlContent) {
                                displayDispatchedHtml(currentDispatchSettings.htmlContent);
                            }
                        }
                    } else if (currentInteractionMode === 'multiple_choice') { // NEW: Handle custom multiple choice questions
                        await renderMultipleChoiceQuestions(currentMultipleChoiceQuestions);
                        // Apply/remove enlarged-buttons class based on whether custom questions exist
                        if (!currentMultipleChoiceQuestions || currentMultipleChoiceQuestions.length === 0) {
                            interactionMultipleChoice.classList.add('enlarged-buttons');
                        } else {
                            interactionMultipleChoice.classList.remove('enlarged-buttons');
                        }
                    } else if (currentInteractionMode === 'sequencing') {
                        const sequencingSettings = data.sequencingSettings;
                        if (sequencingSettings && modeChanged) {
                            setupSequencingUI(sequencingSettings);
                        }
                    } else if (currentInteractionMode === 'matching') {
                        const matchingSettings = data.matchingSettings;
                        if (matchingSettings && modeChanged) {
                            setupMatchingUI(matchingSettings);
                        }
                    } else if (currentInteractionMode === 'reading_comprehension') {
                        const readingData = data.readingComprehensionData;
                        // Always display if we have data and (mode changed OR resuming from pause OR pause state changed)
                        if (readingData && (modeChanged || isResumingFromPause || pauseStateChanged)) {
                            console.log('[Student] Displaying reading comprehension, modeChanged:', modeChanged, 'isResumingFromPause:', isResumingFromPause, 'pauseStateChanged:', pauseStateChanged);
                            displayReadingComprehensionForStudent(readingData);
                            // Only reset submit button if mode changed (not when resuming from pause)
                            if (modeChanged) {
                                document.getElementById('submit-reading-btn').disabled = false;
                            }
                        }
                    } else if (currentInteractionMode === 'quick_poll') {
                        if (modeChanged) {
                            listenToQuickPollConfig();
                        }
                    }
                }
            }, (error) => {
                console.error("[Student] Error listening to interaction mode:", error);
                // This error might indicate a network issue or permission denied, not necessarily class end.
                // So, keep the student in waiting view or current view, and just show an error.
                showMessage("ç„¡æ³•æ¥æ”¶è€å¸«æŒ‡ä»¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚", "error");
            });
        }
        
        /**
         * (Student) Displays the dispatched URL or YouTube video.
         * @param {object} settings - The URL settings object from Firestore.
         */
        function displayDispatchedUrl(settings) {
            const container = interactionUIs.url_dispatch;
            container.innerHTML = ''; // Clear previous content

            if (settings.isYoutube) {
                const videoId = getYouTubeVideoId(settings.url);
                console.log('YouTube URL:', settings.url, 'Video ID:', videoId); // èª¿è©¦ä¿¡æ¯
                if (videoId) {
                    const embedContainer = document.createElement('div');
                    embedContainer.className = 'youtube-embed-container';
                    
                    // æ·»åŠ è¼‰å…¥ä¸­çš„æç¤º
                    embedContainer.innerHTML = `<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; text-align: center;">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i><br>
                        å½±ç‰‡è¼‰å…¥ä¸­...
                    </div>`;
                    
                    const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&showinfo=0&modestbranding=1`;
                    console.log('Embed URL:', embedUrl); // èª¿è©¦ä¿¡æ¯
                    
                    // å‰µå»ºiframeå…ƒç´ 
                    const iframe = document.createElement('iframe');
                    iframe.src = embedUrl;
                    iframe.frameBorder = '0';
                    iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
                    iframe.allowFullscreen = true;
                    iframe.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;';
                    
                    // è¼‰å…¥å®Œæˆå¾Œç§»é™¤è¼‰å…¥æç¤º
                    iframe.onload = function() {
                        const loadingDiv = embedContainer.querySelector('div');
                        if (loadingDiv) loadingDiv.remove();
                    };
                    
                    // éŒ¯èª¤è™•ç†
                    iframe.onerror = function() {
                        embedContainer.innerHTML = `<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; text-align: center;">
                            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i><br>
                            å½±ç‰‡è¼‰å…¥å¤±æ•—
                        </div>`;
                    };
                    
                    embedContainer.appendChild(iframe);
                    container.appendChild(embedContainer);
                } else {
                    console.error('ç„¡æ•ˆçš„ YouTube ç¶²å€:', settings.url); // èª¿è©¦ä¿¡æ¯
                    container.innerHTML = `<p class="text-red-500">ç„¡æ•ˆçš„ YouTube ç¶²å€ã€‚</p>`;
                }
            } else {
                const card = document.createElement('a');
                card.className = 'url-card';
                card.href = settings.url;
                card.target = '_blank';
                card.rel = 'noopener noreferrer';
                card.innerHTML = `
                    <i class="fas fa-external-link-alt url-card-icon"></i>
                    <p class="url-card-text">è€å¸«åˆ†äº«äº†ä¸€å€‹é€£çµ</p>
                    <p class="url-card-link">${settings.url}</p>
                `;
                container.appendChild(card);
            }
        }

        /**
         * NEW: (Student) Displays the dispatched HTML content in an iframe.
         * @param {string} htmlContent - The HTML content to display.
         */
        function displayDispatchedHtml(htmlContent) {
            const container = interactionUIs.url_dispatch; // Use the same container
            container.innerHTML = ''; // Clear previous content
            
            const iframe = document.createElement('iframe');
            iframe.id = 'html-content-iframe'; // Re-use the ID for consistency if needed, but it's internal to this function now
            iframe.sandbox = 'allow-scripts allow-same-origin allow-popups allow-forms';
            iframe.srcdoc = htmlContent;
            iframe.style.cssText = 'width: 100vw; height: 100vh; margin: 0; padding: 0; border: none; background-color: white; display: block;';
            container.appendChild(iframe);

            // Add status indicator
            const statusIndicator = document.createElement('div');
            statusIndicator.className = 'html-dispatch-indicator';
            statusIndicator.textContent = 'æ•™å¸«æ´¾é€htmlä¸­...';
            container.appendChild(statusIndicator);

            // Apply the specific HTML dispatch container styles to the outer container
            container.style.cssText = 'position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; margin: 0; padding: 0; border: none; overflow: hidden; background-color: white; z-index: 1000;';
        }

        /**
         * Extracts YouTube video ID from various URL formats.
         * @param {string} url - The YouTube URL.
         * @returns {string|null} The video ID or null if not found.
         */
        function getYouTubeVideoId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }


        /**
         * (Student) Submits the answer to Firestore.
         * @param {string | object} answer - The student's answer.
         */
        async function submitAnswer(answer) {
            // NEW: Prevent submission if paused
            if (isResponsePaused) {
                showMessage('è€å¸«å·²æš«åœå›è¦†ï¼Œç„¡æ³•é€å‡ºç­”æ¡ˆã€‚', 'error');
                return;
            }

            if (!studentName || !userId || !classroomCode) {
                console.error("Student name, User ID, or Classroom Code not set. Cannot submit answer.");
                showMessage("å­¸ç”Ÿå§“åã€ç”¨æˆ¶IDæˆ–æ•™å®¤ä»£ç¢¼æœªè¨­å®šï¼Œç„¡æ³•é€å‡ºç­”æ¡ˆã€‚", "error");
                return;
            }
            // Use classroomCode in the Firestore path
            const studentRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses', studentName);
            try {
                 await setDoc(studentRef, { 
                    name: studentName,
                    answer: answer,
                    timestamp: new Date()
                }, { merge: true });
                console.log(`[Student] ${studentName} submitted answer:`, answer);
                showMessage('å›ç­”å·²é€å‡ºï¼', 'success');
            } catch (error) {
                console.error("é€å‡ºç­”æ¡ˆå¤±æ•—:", error);
                showMessage("é€å‡ºç­”æ¡ˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚", "error");
            }
        }
        
        /**
         * (Teacher) Listens for all student submissions and dynamically displays them.
         * @param {string} mode - The current interaction mode, used to determine the answer type.
         */
        function listenToStudentSubmissions(mode) {
             if (studentResponsesUnsubscribe) studentResponsesUnsubscribe();
             
             // Use classroomCode in the Firestore path
             const studentsColRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses');
             const container = document.getElementById('student-responses-container');

             studentResponsesUnsubscribe = onSnapshot(studentsColRef, (querySnapshot) => {
                container.innerHTML = ''; 
                lastSelectedStudentCard = null; 
                
                // REMOVED: document.getElementById('responded-student-count').textContent = querySnapshot.size; 

                if (querySnapshot.empty) {
                    if (mode !== 'url_dispatch') { 
                        container.innerHTML = '<p class="text-gray-500 text-center col-span-full">æ­£åœ¨ç­‰å¾…å­¸ç”Ÿä½œç­”...</p>';
                    }
                    allStudentResponses = [];
                    clearStudentsByAnswerList();
                    return;
                }
                
                let responses = []; 
                querySnapshot.forEach((doc) => {
                    const student = doc.data();
                    responses.push(student);
                    const card = document.createElement('div');
                    card.className = 'student-response-item'; 

                    let answerContentHTML = ''; 
                    
                    if (student.answer === undefined || student.answer === null) {
                        answerContentHTML = `<p class="text-gray-400">å°šæœªä½œç­”</p>`;
                    } else if (mode === 'drawing') {
                        if(String(student.answer).startsWith('data:image')){
                            answerContentHTML = `<img src="${student.answer}" alt="${student.name} çš„ç¹ªåœ–" class="w-full h-auto rounded-md border max-h-32 object-contain cursor-pointer" data-full-image="${student.answer}"/>`;
                        } else {
                            answerContentHTML = `<p class="text-gray-500">ç¹ªåœ–æœªå®Œæˆæˆ–æ ¼å¼éŒ¯èª¤</p>`;
                        }
                    } else if (mode === 'recording') { // New: Handle recording answers
                        if (String(student.answer).startsWith('data:audio')) {
                            answerContentHTML = `<audio controls src="${student.answer}" class="w-full"></audio>`;
                        } else {
                            answerContentHTML = `<p class="text-gray-500">éŒ„éŸ³æœªå®Œæˆæˆ–æ ¼å¼éŒ¯èª¤</p>`;
                        }
                    } else if (mode === 'text_input') {
                        answerContentHTML = `<p class="text-gray-700 whitespace-pre-wrap">${student.answer || '(ç©ºç™½)'}</p>`;
                    } else if (mode === 'multiple_choice' && Array.isArray(student.answer) && currentMultipleChoiceQuestions) {
                        // NEW: Handle custom multiple choice answers
                        answerContentHTML = `<div class="flex flex-col w-full">`;
                        student.answer.forEach((qAns, index) => {
                            const question = currentMultipleChoiceQuestions[qAns.qIndex];
                            if (question) {
                                const isCorrect = (String(qAns.ans) === String(question.correctAnswer));
                                answerContentHTML += `
                                    <div class="mc-question-answer">
                                        <i class="icon fas ${isCorrect ? 'fa-check-circle correct-icon' : 'fa-times-circle incorrect-icon'}"></i>
                                        <span class="question-text">Q${qAns.qIndex + 1}:</span>
                                        <span class="student-choice">${qAns.ans}</span>
                                    </div>
                                `;
                            }
                        });
                        answerContentHTML += `</div>`;
                    }
                    else if (mode === 'quick_answer') {
                        // Handle quick answer results
                        if (student.answer && student.answer.includes('æ¶ç­”æˆåŠŸ')) {
                            answerContentHTML = `<div class="text-center">
                                <i class="fas fa-trophy text-yellow-500 text-4xl mb-2"></i>
                                <p class="text-xl font-bold text-green-600">æ¶ç­”æˆåŠŸï¼</p>
                                <p class="text-lg text-gray-600">ç¬¬ä¸€å</p>
                            </div>`;
                        } else {
                            answerContentHTML = `<p class="text-gray-500">æœªæ¶ç­”æˆ–æ¶ç­”å¤±æ•—</p>`;
                        }
                    }
                    else if (mode === 'sequencing') {
                        // Handle sequencing answers
                        try {
                            const studentOrder = JSON.parse(student.answer);
                            const correctOrder = sequencingData.correctOrder;
                            let isCorrect = true;

                            answerContentHTML = `<div class="flex flex-col w-full gap-1">`;
                            studentOrder.forEach((item, index) => {
                                const correct = correctOrder[index] === item;
                                if (!correct) isCorrect = false;
                                answerContentHTML += `
                                    <div class="flex items-center gap-2 text-sm">
                                        <i class="fas ${correct ? 'fa-check-circle text-green-500' : 'fa-times-circle text-red-500'}"></i>
                                        <span class="font-bold">${index + 1}.</span>
                                        <span>${item}</span>
                                    </div>
                                `;
                            });
                            answerContentHTML += `</div>`;
                        } catch (e) {
                            answerContentHTML = `<p class="text-gray-500">ç­”æ¡ˆæ ¼å¼éŒ¯èª¤</p>`;
                        }
                    }
                    else if (mode === 'matching') {
                        // Handle matching answers
                        try {
                            const studentMatches = JSON.parse(student.answer);
                            const correctPairs = matchingData.pairs;
                            let correctCount = 0;

                            answerContentHTML = `<div class="flex flex-col w-full gap-1">`;
                            studentMatches.forEach(match => {
                                const correctPair = correctPairs.find(p => p.left === match.left);
                                const isCorrect = correctPair && correctPair.right === match.right;
                                if (isCorrect) correctCount++;

                                answerContentHTML += `
                                    <div class="flex items-center gap-2 text-xs">
                                        <i class="fas ${isCorrect ? 'fa-check-circle text-green-500' : 'fa-times-circle text-red-500'}"></i>
                                        <span>${match.left}</span>
                                        <i class="fas fa-arrow-right text-gray-400"></i>
                                        <span>${match.right}</span>
                                    </div>
                                `;
                            });
                            answerContentHTML += `<div class="text-xs text-gray-600 mt-1">æ­£ç¢º: ${correctCount}/${studentMatches.length}</div></div>`;
                        } catch (e) {
                            answerContentHTML = `<p class="text-gray-500">ç­”æ¡ˆæ ¼å¼éŒ¯èª¤</p>`;
                        }
                    }
                    else if (mode === 'reading_comprehension') {
                        // Handle reading comprehension answers
                        try {
                            const studentAnswers = JSON.parse(student.answer);
                            const questions = readingComprehensionData.questions;
                            let correctCount = 0;

                            answerContentHTML = `<div class="flex flex-col w-full" style="font-size: 10px; gap: 1px;">`;
                            studentAnswers.forEach((ans, index) => {
                                if (questions[index]) {
                                    const isCorrect = (ans === questions[index].correctAnswer);
                                    if (isCorrect) correctCount++;

                                    answerContentHTML += `
                                        <div class="flex items-center whitespace-nowrap" style="gap: 4px; line-height: 1.3;">
                                            <i class="fas ${isCorrect ? 'fa-check-circle text-green-500' : 'fa-times-circle text-red-500'}" style="font-size: 11px;"></i>
                                            <span class="font-bold" style="min-width: 22px;">Q${index + 1}</span>
                                            <span class="text-gray-700" style="min-width: 32px;">ç­”:${ans || 'æœª'}</span>
                                            ${!isCorrect && ans > 0 ? `<span class="text-gray-500" style="font-size: 9px;">(æ­£ç¢º:${questions[index].correctAnswer})</span>` : ''}
                                        </div>
                                    `;
                                }
                            });
                            answerContentHTML += `<div class="font-bold mt-1 pt-1 border-t ${correctCount === questions.length ? 'text-green-600' : 'text-gray-700'}" style="font-size: 10px;">æ­£ç¢º: ${correctCount}/${questions.length}</div></div>`;
                        } catch (e) {
                            answerContentHTML = `<p class="text-gray-500">ç­”æ¡ˆæ ¼å¼éŒ¯èª¤</p>`;
                        }
                    }
                    else { // Default multiple choice (1-4)
                        answerContentHTML = `<p class="text-2xl font-bold text-blue-600">${student.answer}</p>`;
                    }
                    
                    card.innerHTML = `
                        <div class="name-box">${student.name}</div>
                        <div class="answer-box">
                            ${answerContentHTML}
                        </div>
                    `;
                    container.appendChild(card);

                    if (mode === 'drawing') {
                        const imgElement = card.querySelector('.answer-box img');
                        if (imgElement) {
                            imgElement.addEventListener('click', (e) => {
                                const fullImageUrl = e.target.dataset.fullImage;
                                showMagnifiedDrawing(fullImageUrl);
                            });
                        }
                    }
                });

                allStudentResponses = responses;

                // Special handling for quick answer mode
                if (mode === 'quick_answer') {
                    console.log('Teacher: Processing quick answer responses:', responses);
                    const quickAnswerWinners = responses.filter(student =>
                        student.answer && student.answer.includes('æ¶ç­”æˆåŠŸ')
                    );
                    console.log('Teacher: Quick answer winners found:', quickAnswerWinners);

                    if (quickAnswerWinners.length > 0) {
                        const winner = quickAnswerWinners[0]; // First one to answer
                        console.log('Teacher: Showing winner:', winner.name);
                        showQuickAnswerWinner(winner.name);
                    }
                }

                if (!statisticsModal.classList.contains('hidden')) {
                    drawChart(allStudentResponses, currentInteractionMode);
                }
             }, (error) => {
                 console.error("[Teacher] Error listening to student submissions:", error);
                 showMessage("ç„¡æ³•ç›£è½å­¸ç”Ÿä½œç­”ï¼Œè«‹æª¢æŸ¥é€£ç·šã€‚", "error");
             });
        }

        /**
         * (Teacher) Listens for student online presence and updates the active student count list.
         * This listener should be persistent as long as the teacher is in the classroom.
         */
        function listenToClassroomPresence() {
            // Only set up the listener if it's not already active
            if (classroomPresenceUnsubscribe) {
                console.log("Presence listener already active. Skipping re-subscription.");
                return;
            }

            if (!classroomCode) {
                console.warn("Classroom code not set, cannot listen to presence.");
                return;
            }

            const presenceColRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'presence');
            const activeStudentCountSpan = document.getElementById('active-student-count');
            const modalStudentNamesDiv = document.getElementById('modal-student-names');
            const monitorContainer = document.getElementById('student-responses-container');

            classroomPresenceUnsubscribe = onSnapshot(presenceColRef, (querySnapshot) => {
                activeStudentNames = []; // Clear and re-populate
                querySnapshot.forEach(doc => {
                    activeStudentNames.push(doc.data().name);
                });
                
                activeStudentCountSpan.textContent = activeStudentNames.length;

                // Update the student list modal.
                modalStudentNamesDiv.innerHTML = ''; 
                if (lastSelectedModalStudent) { // Clear highlight in modal when list rebuilds
                    lastSelectedModalStudent.classList.remove('modal-selected-student-border');
                    lastSelectedModalStudent = null;
                }

                if (activeStudentNames.length === 0) {
                    modalStudentNamesDiv.innerHTML = '<p class="text-gray-500 text-sm col-span-full">æ²’æœ‰å­¸ç”Ÿåœ¨ç·š</p>';
                } else {
                    activeStudentNames.sort().forEach(name => {
                        const p = document.createElement('p');
                        p.textContent = name;
                        modalStudentNamesDiv.appendChild(p);
                    });
                }

                // Dynamically update the monitor view if in URL/HTML dispatch mode
                if (currentInteractionMode === 'url_dispatch') { 
                    monitorContainer.innerHTML = ''; // Clear previous content
                    if (activeStudentNames.length === 0) {
                        monitorContainer.innerHTML = '<p class="text-gray-500 text-center col-span-full">æ²’æœ‰å­¸ç”Ÿåœ¨ç·š</p>';
                    } else {
                        activeStudentNames.sort().forEach(name => {
                            const card = document.createElement('div');
                            card.className = 'student-response-item';
                            card.innerHTML = `<div class="name-box">${name}</div><div class="answer-box"><i class="fas fa-check-circle text-green-500 text-2xl"></i></div>`;
                            monitorContainer.appendChild(card);
                        });
                    }
                }
            }, (error) => {
                console.error("[Teacher] Error listening to classroom presence:", error);
                // If there's an error, maybe the listener broke, so clear it.
                classroomPresenceUnsubscribe = null;
                showMessage("ç„¡æ³•ç›£è½å­¸ç”Ÿåœ¨ç·šç‹€æ…‹ï¼Œè«‹æª¢æŸ¥é€£ç·šã€‚", "error");
            });
        }

        /**
         * (Teacher) Manually refreshes the online student count and responded student count.
         */
        async function manualRefreshCounts() {
            if (!classroomCode) {
                console.warn("Classroom code not set, cannot manually refresh counts.");
                return;
            }
            // Use classroomCode in the Firestore path
            const presenceColRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'presence');
            try {
                const presenceSnapshot = await getDocs(presenceColRef);
                activeStudentNames = []; // Clear and re-populate
                presenceSnapshot.forEach(doc => activeStudentNames.push(doc.data().name));
                document.getElementById('active-student-count').textContent = activeStudentNames.length;
            } catch (error) {
                console.error("Manual refresh: Failed to get online student count:", error);
            }

            // Use classroomCode in the Firestore path
            const responsesColRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses');
            try {
                const responsesSnapshot = await getDocs(responsesColRef);
                // REMOVED: document.getElementById('responded-student-count').textContent = responsesSnapshot.size;
                
                const responsesData = [];
                responsesSnapshot.forEach(doc => responsesData.push(doc.data()));
                allStudentResponses = responsesData; 

                if (!statisticsModal.classList.contains('hidden')) {
                    drawChart(allStudentResponses, currentInteractionMode);
                }
                showMessage('çµ±è¨ˆæ•¸æ“šå·²æ›´æ–°ï¼', 'info');
            } catch (error) {
                console.error("Manual refresh: Failed to get responded student count:", error);
            }
        }


        // --- Magnified Drawing Modal Functions ---
        const magnifiedImageModal = document.getElementById('magnified-image-modal');
        const magnifiedImage = document.getElementById('magnified-image');
        const magnifiedImageModalCloseBtn = document.getElementById('magnified-image-modal-close-btn');

        function showMagnifiedDrawing(imageUrl) {
            magnifiedImage.src = imageUrl;
            magnifiedImageModal.classList.remove('hidden');
        }

        function hideMagnifiedDrawing() {
            magnifiedImageModal.classList.add('hidden');
            magnifiedImage.src = ''; 
        }

        // --- Student List Modal (Teacher Side) ---
        const studentListModal = document.getElementById('student-list-modal');
        const studentListModalCloseBtn = document.getElementById('student-list-modal-close-btn');

        function showStudentListModal() {
            studentListModal.classList.remove('hidden');
        }

        function hideStudentListModal() {
            studentListModal.classList.add('hidden');
            if (lastSelectedModalStudent) { // Clear highlight in modal when closing
                lastSelectedModalStudent.classList.remove('modal-selected-student-border');
                lastSelectedModalStudent = null;
            }
        }

        // --- NEW: Unsubmitted Students Modal Functions ---
        const unsubmittedStudentsModal = document.getElementById('unsubmitted-students-modal');
        const unsubmittedStudentsModalCloseBtn = document.getElementById('unsubmitted-students-modal-close-btn');
        const modalUnsubmittedStudentNamesDiv = document.getElementById('modal-unsubmitted-student-names');

        /**
         * Calculates the list of students who are active but have not submitted an answer.
         * @param {string[]} activeStudents - Array of names of all active students.
         * @param {Object[]} respondedStudents - Array of response objects from students.
         * @returns {string[]} Sorted array of names of unsubmitted students.
         */
        function getUnsubmittedStudents(activeStudents, respondedStudents) {
            const respondedNames = new Set(respondedStudents.map(s => s.name));
            return activeStudents.filter(name => !respondedNames.has(name)).sort();
        }

        /**
         * Displays the modal with the list of unsubmitted students.
         */
        function showUnsubmittedStudentsModal() {
            const unsubmittedNames = getUnsubmittedStudents(activeStudentNames, allStudentResponses);
            modalUnsubmittedStudentNamesDiv.innerHTML = '';
            if (unsubmittedNames.length === 0) {
                modalUnsubmittedStudentNamesDiv.innerHTML = '<p class="text-gray-500 text-sm col-span-full">æ‰€æœ‰å­¸ç”Ÿçš†å·²ä½œç­”æˆ–ç„¡å­¸ç”Ÿåœ¨ç·š</p>';
            } else {
                unsubmittedNames.forEach(name => {
                    const p = document.createElement('p');
                    p.textContent = name;
                    p.className = 'bg-red-100 p-2 rounded-md text-center text-red-700 font-medium overflow-hidden text-ellipsis whitespace-nowrap';
                    modalUnsubmittedStudentNamesDiv.appendChild(p);
                });
            }
            unsubmittedStudentsModal.classList.remove('hidden');
        }

        /**
         * Hides the unsubmitted students modal.
         */
        function hideUnsubmittedStudentsModal() {
            unsubmittedStudentsModal.classList.add('hidden');
        }


        // --- Statistics Chart Modal (Teacher Side) ---
        const statisticsModal = document.getElementById('statistics-modal');
        const chartModalCloseBtn = document.getElementById('chart-modal-close-btn');
        const chartSvg = d3.select("#chart-svg");
        const studentsByAnswerListContainer = document.getElementById('students-by-answer-list-container');
        const studentsByAnswerListTitle = document.getElementById('students-by-answer-list-title');
        const studentsByAnswerNamesParagraph = document.getElementById('students-by-answer-names');


        function showStatisticsModal() {
            statisticsModal.classList.remove('hidden');
            drawChart(allStudentResponses, currentInteractionMode); 
        }

        function hideStatisticsModal() {
            statisticsModal.classList.add('hidden');
            chartSvg.selectAll("*").remove();
            clearStudentsByAnswerList();
        }

        function downloadStudentResponses() {
            if (!allStudentResponses || allStudentResponses.length === 0) {
                showMessage('ç›®å‰æ²’æœ‰å­¸ç”Ÿå›æ‡‰å¯ä»¥ä¸‹è¼‰ã€‚', 'warning');
                return;
            }

            let csvData = [];
            let filename = '';
            
            if (currentInteractionMode === 'text_input') {
                // æ–‡å­—é¡Œæ¨¡å¼
                csvData.push('å­¸ç”Ÿå§“å,å­¸ç”Ÿå›æ‡‰');
                
                allStudentResponses.forEach(student => {
                    const studentName = student.name || 'æœªçŸ¥å­¸ç”Ÿ';
                    let responseText = student.answer || '';
                    
                    // æ¸…ç†å›æ‡‰æ–‡å­—ä¸­çš„æ›è¡Œç¬¦è™Ÿå’Œé›™å¼•è™Ÿï¼Œé¿å…å½±éŸ¿CSVæ ¼å¼
                    responseText = responseText.replace(/[\r\n]/g, ' ').replace(/"/g, '""');
                    
                    // å¦‚æœå…§å®¹åŒ…å«é€—è™Ÿæˆ–é›™å¼•è™Ÿï¼Œéœ€è¦ç”¨é›™å¼•è™ŸåŒ…åœ
                    if (responseText.includes(',') || responseText.includes('"') || responseText.includes('\n')) {
                        responseText = `"${responseText}"`;
                    }
                    
                    csvData.push(`${studentName},${responseText}`);
                });
                
                const now = new Date();
                const timestamp = now.getFullYear() + 
                                String(now.getMonth() + 1).padStart(2, '0') + 
                                String(now.getDate()).padStart(2, '0') + '_' +
                                String(now.getHours()).padStart(2, '0') + 
                                String(now.getMinutes()).padStart(2, '0') + 
                                String(now.getSeconds()).padStart(2, '0');
                filename = `å­¸ç”Ÿå›æ‡‰_${timestamp}.csv`;
                
            } else if (currentInteractionMode === 'multiple_choice' && currentMultipleChoiceQuestions) {
                // è‡ªè¨‚é¸æ“‡é¡Œæ¨¡å¼
                
                // ç¬¬ä¸€éƒ¨åˆ†ï¼šé¡Œç›®è³‡è¨Š
                csvData.push('=== é¡Œç›®è³‡è¨Š ===');
                csvData.push('é¡Œè™Ÿ,é¡Œç›®å…§å®¹,é¸é …A,é¸é …B,é¸é …C,é¸é …D,æ­£ç¢ºç­”æ¡ˆ');
                
                currentMultipleChoiceQuestions.forEach((question, index) => {
                    const questionText = `"${question.questionText.replace(/"/g, '""')}"`;
                    const optionA = `"${question.options[0].replace(/"/g, '""')}"`;
                    const optionB = `"${question.options[1].replace(/"/g, '""')}"`;
                    const optionC = `"${question.options[2].replace(/"/g, '""')}"`;
                    const optionD = `"${question.options[3].replace(/"/g, '""')}"`;
                    const correctAnswer = `é¸é …${['A', 'B', 'C', 'D'][parseInt(question.correctAnswer) - 1]}`;
                    
                    csvData.push(`ç¬¬${index + 1}é¡Œ,${questionText},${optionA},${optionB},${optionC},${optionD},${correctAnswer}`);
                });
                
                // ç©ºè¡Œåˆ†éš”
                csvData.push('');
                
                // ç¬¬äºŒéƒ¨åˆ†ï¼šå­¸ç”Ÿç­”é¡Œçµæœ
                csvData.push('=== å­¸ç”Ÿç­”é¡Œçµæœ ===');
                
                // å»ºç«‹è¡¨é ­
                let header = 'å­¸ç”Ÿå§“å';
                currentMultipleChoiceQuestions.forEach((_, index) => {
                    header += `,ç¬¬${index + 1}é¡Œç­”æ¡ˆ,ç¬¬${index + 1}é¡Œçµæœ`;
                });
                header += ',ç¸½åˆ†,ç¸½é¡Œæ•¸,æ­£ç¢ºç‡';
                csvData.push(header);
                
                // å»ºç«‹æ¯å€‹å­¸ç”Ÿçš„ç­”é¡Œçµæœ
                allStudentResponses.forEach(student => {
                    const studentName = student.name || 'æœªçŸ¥å­¸ç”Ÿ';
                    let row = studentName;
                    let correctCount = 0;
                    let totalQuestions = currentMultipleChoiceQuestions.length;
                    
                    if (Array.isArray(student.answer)) {
                        // ç‚ºæ¯é¡ŒåŠ å…¥ç­”æ¡ˆå’Œçµæœ
                        currentMultipleChoiceQuestions.forEach((question, questionIndex) => {
                            const studentAnswer = student.answer.find(ans => ans.qIndex === questionIndex);
                            if (studentAnswer) {
                                const answerText = `é¸é …${['A', 'B', 'C', 'D'][parseInt(studentAnswer.ans) - 1]}`;
                                const isCorrect = String(studentAnswer.ans) === String(question.correctAnswer);
                                const result = isCorrect ? 'æ­£ç¢º' : 'éŒ¯èª¤';
                                if (isCorrect) correctCount++;
                                row += `,${answerText},${result}`;
                            } else {
                                row += ',æœªä½œç­”,éŒ¯èª¤';
                            }
                        });
                    } else {
                        // å¦‚æœå­¸ç”Ÿæ²’æœ‰å›ç­”æˆ–æ ¼å¼ä¸æ­£ç¢º
                        currentMultipleChoiceQuestions.forEach(() => {
                            row += ',æœªä½œç­”,éŒ¯èª¤';
                        });
                    }
                    
                    // åŠ å…¥çµ±è¨ˆè³‡è¨Š
                    const accuracy = totalQuestions > 0 ? ((correctCount / totalQuestions) * 100).toFixed(1) : '0.0';
                    row += `,${correctCount},${totalQuestions},${accuracy}%`;
                    
                    csvData.push(row);
                });
                
                const now = new Date();
                const timestamp = now.getFullYear() +
                                String(now.getMonth() + 1).padStart(2, '0') +
                                String(now.getDate()).padStart(2, '0') + '_' +
                                String(now.getHours()).padStart(2, '0') +
                                String(now.getMinutes()).padStart(2, '0') +
                                String(now.getSeconds()).padStart(2, '0');
                filename = `é¸æ“‡é¡Œçµæœ_${timestamp}.csv`;

            } else if (currentInteractionMode === 'reading_comprehension' && readingComprehensionData.questions) {
                // é–±è®€æ¸¬é©—æ¨¡å¼

                // ç¬¬ä¸€éƒ¨åˆ†ï¼šæ–‡æœ¬å…§å®¹
                csvData.push('=== é–±è®€æ–‡æœ¬ ===');
                const readingText = `"${readingComprehensionData.text.replace(/"/g, '""')}"`;
                csvData.push(`æ–‡æœ¬å…§å®¹,${readingText}`);
                csvData.push('');

                // ç¬¬äºŒéƒ¨åˆ†ï¼šé¡Œç›®è³‡è¨Š
                csvData.push('=== é¡Œç›®è³‡è¨Š ===');
                csvData.push('é¡Œè™Ÿ,PIRLSå±¤æ¬¡,é¡Œç›®å…§å®¹,é¸é …1,é¸é …2,é¸é …3,é¸é …4,æ­£ç¢ºç­”æ¡ˆ');

                readingComprehensionData.questions.forEach((question, index) => {
                    const levelNames = ['ç›´æ¥æå–', 'ç›´æ¥æ¨è«–', 'è©®é‡‹æ•´åˆ', 'æ¯”è¼ƒè©•ä¼°'];
                    const levelName = levelNames[question.level - 1] || 'æœªåˆ†é¡';
                    const questionText = `"${question.question.replace(/"/g, '""')}"`;
                    const option1 = `"${question.options[0].replace(/"/g, '""')}"`;
                    const option2 = `"${question.options[1].replace(/"/g, '""')}"`;
                    const option3 = `"${question.options[2].replace(/"/g, '""')}"`;
                    const option4 = `"${question.options[3].replace(/"/g, '""')}"`;
                    const correctAnswer = `é¸é …${question.correctAnswer}`;

                    csvData.push(`ç¬¬${index + 1}é¡Œ,${levelName},${questionText},${option1},${option2},${option3},${option4},${correctAnswer}`);
                });

                // ç©ºè¡Œåˆ†éš”
                csvData.push('');

                // ç¬¬ä¸‰éƒ¨åˆ†ï¼šå­¸ç”Ÿç­”é¡Œçµæœ
                csvData.push('=== å­¸ç”Ÿç­”é¡Œçµæœ ===');

                // å»ºç«‹è¡¨é ­
                let header = 'å­¸ç”Ÿå§“å';
                readingComprehensionData.questions.forEach((_, index) => {
                    header += `,ç¬¬${index + 1}é¡Œç­”æ¡ˆ,ç¬¬${index + 1}é¡Œçµæœ`;
                });
                header += ',ç¸½åˆ†,ç¸½é¡Œæ•¸,æ­£ç¢ºç‡';
                csvData.push(header);

                // å»ºç«‹æ¯å€‹å­¸ç”Ÿçš„ç­”é¡Œçµæœ
                allStudentResponses.forEach(student => {
                    const studentName = student.name || 'æœªçŸ¥å­¸ç”Ÿ';
                    let row = studentName;
                    let correctCount = 0;
                    let totalQuestions = readingComprehensionData.questions.length;

                    try {
                        let studentAnswers = [];
                        if (typeof student.answer === 'string') {
                            studentAnswers = JSON.parse(student.answer);
                        } else if (Array.isArray(student.answer)) {
                            studentAnswers = student.answer;
                        }

                        // ç‚ºæ¯é¡ŒåŠ å…¥ç­”æ¡ˆå’Œçµæœ
                        readingComprehensionData.questions.forEach((question, questionIndex) => {
                            const studentAnswer = studentAnswers[questionIndex];
                            if (studentAnswer && studentAnswer > 0) {
                                const answerText = `é¸é …${studentAnswer}`;
                                const isCorrect = studentAnswer === question.correctAnswer;
                                const result = isCorrect ? 'æ­£ç¢º' : 'éŒ¯èª¤';
                                if (isCorrect) correctCount++;
                                row += `,${answerText},${result}`;
                            } else {
                                row += ',æœªä½œç­”,éŒ¯èª¤';
                            }
                        });
                    } catch (e) {
                        // å¦‚æœè§£æå¤±æ•—ï¼Œå…¨éƒ¨æ¨™è¨˜ç‚ºæœªä½œç­”
                        readingComprehensionData.questions.forEach(() => {
                            row += ',æœªä½œç­”,éŒ¯èª¤';
                        });
                    }

                    // åŠ å…¥çµ±è¨ˆè³‡è¨Š
                    const accuracy = totalQuestions > 0 ? ((correctCount / totalQuestions) * 100).toFixed(1) : '0.0';
                    row += `,${correctCount},${totalQuestions},${accuracy}%`;

                    csvData.push(row);
                });

                const now2 = new Date();
                const timestamp2 = now2.getFullYear() +
                                String(now2.getMonth() + 1).padStart(2, '0') +
                                String(now2.getDate()).padStart(2, '0') + '_' +
                                String(now2.getHours()).padStart(2, '0') +
                                String(now2.getMinutes()).padStart(2, '0') +
                                String(now2.getSeconds()).padStart(2, '0');
                filename = `é–±è®€æ¸¬é©—çµæœ_${timestamp2}.csv`;

            } else {
                showMessage('ç›®å‰æ¨¡å¼ä¸æ”¯æ´ä¸‹è¼‰åŠŸèƒ½ã€‚', 'warning');
                return;
            }

            // å»ºç«‹CSVå…§å®¹
            const csvContent = csvData.join('\n');

            // å»ºç«‹ä¸‹è¼‰é€£çµï¼ŒåŠ ä¸ŠBOMç¢ºä¿æ­£ç¢ºé¡¯ç¤ºä¸­æ–‡
            const bom = '\uFEFF';
            const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showMessage(`å·²ä¸‹è¼‰å­¸ç”Ÿå›æ‡‰æª”æ¡ˆ: ${filename}`, 'success');
        }

        // NEW: View Questions Modal Functions
        function showViewQuestionsModal() {
            if (!currentMultipleChoiceQuestions || currentMultipleChoiceQuestions.length === 0) {
                showMessage('ç›®å‰æ²’æœ‰è‡ªè¨‚é¡Œç›®å¯ä»¥æŸ¥çœ‹ã€‚', 'info');
                return;
            }
            
            const modal = document.getElementById('view-questions-modal');
            const container = document.getElementById('questions-display-container');
            
            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';
            
            // ç”Ÿæˆé¡Œç›®é¡¯ç¤ºHTML
            currentMultipleChoiceQuestions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'bg-gray-50 p-4 rounded-lg border';
                questionDiv.innerHTML = `
                    <h5 class="font-bold text-lg mb-3">ç¬¬ ${index + 1} é¡Œ</h5>
                    <p class="text-gray-800 mb-4">${question.questionText}</p>
                    <div class="space-y-2">
                        <p class="font-medium text-gray-700">é¸é …ï¼š</p>
                        <div class="grid grid-cols-2 gap-2">
                            ${question.options.map((option, optIndex) => 
                                `<div class="p-2 bg-white rounded border text-sm">
                                    ${String.fromCharCode(65 + optIndex)}. ${option}
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ­£ç¢ºç­”æ¡ˆï¼š</label>
                        <select class="correct-answer-select w-full p-2 border rounded" data-question-index="${index}">
                            ${question.options.map((option, optIndex) => {
                                const optionValue = String.fromCharCode(65 + optIndex);
                                const isSelected = question.correctAnswer === optionValue || question.correctAnswer === (optIndex + 1).toString();
                                return `<option value="${optionValue}" ${isSelected ? 'selected' : ''}>${optionValue}. ${option}</option>`;
                            }).join('')}
                        </select>
                    </div>
                `;
                container.appendChild(questionDiv);
            });
            
            modal.classList.remove('hidden');
        }

        function hideViewQuestionsModal() {
            document.getElementById('view-questions-modal').classList.add('hidden');
        }

        async function saveCorrectAnswers() {
            if (!currentMultipleChoiceQuestions || currentMultipleChoiceQuestions.length === 0) {
                showMessage('æ²’æœ‰é¡Œç›®å¯ä»¥å„²å­˜ã€‚', 'error');
                return;
            }
            
            try {
                // æ›´æ–°currentMultipleChoiceQuestionsä¸­çš„æ­£ç¢ºç­”æ¡ˆ
                const selects = document.querySelectorAll('.correct-answer-select');
                selects.forEach(select => {
                    const questionIndex = parseInt(select.getAttribute('data-question-index'));
                    let newCorrectAnswer = select.value;
                    
                    // NEW: å°‡å­—æ¯æ ¼å¼è½‰æ›ç‚ºæ•¸å­—æ ¼å¼ä»¥ä¿æŒä¸€è‡´æ€§
                    if (newCorrectAnswer === 'A') newCorrectAnswer = '1';
                    else if (newCorrectAnswer === 'B') newCorrectAnswer = '2';
                    else if (newCorrectAnswer === 'C') newCorrectAnswer = '3';
                    else if (newCorrectAnswer === 'D') newCorrectAnswer = '4';
                    
                    if (currentMultipleChoiceQuestions[questionIndex]) {
                        currentMultipleChoiceQuestions[questionIndex].correctAnswer = newCorrectAnswer;
                    }
                });
                
                // æ›´æ–°Firestoreä¸­çš„é¡Œç›®è³‡æ–™
                const controlRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
                await updateDoc(controlRef, {
                    multiple_choice_questions: currentMultipleChoiceQuestions
                });
                
                // NEW: ç­‰å¾…ä¸€å°æ®µæ™‚é–“ç¢ºä¿Firestoreæ›´æ–°å®Œæˆï¼Œç„¶å¾Œè§¸ç™¼é‡æ–°æ‰¹æ”¹
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // NEW: è‡ªå‹•é‡æ–°æ‰¹æ”¹æ‰€æœ‰å­¸ç”Ÿå·²æäº¤çš„ç­”æ¡ˆ
                await regradeAllStudentAnswers();
                
                // NEW: ç¢ºä¿æ•™å¸«ç«¯UIä½¿ç”¨æœ€æ–°çš„æ­£ç¢ºç­”æ¡ˆé€²è¡Œæ¸²æŸ“
                // ç”±æ–¼é‡æ–°æ‰¹æ”¹æœƒè§¸ç™¼Firebaseç›£è½å™¨ï¼ŒUIæœƒè‡ªå‹•é‡æ–°æ¸²æŸ“
                
                showMessage('æ­£ç¢ºç­”æ¡ˆå·²æ›´æ–°ä¸¦é‡æ–°æ‰¹æ”¹æ‰€æœ‰ä½œç­”ï¼', 'success');
                hideViewQuestionsModal();
            } catch (error) {
                console.error('æ›´æ–°æ­£ç¢ºç­”æ¡ˆå¤±æ•—:', error);
                showMessage('æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
            }
        }

        // NEW: é‡æ–°æ‰¹æ”¹æ‰€æœ‰å­¸ç”Ÿç­”æ¡ˆçš„å‡½æ•¸
        async function regradeAllStudentAnswers() {
            if (!currentMultipleChoiceQuestions || currentMultipleChoiceQuestions.length === 0) {
                return;
            }

            try {
                const studentsColRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses');
                const querySnapshot = await getDocs(studentsColRef);
                
                const batch = writeBatch(db);
                let regradeCount = 0;

                querySnapshot.forEach((docSnapshot) => {
                    const studentData = docSnapshot.data();
                    
                    // åªè™•ç†é¸æ“‡é¡Œçš„ç­”æ¡ˆï¼ˆArrayæ ¼å¼ï¼‰
                    if (Array.isArray(studentData.answer)) {
                        // æ›´æ–°å­¸ç”Ÿç­”æ¡ˆæ™‚é–“æˆ³ä»¥è§¸ç™¼UIé‡æ–°æ¸²æŸ“ï¼ˆç­”æ¡ˆå…§å®¹ä¿æŒä¸è®Šï¼‰
                        const studentRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses', docSnapshot.id);
                        batch.update(studentRef, {
                            regraded: true,
                            regradeTimestamp: new Date(),
                            timestamp: new Date(), // æ›´æ–°æ™‚é–“æˆ³ä»¥è§¸ç™¼ç›£è½å™¨é‡æ–°è©•åˆ¤ç­”æ¡ˆ
                            forceUpdate: Math.random() // æ·»åŠ éš¨æ©Ÿæ•¸å¼·åˆ¶è§¸ç™¼ç›£è½å™¨
                        });
                        regradeCount++;
                    }
                });

                if (regradeCount > 0) {
                    await batch.commit();
                    console.log(`é‡æ–°æ‰¹æ”¹äº† ${regradeCount} ä½å­¸ç”Ÿçš„ç­”æ¡ˆ`);
                }
            } catch (error) {
                console.error('é‡æ–°æ‰¹æ”¹ç­”æ¡ˆå¤±æ•—:', error);
                throw error;
            }
        }

        function clearStudentsByAnswerList() {
            studentsByAnswerListContainer.classList.add('hidden');
            studentsByAnswerListTitle.textContent = '';
            studentsByAnswerNamesParagraph.textContent = ''; 
        }

        function displayStudentsForAnswer(answer, mode, questionIndex = null) {
            clearStudentsByAnswerList();
            studentsByAnswerListContainer.classList.remove('hidden');

            let filteredStudents;
            let titleText;

            if (mode === 'multiple_choice' && questionIndex !== null && currentMultipleChoiceQuestions) {
                // For custom multiple choice, filter by specific question and correctness
                const question = currentMultipleChoiceQuestions[questionIndex];
                if (!question) {
                    studentsByAnswerListTitle.textContent = `å•é¡Œ ${questionIndex + 1} ä¸å­˜åœ¨ã€‚`;
                    studentsByAnswerNamesParagraph.textContent = '';
                    return;
                }
                
                // 'answer' here is 'correct' or 'incorrect'
                if (answer === 'correct') {
                    filteredStudents = allStudentResponses.filter(s => 
                        Array.isArray(s.answer) && 
                        s.answer.some(q => q.qIndex === questionIndex && String(q.ans) === String(question.correctAnswer))
                    );
                    titleText = `å•é¡Œ ${questionIndex + 1} ç­”å°çš„å­¸ç”Ÿï¼š`;
                } else if (answer === 'incorrect') {
                     filteredStudents = allStudentResponses.filter(s => 
                        Array.isArray(s.answer) && 
                        s.answer.some(q => q.qIndex === questionIndex && String(q.ans) !== String(question.correctAnswer))
                    );
                    titleText = `å•é¡Œ ${questionIndex + 1} ç­”éŒ¯çš„å­¸ç”Ÿï¼š`;
                } else { // Should not happen with current chart logic
                    filteredStudents = [];
                    titleText = `å•é¡Œ ${questionIndex + 1} çš„å­¸ç”Ÿï¼š`;
                }
            } else {
                // For default multiple choice or true/false
                filteredStudents = allStudentResponses.filter(s => s.answer === answer);
                titleText = `é¸æ“‡ã€Œ${answer}ã€çš„å­¸ç”Ÿï¼š`;
            }

            const studentNames = filteredStudents.map(s => s.name).sort(); 
            studentsByAnswerListTitle.textContent = studentNames.length > 0 ? `${titleText} ${studentNames.join(', ')}` : `${titleText} æ²’æœ‰å­¸ç”Ÿé¸æ“‡æ­¤ç­”æ¡ˆã€‚`;
            studentsByAnswerNamesParagraph.textContent = ''; // Clear this as the title now contains names
        }

        function drawChart(responses, mode) { // Changed parameter name from 'data' to 'responses' to avoid conflict
            chartSvg.selectAll("*").remove();
            clearStudentsByAnswerList();

            let chartData = {}; // Renamed 'data' to 'chartData'
            const filteredResponses = responses.filter(r => {
                if (mode === 'true_false' && (r.answer === 'O' || r.answer === 'X')) return true;
                if (mode === 'multiple_choice') {
                    if (currentMultipleChoiceQuestions) { // Custom MC
                        return Array.isArray(r.answer);
                    } else { // Default MC
                        return (r.answer >= '1' && r.answer <= '4');
                    }
                }
                if (mode === 'reading_comprehension') {
                    // Check if answer is a valid JSON array
                    try {
                        const parsed = JSON.parse(r.answer);
                        return Array.isArray(parsed);
                    } catch (e) {
                        return false;
                    }
                }
                return false;
            });

            const totalValidResponses = filteredResponses.length;

            if (totalValidResponses === 0) {
                chartSvg.append("text")
                    .attr("x", chartSvg.attr("width") / 2)
                    .attr("y", chartSvg.attr("height") / 2)
                    .attr("text-anchor", "middle")
                    .style("font-size", "18px")
                    .style("fill", "#666")
                    .text("ç›®å‰æ²’æœ‰ä½œç­”è³‡æ–™ã€‚");
                return;
            }

            if (mode === 'true_false') {
                chartData = { 'O': 0, 'X': 0 }; // Use chartData
                filteredResponses.forEach(r => { chartData[r.answer]++; });
                drawPieChart(chartData, totalValidResponses); // Pass chartData
            } else if (mode === 'multiple_choice') {
                if (currentMultipleChoiceQuestions) { // Custom Multiple Choice Chart
                    drawCustomMultipleChoiceBarChart(filteredResponses, currentMultipleChoiceQuestions);
                } else { // Default Multiple Choice Chart
                    chartData = { '1': 0, '2': 0, '3': 0, '4': 0 }; // Use chartData
                    filteredResponses.forEach(r => { chartData[r.answer]++; });
                    drawBarChart(chartData, totalValidResponses); // Pass chartData
                }
            } else if (mode === 'reading_comprehension') {
                if (readingComprehensionData && readingComprehensionData.questions) {
                    drawReadingComprehensionChart(filteredResponses, readingComprehensionData.questions);
                }
            }
        }

        function drawPieChart(data, totalValidResponses) {
            const width = +chartSvg.attr("width");
            const height = +chartSvg.attr("height");
            const radius = Math.min(width, height) / 2 - 20;
            const g = chartSvg.append("g").attr("transform", `translate(${width / 2},${height / 2})`);
            const color = d3.scaleOrdinal().domain(Object.keys(data)).range(['#16a34a', '#dc2626']); // Green for O, Red for X
            const pie = d3.pie().value(d => d[1]).sort(null);
            const arc = d3.arc().innerRadius(0).outerRadius(radius);
            const arcs = g.selectAll(".arc").data(pie(Object.entries(data))).enter().append("g").attr("class", "arc");

            arcs.append("path")
                .attr("d", arc) 
                .attr("fill", d => color(d.data[0])) 
                .attr("stroke", "white").style("stroke-width", "2px")
                .on("click", (event, d) => displayStudentsForAnswer(d.data[0], 'true_false')); 

            arcs.append("text")
                .attr("transform", d => `translate(${arc.centroid(d)})`)
                .attr("dy", "0.35em")
                .text(d => {
                    const percentage = totalValidResponses > 0 ? ((d.data[1] / totalValidResponses) * 100).toFixed(1) : 0;
                    return `${d.data[0]}: ${d.data[1]} (${percentage}%)`;
                }) 
                .style("font-size", "14px").style("text-anchor", "middle").style("fill", "white");
        }

        function drawBarChart(data, totalValidResponses) {
            const width = +chartSvg.attr("width") - 60;
            const height = +chartSvg.attr("height") - 60;
            const margin = {top: 20, right: 20, bottom: 30, left: 40};
            const x = d3.scaleBand().range([0, width]).padding(0.1).domain(Object.keys(data));
            const y = d3.scaleLinear().range([height, 0]).domain([0, d3.max(Object.values(data)) || 1]); 
            const color = d3.scaleOrdinal().domain(Object.keys(data)).range(['#2563eb', '#ca8a04', '#16a34a', '#dc2626']);
            const g = chartSvg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            g.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x));
            g.append("g").call(d3.axisLeft(y).ticks(Math.min(10, d3.max(Object.values(data)) || 1)).tickFormat(d3.format('d')));

            g.selectAll(".bar").data(Object.entries(data)).enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d[0]) + x.bandwidth() / 2) 
                .attr("y", d => y(d[1])) 
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d[1])) 
                .attr("fill", d => color(d[0]))
                .on("click", (event, d) => displayStudentsForAnswer(d[0], 'multiple_choice')); 
            
            g.selectAll(".bar-label").data(Object.entries(data)).enter().append("text")
                .attr("class", "bar-label")
                .attr("x", d => x(d[0]) + x.bandwidth() / 2) 
                .attr("y", d => y(d[1]) - 5) 
                .attr("text-anchor", "middle").style("font-size", "12px")
                .text(d => {
                    const percentage = totalValidResponses > 0 ? ((d[1] / totalValidResponses) * 100).toFixed(1) : 0;
                    return `${d[1]} (${percentage}%)`;
                }); 
        }

        /**
         * NEW: Draws a bar chart for custom multiple choice questions, showing correctness rate per question.
         * @param {Array} responses - All student responses.
         * @param {Array} questions - The custom multiple choice questions.
         */
        function drawCustomMultipleChoiceBarChart(responses, questions) {
            const width = +chartSvg.attr("width") - 60;
            const height = +chartSvg.attr("height") - 60;
            const margin = {top: 20, right: 20, bottom: 60, left: 40}; // Increased bottom margin for question labels
            
            const questionStats = questions.map((q, qIndex) => {
                let correctCount = 0;
                let answeredCount = 0; // Count students who attempted this question

                responses.forEach(studentResponse => {
                    if (Array.isArray(studentResponse.answer)) {
                        const studentQAnswer = studentResponse.answer.find(ans => ans.qIndex === qIndex);
                        if (studentQAnswer) {
                            answeredCount++;
                            if (String(studentQAnswer.ans) === String(q.correctAnswer)) {
                                correctCount++;
                            }
                        }
                    }
                });
                return {
                    questionIndex: qIndex,
                    questionText: `Q${qIndex + 1}`, // Display as Q1, Q2 etc.
                    correctCount: correctCount,
                    answeredCount: answeredCount,
                    correctRate: answeredCount > 0 ? (correctCount / answeredCount) * 100 : 0
                };
            });

            // Filter out questions with no attempts if desired, or show 0%
            const displayStats = questionStats.filter(s => s.answeredCount > 0);
            if (displayStats.length === 0) {
                chartSvg.append("text")
                    .attr("x", chartSvg.attr("width") / 2)
                    .attr("y", chartSvg.attr("height") / 2)
                    .attr("text-anchor", "middle")
                    .style("font-size", "18px")
                    .style("fill", "#666")
                    .text("ç›®å‰æ²’æœ‰å­¸ç”Ÿä½œç­”ä»»ä½•è‡ªè¨‚é¸æ“‡é¡Œã€‚");
                return;
            }

            const x = d3.scaleBand()
                .range([0, width])
                .padding(0.2)
                .domain(displayStats.map(d => d.questionText));

            const y = d3.scaleLinear()
                .range([height, 0])
                .domain([0, 100]); // Percentage from 0 to 100

            const g = chartSvg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            // X-axis
            g.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "rotate(-45)") // Rotate labels for readability
                .style("text-anchor", "end");

            // Y-axis
            g.append("g")
                .call(d3.axisLeft(y).ticks(10).tickFormat(d => `${d}%`));

            // Bars
            g.selectAll(".bar")
                .data(displayStats)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.questionText))
                .attr("y", d => y(d.correctRate))
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d.correctRate))
                .attr("fill", "#2563eb") // A nice blue color
                .on("click", (event, d) => displayStudentsForAnswer('correct', 'multiple_choice', d.questionIndex)); // Click to show correct students

            // Labels on bars
            g.selectAll(".bar-label")
                .data(displayStats)
                .enter().append("text")
                .attr("class", "bar-label")
                .attr("x", d => x(d.questionText) + x.bandwidth() / 2)
                .attr("y", d => y(d.correctRate) - 5)
                .attr("text-anchor", "middle")
                .style("font-size", "12px")
                .text(d => `${d.correctRate.toFixed(1)}%`);

            // Y-axis label
            g.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("ç­”å°ç‡ (%)");
        }

        /**
         * Draw reading comprehension statistics chart with PIRLS level analysis
         */
        function drawReadingComprehensionChart(responses, questions) {
            const width = +chartSvg.attr("width") - 60;
            const height = +chartSvg.attr("height") - 60;
            const margin = {top: 20, right: 20, bottom: 80, left: 60};

            // Calculate statistics for each question
            const questionStats = questions.map((q, qIndex) => {
                let correctCount = 0;
                let answeredCount = 0;

                responses.forEach(studentResponse => {
                    try {
                        const studentAnswers = JSON.parse(studentResponse.answer);
                        if (Array.isArray(studentAnswers) && studentAnswers[qIndex] !== undefined) {
                            answeredCount++;
                            if (studentAnswers[qIndex] === q.correctAnswer) {
                                correctCount++;
                            }
                        }
                    } catch (e) {
                        // Invalid answer format
                    }
                });

                return {
                    questionIndex: qIndex,
                    questionText: `Q${qIndex + 1}`,
                    level: q.level,
                    correctCount: correctCount,
                    answeredCount: answeredCount,
                    correctRate: answeredCount > 0 ? (correctCount / answeredCount) * 100 : 0
                };
            });

            // Calculate PIRLS level statistics
            const levelStats = [1, 2, 3, 4].map(level => {
                const levelQuestions = questionStats.filter(q => q.level === level);
                if (levelQuestions.length === 0) return null;

                const totalCorrect = levelQuestions.reduce((sum, q) => sum + q.correctCount, 0);
                const totalAnswered = levelQuestions.reduce((sum, q) => sum + q.answeredCount, 0);

                return {
                    level: level,
                    correctRate: totalAnswered > 0 ? (totalCorrect / totalAnswered) * 100 : 0,
                    questionCount: levelQuestions.length
                };
            }).filter(s => s !== null);

            const displayStats = questionStats.filter(s => s.answeredCount > 0);
            if (displayStats.length === 0) {
                chartSvg.append("text")
                    .attr("x", chartSvg.attr("width") / 2)
                    .attr("y", chartSvg.attr("height") / 2)
                    .attr("text-anchor", "middle")
                    .style("font-size", "18px")
                    .style("fill", "#666")
                    .text("ç›®å‰æ²’æœ‰å­¸ç”Ÿä½œç­”é–±è®€æ¸¬é©—ã€‚");
                return;
            }

            const x = d3.scaleBand()
                .range([0, width])
                .padding(0.2)
                .domain(displayStats.map(d => d.questionText));

            const y = d3.scaleLinear()
                .range([height, 0])
                .domain([0, 100]);

            const g = chartSvg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            // Define colors for each PIRLS level
            const levelColors = {
                1: '#3b82f6', // Blue - ç›´æ¥æå–
                2: '#8b5cf6', // Purple - ç›´æ¥æ¨è«–
                3: '#f59e0b', // Amber - è©®é‡‹æ•´åˆ
                4: '#ef4444'  // Red - æ¯”è¼ƒè©•ä¼°
            };

            // X-axis
            g.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "rotate(-45)")
                .style("text-anchor", "end");

            // Y-axis
            g.append("g")
                .call(d3.axisLeft(y).ticks(10).tickFormat(d => `${d}%`));

            // Bars
            g.selectAll(".bar")
                .data(displayStats)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.questionText))
                .attr("y", d => y(d.correctRate))
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d.correctRate))
                .attr("fill", d => levelColors[d.level])
                .style("cursor", "pointer");

            // Labels on bars
            g.selectAll(".bar-label")
                .data(displayStats)
                .enter().append("text")
                .attr("class", "bar-label")
                .attr("x", d => x(d.questionText) + x.bandwidth() / 2)
                .attr("y", d => y(d.correctRate) - 5)
                .attr("text-anchor", "middle")
                .style("font-size", "12px")
                .text(d => `${d.correctRate.toFixed(1)}%`);

            // Y-axis label
            g.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("ç­”å°ç‡ (%)");

            // PIRLS Level Legend and Statistics
            const legendY = height + 50;
            const levelIcons = ['ğŸ“–', 'ğŸ’­', 'ğŸ”—', 'âš–ï¸'];
            const levelTexts = ['ç›´æ¥æå–', 'ç›´æ¥æ¨è«–', 'è©®é‡‹æ•´åˆ', 'æ¯”è¼ƒè©•ä¼°'];

            levelStats.forEach((stat, i) => {
                const legendX = i * 140;

                // Color box
                g.append("rect")
                    .attr("x", legendX)
                    .attr("y", legendY)
                    .attr("width", 15)
                    .attr("height", 15)
                    .attr("fill", levelColors[stat.level]);

                // Text
                g.append("text")
                    .attr("x", legendX + 20)
                    .attr("y", legendY + 12)
                    .style("font-size", "11px")
                    .text(`${levelIcons[i]} L${stat.level}: ${stat.correctRate.toFixed(1)}%`);
            });
        }


        // --- Sequencing Question Logic ---
        function setupSequencingUI(data) {
            const questionText = document.getElementById('sequencing-question-text');
            const container = document.getElementById('sequencing-items-container');

            questionText.textContent = data.question || 'è«‹ä¾ç…§æ­£ç¢ºé †åºæ’åˆ—ä»¥ä¸‹é …ç›®';
            container.innerHTML = '';

            // Shuffle items
            const shuffled = [...data.correctOrder].sort(() => Math.random() - 0.5);

            shuffled.forEach((text, index) => {
                const item = document.createElement('div');
                item.className = 'sequencing-item';
                item.draggable = true;
                item.dataset.text = text;
                item.innerHTML = `
                    <div class="sequencing-item-number">${index + 1}</div>
                    <div class="sequencing-item-text">${text}</div>
                `;

                // Drag events
                item.addEventListener('dragstart', (e) => {
                    item.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });

                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const dragging = document.querySelector('.sequencing-item.dragging');
                    if (dragging && dragging !== item) {
                        const rect = item.getBoundingClientRect();
                        const midY = rect.top + rect.height / 2;
                        if (e.clientY < midY) {
                            container.insertBefore(dragging, item);
                        } else {
                            container.insertBefore(dragging, item.nextSibling);
                        }
                    }
                });

                // Touch events for mobile
                let touchStartY = 0;
                item.addEventListener('touchstart', (e) => {
                    touchStartY = e.touches[0].clientY;
                    item.classList.add('dragging');
                });

                item.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    const target = document.elementFromPoint(touch.clientX, touch.clientY);
                    if (target && target.classList.contains('sequencing-item') && target !== item) {
                        if (touch.clientY < touchStartY) {
                            container.insertBefore(item, target);
                        } else {
                            container.insertBefore(item, target.nextSibling);
                        }
                        touchStartY = touch.clientY;
                    }
                });

                item.addEventListener('touchend', () => {
                    item.classList.remove('dragging');
                });

                container.appendChild(item);
            });

            // Update numbers after any change
            updateSequencingNumbers();
        }

        function updateSequencingNumbers() {
            const items = document.querySelectorAll('.sequencing-item');
            items.forEach((item, index) => {
                const numberDiv = item.querySelector('.sequencing-item-number');
                if (numberDiv) numberDiv.textContent = index + 1;
            });
        }

        // --- Matching Question Logic ---
        function setupMatchingUI(data) {
            const questionText = document.getElementById('matching-question-text');
            const columnA = document.getElementById('matching-column-a');
            const columnB = document.getElementById('matching-column-b');
            const svg = document.getElementById('matching-svg-canvas');

            questionText.textContent = data.question || 'è«‹å°‡å·¦å³å…©å´ç›¸é—œçš„é …ç›®é…å°';
            columnA.innerHTML = '';
            columnB.innerHTML = '';
            svg.innerHTML = '';

            // Shuffle items
            const leftItems = data.pairs.map(p => p.left).sort(() => Math.random() - 0.5);
            const rightItems = data.pairs.map(p => p.right).sort(() => Math.random() - 0.5);

            leftItems.forEach((text, index) => {
                const item = document.createElement('div');
                item.className = 'matching-item';
                item.dataset.side = 'left';
                item.dataset.text = text;
                item.dataset.index = index;
                item.textContent = text;
                item.addEventListener('click', () => handleMatchingClick(item));
                columnA.appendChild(item);
            });

            rightItems.forEach((text, index) => {
                const item = document.createElement('div');
                item.className = 'matching-item';
                item.dataset.side = 'right';
                item.dataset.text = text;
                item.dataset.index = index;
                item.textContent = text;
                item.addEventListener('click', () => handleMatchingClick(item));
                columnB.appendChild(item);
            });
        }

        function handleMatchingClick(item) {
            const side = item.dataset.side;

            if (item.classList.contains('matched')) {
                // Unmatch
                const matchedWith = item.dataset.matchedWith;
                delete item.dataset.matchedWith;
                item.classList.remove('matched');

                // Find and unmatch partner
                const partner = document.querySelector(`.matching-item[data-side="${side === 'left' ? 'right' : 'left'}"][data-text="${matchedWith}"]`);
                if (partner) {
                    delete partner.dataset.matchedWith;
                    partner.classList.remove('matched');
                }

                redrawMatchingLines();
                return;
            }

            if (side === 'left') {
                if (currentMatchingSelection.leftItem === item) {
                    currentMatchingSelection.leftItem.classList.remove('selected');
                    currentMatchingSelection.leftItem = null;
                } else {
                    if (currentMatchingSelection.leftItem) {
                        currentMatchingSelection.leftItem.classList.remove('selected');
                    }
                    currentMatchingSelection.leftItem = item;
                    item.classList.add('selected');
                }
            } else {
                if (currentMatchingSelection.rightItem === item) {
                    currentMatchingSelection.rightItem.classList.remove('selected');
                    currentMatchingSelection.rightItem = null;
                } else {
                    if (currentMatchingSelection.rightItem) {
                        currentMatchingSelection.rightItem.classList.remove('selected');
                    }
                    currentMatchingSelection.rightItem = item;
                    item.classList.add('selected');
                }
            }

            // If both sides selected, create match
            if (currentMatchingSelection.leftItem && currentMatchingSelection.rightItem) {
                const left = currentMatchingSelection.leftItem;
                const right = currentMatchingSelection.rightItem;

                left.classList.remove('selected');
                right.classList.remove('selected');
                left.classList.add('matched');
                right.classList.add('matched');

                left.dataset.matchedWith = right.dataset.text;
                right.dataset.matchedWith = left.dataset.text;

                currentMatchingSelection.leftItem = null;
                currentMatchingSelection.rightItem = null;

                redrawMatchingLines();
            }
        }

        function redrawMatchingLines() {
            const svg = document.getElementById('matching-svg-canvas');
            svg.innerHTML = '';

            const container = document.querySelector('.matching-container');
            const rect = container.getBoundingClientRect();
            svg.setAttribute('width', rect.width);
            svg.setAttribute('height', rect.height);

            document.querySelectorAll('.matching-item.matched[data-side="left"]').forEach(leftItem => {
                const rightText = leftItem.dataset.matchedWith;
                const rightItem = document.querySelector(`.matching-item[data-side="right"][data-text="${rightText}"]`);

                if (rightItem) {
                    const leftRect = leftItem.getBoundingClientRect();
                    const rightRect = rightItem.getBoundingClientRect();

                    const x1 = leftRect.right - rect.left;
                    const y1 = leftRect.top + leftRect.height / 2 - rect.top;
                    const x2 = rightRect.left - rect.left;
                    const y2 = rightRect.top + rightRect.height / 2 - rect.top;

                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    const d = `M ${x1} ${y1} C ${(x1 + x2) / 2} ${y1}, ${(x1 + x2) / 2} ${y2}, ${x2} ${y2}`;
                    line.setAttribute('d', d);
                    line.setAttribute('class', 'matching-line');
                    svg.appendChild(line);
                }
            });
        }

        // --- Drawing Board Logic ---
        function setupCanvas() {
            const canvasElement = document.getElementById('drawing-canvas');
            if (!canvasElement.offsetParent) return; // Don't setup if not visible
            let renderedWidth = canvasElement.clientWidth;
            let renderedHeight = canvasElement.clientHeight;

            canvasElement.width = Math.min(MAX_IMAGE_DIMENSION * 2, Math.max(1, renderedWidth)); 
            canvasElement.height = Math.min(MAX_IMAGE_DIMENSION * 2, Math.max(1, renderedHeight));

            [backgroundCanvas, studentImageCanvas, drawingCanvas].forEach(c => {
                c.width = canvasElement.width;
                c.height = canvasElement.height;
            });

            drawingCtx.lineJoin = 'round';
            drawingCtx.lineCap = 'round';
            drawingCtx.strokeStyle = document.getElementById('color-select').value;
            drawingCtx.lineWidth = parseInt(document.getElementById('size-select').value);
            drawingCtx.globalCompositeOperation = 'source-over';

            // Only clear drawingCanvas if it's a new session, not just a resize within the same session.
            // This is handled by the `resetStudentUIState` function now.
            // For setupCanvas, it's about setting dimensions and initial drawing context properties.
            // The actual clearing should be conditional based on pause state.
            // However, for a fresh setup (e.g., first time entering drawing mode), it should be cleared.
            // The logic in resetStudentUIState is responsible for this.
            // So, here, we just ensure the canvases are ready.
            backgroundCtx.fillStyle = 'white';
            backgroundCtx.fillRect(0, 0, backgroundCanvas.width, backgroundCanvas.height);
            studentImageCtx.clearRect(0, 0, studentImageCanvas.width, studentImageCanvas.height);
        }

        function loadBackgroundImage() {
            backgroundCtx.clearRect(0, 0, backgroundCanvas.width, backgroundCanvas.height);
            backgroundCtx.fillStyle = 'white';
            backgroundCtx.fillRect(0, 0, backgroundCanvas.width, backgroundCanvas.height);

            if (teacherUploadedBackgroundImageDataURL) {
                const tempImg = new Image();
                tempImg.onload = () => {
                    const canvasRatio = backgroundCanvas.width / backgroundCanvas.height;
                    const imgRatio = tempImg.width / tempImg.height;
                    let drawWidth, drawHeight, offsetX, offsetY;
                    if (imgRatio > canvasRatio) { 
                        drawHeight = backgroundCanvas.width / imgRatio;
                        drawWidth = backgroundCanvas.width;
                        offsetY = (backgroundCanvas.height - drawHeight) / 2;
                        offsetX = 0;
                    } else { 
                        drawWidth = backgroundCanvas.height * imgRatio;
                        drawHeight = backgroundCanvas.height;
                        offsetX = (backgroundCanvas.width - drawWidth) / 2;
                        offsetY = 0;
                    }
                    backgroundCtx.drawImage(tempImg, offsetX, offsetY, drawWidth, drawHeight);
                    drawCombinedCanvas();
                };
                tempImg.src = teacherUploadedBackgroundImageDataURL;
            } else {
                drawCombinedCanvas();
            }
        }

        function loadStudentImage() {
            studentImageCtx.clearRect(0, 0, studentImageCanvas.width, studentImageCanvas.height);

            if (studentUploadedImageDataURL) {
                const tempImg = new Image();
                tempImg.onload = () => {
                    const canvasRatio = studentImageCanvas.width / studentImageCanvas.height;
                    const imgRatio = tempImg.width / tempImg.height;
                    let drawWidth, drawHeight, offsetX, offsetY;
                    if (imgRatio > canvasRatio) { 
                        drawHeight = studentImageCanvas.width / imgRatio;
                        drawWidth = studentImageCanvas.width;
                        offsetY = (studentImageCanvas.height - drawHeight) / 2;
                        offsetX = 0;
                    } else { 
                        drawWidth = studentImageCanvas.height * imgRatio;
                        drawHeight = studentImageCanvas.height;
                        offsetX = (studentImageCanvas.width - drawWidth) / 2;
                        offsetY = 0;
                    }
                    studentImageCtx.drawImage(tempImg, offsetX, offsetY, drawWidth, drawHeight);
                    drawCombinedCanvas();
                };
                tempImg.src = studentUploadedImageDataURL;
            } else {
                drawCombinedCanvas();
            }
        }

        function drawCombinedCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(backgroundCanvas, 0, 0);
            ctx.drawImage(studentImageCanvas, 0, 0);
            ctx.drawImage(drawingCanvas, 0, 0);
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault(); 
            const { offsetX, offsetY } = getMousePos(e); 
            drawingCtx.beginPath();
            drawingCtx.moveTo(lastX, lastY);
            drawingCtx.lineTo(offsetX, offsetY);
            drawingCtx.stroke();
            [lastX, lastY] = [offsetX, offsetY];
            drawCombinedCanvas();
        }

        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect(); 
            let clientX = e.touches ? e.touches[0].clientX : e.clientX;
            let clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const rawOffsetX = clientX - rect.left;
            const rawOffsetY = clientY - rect.top;
            const scaleX = canvas.width / rect.width; 
            const scaleY = canvas.height / rect.height;
            return { offsetX: rawOffsetX * scaleX, offsetY: rawOffsetY * scaleY };
        }
        
        function startDrawing(e) {
            isDrawing = true;
            const { offsetX, offsetY } = getMousePos(e); 
            [lastX, lastY] = [offsetX, offsetY];
        }

        function stopDrawing() { isDrawing = false; }
        
        function clearDrawingCanvas() {
            drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            drawCombinedCanvas();
        }

        function updateColorSwatch(color) {
            const swatch = document.getElementById('current-color-swatch');
            if (swatch) swatch.style.backgroundColor = color;
        }
        
        // --- AI Settings Modal Functions ---
        const aiSettingsModal = document.getElementById('ai-settings-modal');
        const aiSettingsModalCloseBtn = document.getElementById('ai-settings-modal-close-btn');
        const aiSourceSelect = document.getElementById('ai-source-select');
        const geminiApiKeyGroup = document.getElementById('gemini-api-key-group');
        const geminiApiKeyInput = document.getElementById('gemini-api-key-input');
        const saveAiSettingsBtn = document.getElementById('save-ai-settings-btn');

        function showAISettingsModal() {
            aiSourceSelect.value = aiSettings.aiSource;
            geminiApiKeyInput.value = aiSettings.geminiApiKey;
            geminiApiKeyGroup.classList.toggle('hidden', aiSettings.aiSource !== 'gemini-custom');
            aiSettingsModal.classList.remove('hidden');
        }

        function hideAISettingsModal() {
            aiSettingsModal.classList.add('hidden');
        }

        function saveAISettings() {
            aiSettings.aiSource = aiSourceSelect.value;
            aiSettings.geminiApiKey = geminiApiKeyInput.value.trim();
            localStorage.setItem('aiSettings', JSON.stringify(aiSettings));
            showMessage('AI è¨­å®šå·²å„²å­˜ï¼', 'success');
            hideAISettingsModal();
        }

        function loadAISettings() {
            const savedSettings = localStorage.getItem('aiSettings');
            if (savedSettings) {
                try {
                    const parsedSettings = JSON.parse(savedSettings);
                    if (parsedSettings.aiSource) aiSettings.aiSource = parsedSettings.aiSource;
                    // MODIFIED: If geminiApiKey is empty after loading, set default.
                    aiSettings.geminiApiKey = parsedSettings.geminiApiKey || '12345678'; 
                } catch (e) {
                    console.error("Failed to parse AI settings from localStorage:", e);
                    // If parsing fails, set default API key
                    aiSettings.geminiApiKey = '12345678';
                }
            } else {
                // If no settings are saved at all, set default API key
                aiSettings.geminiApiKey = '12345678';
            }
        }

        // --- New: URL/HTML Dispatch Settings Modal Functions (Combined) ---
        const urlDispatchModal = document.getElementById('url-dispatch-settings-modal');
        const urlDispatchModalCloseBtn = document.getElementById('url-dispatch-settings-modal-close-btn');
        
        const urlDispatchSection = document.getElementById('url-dispatch-section');
        const htmlDispatchSection = document.getElementById('html-dispatch-section');
        const dispatchTypeRadios = document.querySelectorAll('input[name="dispatchType"]');

        const urlInput = document.getElementById('dispatch-url-input');
        const isYoutubeCheckbox = document.getElementById('is-youtube-checkbox');
        
        const dispatchHtmlUploadInput = document.getElementById('dispatch-html-upload-input');
        const clearDispatchHtmlBtn = document.getElementById('clear-dispatch-html-btn');
        const dispatchHtmlStatus = document.getElementById('dispatch-html-status');

        function showUrlDispatchSettingsModal() {
            // Set radio button based on current dispatchSettings.type
            document.querySelector(`input[name="dispatchType"][value="${dispatchSettings.type}"]`).checked = true;
            
            // Show/hide sections based on type
            urlDispatchSection.classList.toggle('hidden', dispatchSettings.type === 'html');
            htmlDispatchSection.classList.toggle('hidden', dispatchSettings.type === 'url');

            // Populate URL fields
            urlInput.value = dispatchSettings.url;
            isYoutubeCheckbox.checked = dispatchSettings.isYoutube;

            // Update HTML status
            dispatchHtmlStatus.textContent = dispatchSettings.htmlContent ? 'å·²ä¸Šå‚³ HTML æª”æ¡ˆã€‚' : 'ç›®å‰æ²’æœ‰ HTML æª”æ¡ˆã€‚';

            urlDispatchModal.classList.remove('hidden');
        }

        function hideUrlDispatchSettingsModal() {
            urlDispatchModal.classList.add('hidden');
        }

        function saveDispatchSettings() { // Renamed from saveUrlDispatchSettings
            dispatchSettings.type = document.querySelector('input[name="dispatchType"]:checked').value;

            if (dispatchSettings.type === 'url') {
                dispatchSettings.url = urlInput.value.trim();
                dispatchSettings.isYoutube = isYoutubeCheckbox.checked;
                dispatchSettings.htmlContent = null; // Clear HTML content if switching to URL
            } else { // type === 'html'
                // htmlContent is updated via handleHtmlFile or clearDispatchHtml
                dispatchSettings.url = ''; // Clear URL if switching to HTML
                dispatchSettings.isYoutube = false; // Clear YouTube flag
            }
            
            localStorage.setItem('dispatchSettings', JSON.stringify(dispatchSettings));
            showMessage('æ´¾é€è¨­å®šå·²å„²å­˜ï¼', 'success');
            hideUrlDispatchSettingsModal();
        }

        function clearDispatchSettings() { // Renamed from clearUrlDispatchSettings
            urlInput.value = '';
            isYoutubeCheckbox.checked = false;
            dispatchHtmlUploadInput.value = ''; // Clear file input
            dispatchHtmlStatus.textContent = 'ç›®å‰æ²’æœ‰ HTML æª”æ¡ˆã€‚';

            dispatchSettings = { type: 'url', url: '', isYoutube: false, htmlContent: null }; // Reset global variable
            localStorage.removeItem('dispatchSettings'); // Clear from localStorage
            
            // Reset UI to default (URL selected)
            document.querySelector('input[name="dispatchType"][value="url"]').checked = true;
            urlDispatchSection.classList.remove('hidden');
            htmlDispatchSection.classList.add('hidden');
        }

        function loadDispatchSettings() { // Renamed from loadUrlDispatchSettings
            const savedSettings = localStorage.getItem('dispatchSettings');
            if (savedSettings) {
                try {
                    const parsedSettings = JSON.parse(savedSettings);
                    // Ensure all properties are set, even if null in saved data
                    dispatchSettings.type = parsedSettings.type || 'url';
                    dispatchSettings.url = parsedSettings.url || '';
                    dispatchSettings.isYoutube = parsedSettings.isYoutube || false;
                    dispatchSettings.htmlContent = parsedSettings.htmlContent || null;
                } catch (e) {
                    console.error("Failed to parse dispatch settings from localStorage:", e);
                    // Reset to default if parsing fails
                    dispatchSettings = { type: 'url', url: '', isYoutube: false, htmlContent: null };
                }
            }
        }

        /**
         * NEW: Handles HTML file upload within the combined dispatch settings modal.
         * @param {File} file - The HTML file to process.
         */
        function handleDispatchHtmlFile(file) {
            if (!file || !file.type.includes('html')) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                dispatchSettings.htmlContent = event.target.result; // Update global state
                dispatchHtmlStatus.textContent = `å·²ä¸Šå‚³æª”æ¡ˆ: ${file.name}`;
                showMessage('HTML æª”æ¡ˆå·²ä¸Šå‚³ï¼', 'success');
            };
            reader.readAsText(file);
        }


        // --- New: Recording Functions (Student Side) ---
        const startRecordingBtn = document.getElementById('start-recording-btn');
        const stopRecordingBtn = document.getElementById('stop-recording-btn');
        const playRecordingBtn = document.getElementById('play-recording-btn');
        const resetRecordingBtn = document.getElementById('reset-recording-btn');
        const submitRecordingBtn = document.getElementById('submit-recording-btn');
        const audioPreview = document.getElementById('audio-preview');
        const recordingStatusText = document.getElementById('recording-status-text');
        const recordingStatusIcon = document.getElementById('recording-status-icon');

        /**
         * Starts the audio recording process.
         */
        async function startRecording() {
            try {
                // Request access to microphone
                audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Try to use audio/wav first for better iOS compatibility.
                // Fallback to audio/webm if wav is not supported.
                let mimeType = 'audio/webm';
                if (MediaRecorder.isTypeSupported('audio/wav')) {
                    mimeType = 'audio/wav';
                } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
                    mimeType = 'audio/mp4'; // Another common format
                } else if (MediaRecorder.isTypeSupported('audio/ogg')) {
                    mimeType = 'audio/ogg';
                }

                mediaRecorder = new MediaRecorder(audioStream, { mimeType: mimeType });
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType }); // Use the actual mimeType recorded
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        audioDataURL = reader.result;
                        audioPreview.src = audioDataURL;
                        audioPreview.classList.remove('hidden');
                        playRecordingBtn.disabled = false;
                        resetRecordingBtn.disabled = false;
                        submitRecordingBtn.disabled = false;
                        recordingStatusText.textContent = 'éŒ„éŸ³å®Œæˆï¼Œå¯è©¦è½æˆ–é€å‡º';
                        recordingStatusIcon.classList.remove('fa-spin', 'text-red-500');
                        recordingStatusIcon.classList.add('text-green-500');
                    };
                    reader.readAsDataURL(audioBlob);

                    // Stop all tracks to release microphone
                    audioStream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                startRecordingBtn.disabled = true;
                stopRecordingBtn.disabled = false;
                playRecordingBtn.disabled = true;
                resetRecordingBtn.disabled = true;
                submitRecordingBtn.disabled = true;
                recordingStatusText.textContent = 'æ­£åœ¨éŒ„éŸ³...';
                recordingStatusIcon.classList.remove('text-gray-400');
                recordingStatusIcon.classList.add('fa-spin', 'text-red-500');
                showMessage('é–‹å§‹éŒ„éŸ³', 'info');
            } catch (err) {
                console.error('ç„¡æ³•å–å¾—éº¥å…‹é¢¨æ¬Šé™:', err);
                showMessage('ç„¡æ³•å–å¾—éº¥å…‹é¢¨æ¬Šé™ï¼Œè«‹æª¢æŸ¥è¨­å®šã€‚', 'error');
                // Reset buttons if permission fails
                startRecordingBtn.disabled = false;
                stopRecordingBtn.disabled = true;
                playRecordingBtn.disabled = true;
                resetRecordingBtn.disabled = true;
                submitRecordingBtn.disabled = true;
                recordingStatusText.textContent = 'éŒ„éŸ³å¤±æ•—';
                recordingStatusIcon.classList.remove('fa-spin', 'text-red-500');
                recordingStatusIcon.classList.add('text-gray-400');
            }
        }

        /**
         * Stops the audio recording.
         */
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                stopRecordingBtn.disabled = true;
            }
        }

        /**
         * Plays the recorded audio.
         */
        function playRecording() {
            if (audioPreview.src) {
                audioPreview.play();
                showMessage('æ­£åœ¨æ’­æ”¾éŒ„éŸ³', 'info');
            } else {
                showMessage('æ²’æœ‰å¯æ’­æ”¾çš„éŒ„éŸ³', 'info');
            }
        }

        /**
         * Resets the recording state, allowing for a new recording.
         */
        function resetRecording() {
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
            }
            audioChunks = [];
            audioBlob = null;
            audioDataURL = null;
            audioPreview.src = '';
            audioPreview.classList.add('hidden');

            startRecordingBtn.disabled = false;
            stopRecordingBtn.disabled = true;
            playRecordingBtn.disabled = true;
            resetRecordingBtn.disabled = true;
            submitRecordingBtn.disabled = true;
            recordingStatusText.textContent = 'æº–å‚™éŒ„éŸ³...';
            recordingStatusIcon.classList.remove('fa-spin', 'text-red-500', 'text-green-500');
            recordingStatusIcon.classList.add('text-gray-400');
            showMessage('éŒ„éŸ³å·²é‡ç½®', 'info');
        }

        // --- End Recording Functions ---

        /**
         * (Teacher) Ends the entire class session, clears all student data and presence for the current classroom code.
         */
        async function endClassSession() {
            markClassEnded(); // Mark that class has been properly ended
            clearAllQuestionBanks(); // Clear question banks from memory
            showMessage('æ­£åœ¨çµæŸèª²ç¨‹ä¸¦æ¸…ç©ºè³‡æ–™...', 'info');

            if (interactionModeUnsubscribe) interactionModeUnsubscribe();
            if (studentResponsesUnsubscribe) studentResponsesUnsubscribe();
            if (classroomPresenceUnsubscribe) { // Only unsubscribe presence here
                classroomPresenceUnsubscribe();
                classroomPresenceUnsubscribe = null;
            }
            interactionModeUnsubscribe = studentResponsesUnsubscribe = null; // Reset others

            try {
                // Delete the entire classroom subcollection for the current classroomCode
                if (classroomCode) {
                    const classroomRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses');
                    const responsesSnapshot = await getDocs(classroomRef);
                    for (const doc of responsesSnapshot.docs) {
                        await deleteDoc(doc.ref);
                    }

                    const presenceRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'presence');
                    const presenceSnapshot = await getDocs(presenceRef);
                    for (const doc of presenceSnapshot.docs) {
                        await deleteDoc(doc.ref);
                    }

                    const settingsDocRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
                    await deleteDoc(settingsDocRef); // Delete the control document
                    
                    console.log(`[Teacher] Cleared all data for classroom: ${classroomCode}`);
                }
                
                classroomCode = null; // Clear the classroom code after ending session
                localStorage.removeItem('teacherClassroomCode'); // Clear from local storage

                studentName = null;
                currentRole = null;
                currentInteractionMode = null;
                allStudentResponses = [];
                activeStudentNames = []; // NEW: Clear active student names
                lastSelectedStudentCard = null;
                lastSelectedModalStudent = null; // NEW: Clear modal lottery highlight
                isResponsePaused = false; // NEW: Reset pause state
                currentMultipleChoiceQuestions = null; // NEW: Clear custom MC questions

                document.getElementById('student-responses-container').innerHTML = '<p class="text-gray-500 text-center col-span-full">æ­£åœ¨ç­‰å¾…å­¸ç”Ÿä½œç­”...</p>';
                document.getElementById('active-student-count').textContent = '0';
                // REMOVED: document.getElementById('responded-student-count').textContent = '0';
                document.getElementById('teacher-image-status').textContent = 'ç›®å‰æ²’æœ‰èƒŒæ™¯åœ–ç‰‡ã€‚å¯é¸æ“‡æª”æ¡ˆæˆ–ç›´æ¥è²¼ä¸Š(Ctrl+V)ã€‚';
                document.getElementById('teacher-image-preview').src = '';
                document.getElementById('teacher-image-preview-container').classList.add('hidden');

                // Clear URL/HTML dispatch settings and teacher background image when ending interaction
                clearDispatchSettings(); // Use the combined clear function
                teacherUploadedBackgroundImageDataURL = null;
                document.getElementById('teacher-image-status').textContent = 'ç›®å‰æ²’æœ‰èƒŒæ™¯åœ–ç‰‡ã€‚å¯é¸æ“‡æª”æ¡ˆæˆ–ç›´æ¥è²¼ä¸Š(Ctrl+V)ã€‚';
                document.getElementById('teacher-image-preview').src = '';
                document.getElementById('teacher-image-preview-container').classList.add('hidden');
                isResponsePaused = false; // NEW: Reset pause state
                updateTeacherPauseButtonUI(); // NEW: Update pause button UI

                await signOut(auth); // Explicitly sign out the user
                
                // NEW: After signing out, explicitly sign in again to get a fresh authenticated state
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                }
                console.log("Re-authenticated after ending session.");

                showView('entry'); // Show the entry view
                showMessage('èª²ç¨‹å·²çµæŸï¼Œè³‡æ–™å·²æ¸…ç©ºã€‚', 'success');

            } catch (error) {
                console.error("çµæŸèª²ç¨‹ä¸¦æ¸…ç©ºè³‡æ–™å¤±æ•—:", error);
                showMessage("çµæŸèª²ç¨‹å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–è¯ç¹«ç®¡ç†å“¡ã€‚", "error");
            }
        }

        // NEW: Pause/Resume Response Logic
        const togglePauseBtn = document.getElementById('toggle-pause-btn');
        const togglePauseBtnText = document.getElementById('toggle-pause-btn-text');

        /**
         * Toggles the pause state for student responses in Firestore.
         */
        async function toggleResponsePause() {
            if (!classroomCode) {
                showMessage('è«‹å…ˆé–‹å•Ÿä¸€å€‹æ•™å®¤ï¼', 'error');
                return;
            }
            const controlRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
            try {
                isResponsePaused = !isResponsePaused; // Toggle local state
                await setDoc(controlRef, { isPaused: isResponsePaused }, { merge: true });
                showMessage(`å­¸ç”Ÿå›è¦†å·²${isResponsePaused ? 'æš«åœ' : 'æ¢å¾©'}ï¼`, 'info');
                updateTeacherPauseButtonUI();
            } catch (error) {
                console.error("åˆ‡æ›æš«åœå›è¦†ç‹€æ…‹å¤±æ•—:", error);
                showMessage("åˆ‡æ›ç‹€æ…‹å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚", "error");
                isResponsePaused = !isResponsePaused; // Revert local state on error
            }
        }

        /**
         * Updates the teacher's pause button UI based on the `isResponsePaused` state.
         */
        function updateTeacherPauseButtonUI() {
            if (isResponsePaused) {
                togglePauseBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
                togglePauseBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                togglePauseBtnText.textContent = 'æ¢å¾©å›è¦†';
                togglePauseBtn.querySelector('i').classList.replace('fa-pause', 'fa-play');
            } else {
                togglePauseBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                togglePauseBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
                togglePauseBtnText.textContent = 'æš«åœå›è¦†';
                togglePauseBtn.querySelector('i').classList.replace('fa-play', 'fa-pause');
            }
        }


        // --- Event Listeners ---
        
        /**
         * NEW: Processes an image file (from upload or paste), resizes it, and applies it.
         * @param {File} file - The image file to process.
         * @param {boolean} isTeacher - True if the image is for the teacher's background.
         */
        function handleImageFile(file, isTeacher) {
            if (!file || !file.type.startsWith('image/')) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    let { width, height } = img;

                    // Resize image if it's too large
                    if (width > MAX_IMAGE_DIMENSION || height > MAX_IMAGE_DIMENSION) {
                        if (width > height) {
                            height *= MAX_IMAGE_DIMENSION / width;
                            width = MAX_IMAGE_DIMENSION;
                        } else {
                            width *= MAX_IMAGE_DIMENSION / height;
                            height = MAX_IMAGE_DIMENSION;
                        }
                    }
                    tempCanvas.width = width;
                    tempCanvas.height = height;
                    tempCtx.drawImage(img, 0, 0, width, height);
                    const dataUrl = tempCanvas.toDataURL('image/jpeg', JPEG_QUALITY);

                    if (isTeacher) {
                        teacherUploadedBackgroundImageDataURL = dataUrl;
                        // For teacher image, we need to pass statusId, previewId, previewContainerId
                        // These are not directly available in handleImageFile without context.
                        // Let's assume these are passed as arguments or accessed globally.
                        // Re-evaluate how setupImageUpload calls this.
                        document.getElementById('teacher-image-status').textContent = 'å·²ä¸Šå‚³èƒŒæ™¯åœ–ç‰‡ã€‚å¯é¸æ“‡æª”æ¡ˆæˆ–ç›´æ¥è²¼ä¸Š(Ctrl+V)ã€‚';
                        document.getElementById('teacher-image-preview').src = dataUrl;
                        document.getElementById('teacher-image-preview-container').classList.remove('hidden');
                        showMessage('èƒŒæ™¯åœ–ç‰‡å·²ä¸Šå‚³ï¼', 'success');
                    } else {
                        studentUploadedImageDataURL = dataUrl;
                        showMessage('åœ–ç‰‡å·²ä¸Šå‚³ï¼', 'success');
                        loadStudentImage();
                    }
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        /**
         * MODIFIED: Sets up image upload functionality for both file input and pasting.
         */
        const setupImageUpload = (inputId, statusId, previewContainerId, previewId, clearBtnId, isTeacher) => {
            const input = document.getElementById(inputId);
            const clearBtn = document.getElementById(clearBtnId);
            
            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                e.target.value = ''; // Reset input to allow re-uploading the same file
                if (file) {
                    // Pass the IDs to handleImageFile for teacher-specific updates
                    if (isTeacher) {
                        handleImageFileForTeacher(file, statusId, previewContainerId, previewId);
                    } else {
                        handleImageFile(file, isTeacher);
                    }
                }
            });

            clearBtn.addEventListener('click', () => {
                if (isTeacher) {
                    teacherUploadedBackgroundImageDataURL = null;
                    document.getElementById(statusId).textContent = 'ç›®å‰æ²’æœ‰èƒŒæ™¯åœ–ç‰‡ã€‚å¯é¸æ“‡æª”æ¡ˆæˆ–ç›´æ¥è²¼ä¸Š(Ctrl+V)ã€‚';
                    document.getElementById(previewId).src = '';
                    document.getElementById(previewContainerId).classList.add('hidden');
                    showMessage('èƒŒæ™¯åœ–ç‰‡å·²æ¸…é™¤ï¼', 'info');
                } else {
                    studentUploadedImageDataURL = null;
                    studentImageCtx.clearRect(0, 0, studentImageCanvas.width, studentImageCanvas.height);
                    showMessage('åœ–ç‰‡å·²æ¸…é™¤ï¼', 'info');
                    drawCombinedCanvas();
                }
            });
        };

        // NEW: Separate function for teacher image handling to pass specific DOM IDs
        function handleImageFileForTeacher(file, statusId, previewContainerId, previewId) {
            if (!file || !file.type.startsWith('image/')) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    let { width, height } = img;

                    // Resize image if it's too large
                    if (width > MAX_IMAGE_DIMENSION || height > MAX_IMAGE_DIMENSION) {
                        if (width > height) {
                            height *= MAX_IMAGE_DIMENSION / width;
                            width = MAX_IMAGE_DIMENSION;
                        } else {
                            width *= MAX_IMAGE_DIMENSION / height;
                            height = MAX_IMAGE_DIMENSION;
                        }
                    }
                    tempCanvas.width = width;
                    tempCanvas.height = height;
                    tempCtx.drawImage(img, 0, 0, width, height);
                    const dataUrl = tempCanvas.toDataURL('image/jpeg', JPEG_QUALITY);

                    teacherUploadedBackgroundImageDataURL = dataUrl;
                    document.getElementById(statusId).textContent = 'å·²ä¸Šå‚³èƒŒæ™¯åœ–ç‰‡ã€‚å¯é¸æ“‡æª”æ¡ˆæˆ–ç›´æ¥è²¼ä¸Š(Ctrl+V)ã€‚';
                    document.getElementById(previewId).src = dataUrl;
                    document.getElementById(previewContainerId).classList.remove('hidden');
                    showMessage('èƒŒæ™¯åœ–ç‰‡å·²ä¸Šå‚³ï¼', 'success');
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }


        function setupEventListeners() {
            // Entry screen.
            document.getElementById('teacher-entry-btn').addEventListener('click', () => {
                // Check if passwd=no parameter is present in URL
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('passwd') === 'no') {
                    showView('teacherClassroomCode');
                } else {
                    document.getElementById('teacher-password-modal').classList.remove('hidden');
                }
            });
            document.getElementById('student-entry-btn').addEventListener('click', () => {
                currentRole = 'student';
                showView('studentName');
            });

            // NEW: Teacher classroom code input.
            document.getElementById('teacher-classroom-code-back-btn').addEventListener('click', () => showView('entry'));
            document.getElementById('teacher-classroom-code-submit-btn').addEventListener('click', async () => {
                const code = document.getElementById('teacher-classroom-code-input').value.trim();
                if (code) {
                    classroomCode = code;
                    currentRole = 'teacher';
                    document.getElementById('end-class-button-text').textContent = `ä¸‹èª² æ•™å®¤ä»£ç¢¼: ${classroomCode}`; // Update button text
                    document.getElementById('end-class-monitor-button-text').textContent = `ä¸‹èª² æ•™å®¤ä»£ç¢¼: ${classroomCode}`; // Update button text for monitor view
                    localStorage.setItem('teacherClassroomCode', classroomCode); // Persist teacher's classroom code

                    // Set initial classroom state in Firestore, including isPaused: false
                    const controlRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
                    await setDoc(controlRef, { active_mode: 'waiting', teacherId: userId, backgroundImage: null, isPaused: false, multiple_choice_questions: null }, { merge: true }); 
                    isResponsePaused = false; // Initialize local state
                    updateTeacherPauseButtonUI(); // Update button UI
                    currentMultipleChoiceQuestions = null; // Ensure this is cleared on new class

                    listenToClassroomPresence(); // Ensure presence listener is active
                    showView('teacherMenu');
                    document.getElementById('teacher-classroom-code-input').value = ''; // Clear input
                } else {
                     showMessage('è«‹è¼¸å…¥æ•™å®¤ä»£ç¢¼ï¼', 'error');
                }
            });
            document.getElementById('teacher-classroom-code-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') document.getElementById('teacher-classroom-code-submit-btn').click();
            });
            
            // Student name and classroom code submission.
            document.getElementById('submit-name-btn').addEventListener('click', async () => {
                const studentClassroomCode = document.getElementById('student-classroom-code-input').value.trim();
                const name = document.getElementById('student-name-input').value.trim();

                if (!studentClassroomCode) {
                    showMessage('è«‹å‹™å¿…è¼¸å…¥æ•™å®¤ä»£ç¢¼ï¼', 'error');
                    return;
                }
                if (!name) {
                    showMessage('è«‹å‹™å¿…è¼¸å…¥å§“åï¼', 'error');
                    return;
                }

                classroomCode = studentClassroomCode; // Set global classroom code for student
                
                // Check if the classroom exists and is active
                const controlRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
                try {
                    const docSnap = await getDoc(controlRef);
                    if (docSnap.exists() && docSnap.data().teacherId) { // Check if control document exists and has a teacher ID
                        studentName = name;
                        document.getElementById('user-id-display').textContent = `${userId} (${studentName})`;
                        document.getElementById('student-welcome-msg').textContent = `ä½ å¥½ï¼Œ${studentName}ï¼`;
                        listenToInteractionMode();
                        listenToPeerReviewStatus(); // NEW: Listen for peer review status
                        showView('studentWaiting');
                        // Set student presence using the specific classroomCode
                        const presenceRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'presence', userId);
                        await setDoc(presenceRef, { name: studentName, timestamp: new Date() }, { merge: true });
                    } else {
                        showMessage('æ•™å®¤ä»£ç¢¼ä¸å­˜åœ¨æˆ–è€å¸«å°šæœªé–‹å•Ÿæ•™å®¤ï¼', 'error');
                    }
                } catch (error) {
                    console.error("æª¢æŸ¥æ•™å®¤ä»£ç¢¼å¤±æ•—:", error);
                    showMessage("é€²å…¥æ•™å®¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–æ•™å®¤ä»£ç¢¼ã€‚", "error");
                }
            });

            // Teacher mode selection.
            // MODIFIED: B button now opens a menu with Choice/Sequencing/Matching options
            document.getElementById('choice-sequencing-matching-menu-btn').addEventListener('click', () => {
                document.getElementById('choice-sequencing-matching-menu-modal').classList.remove('hidden');
            });

            // Close B menu modal
            document.getElementById('choice-sequencing-matching-menu-close-btn').addEventListener('click', () => {
                document.getElementById('choice-sequencing-matching-menu-modal').classList.add('hidden');
            });

            // Open Multiple Choice Settings from B menu
            document.getElementById('open-multiple-choice-settings-btn').addEventListener('click', () => {
                document.getElementById('choice-sequencing-matching-menu-modal').classList.add('hidden');
                // Initialize modal state based on current customMultipleChoiceQuestions
                const mcQuestionTypeNone = document.querySelector('input[name="mcQuestionType"][value="none"]');
                const mcQuestionTypeCustom = document.querySelector('input[name="mcQuestionType"][value="custom"]');
                const customMcQuestionsSection = document.getElementById('custom-mc-questions-section');
                const customMcQuestionsTextarea = document.getElementById('custom-mc-questions-textarea');
                const customMcQuestionsStatus = document.getElementById('custom-mc-questions-status');

                if (customMultipleChoiceQuestions && customMultipleChoiceQuestions.length > 0) {
                    mcQuestionTypeCustom.checked = true;
                    customMcQuestionsSection.classList.remove('hidden');
                    document.getElementById('question-bank-management-section').classList.remove('hidden');
                    customMcQuestionsTextarea.value = customMultipleChoiceQuestions.map(q => {
                        return `${q.question},${q.correctAnswer},${q.options.join(',')}`;
                    }).join('\n');
                } else {
                    mcQuestionTypeNone.checked = true;
                    customMcQuestionsSection.classList.add('hidden');
                    document.getElementById('question-bank-management-section').classList.add('hidden');
                    customMcQuestionsTextarea.value = '';
                }
                customMcQuestionsStatus.classList.add('hidden');
                document.getElementById('multiple-choice-settings-modal').classList.remove('hidden');
            });

            // Open Sequencing Settings from B menu
            document.getElementById('open-sequencing-settings-btn').addEventListener('click', () => {
                document.getElementById('choice-sequencing-matching-menu-modal').classList.add('hidden');
                document.getElementById('sequencing-settings-modal').classList.remove('hidden');
            });

            // Open Matching Settings from B menu
            document.getElementById('open-matching-settings-btn').addEventListener('click', () => {
                document.getElementById('choice-sequencing-matching-menu-modal').classList.add('hidden');
                document.getElementById('matching-settings-modal').classList.remove('hidden');
            });

            // Sequencing/Matching Menu Button - Keep for compatibility if needed elsewhere
            // Sequencing Settings Button (from menu)
            document.getElementById('sequencing-settings-btn')?.addEventListener('click', () => {
                document.getElementById('sequencing-matching-menu-modal').classList.add('hidden');
                document.getElementById('sequencing-settings-modal').classList.remove('hidden');
            });

            // Matching Settings Button (from menu)
            document.getElementById('matching-settings-btn')?.addEventListener('click', () => {
                document.getElementById('sequencing-matching-menu-modal').classList.add('hidden');
                document.getElementById('matching-settings-modal').classList.remove('hidden');
            });

            // é¡Œå‹åˆ‡æ›æŒ‰éˆ•
            document.getElementById('switch-to-matching-btn').addEventListener('click', () => {
                document.getElementById('sequencing-settings-modal').classList.add('hidden');
                document.getElementById('matching-settings-modal').classList.remove('hidden');
            });

            document.getElementById('switch-to-sequencing-btn').addEventListener('click', () => {
                document.getElementById('matching-settings-modal').classList.add('hidden');
                document.getElementById('sequencing-settings-modal').classList.remove('hidden');
            });

            // REMOVED: Old multiple-choice-settings-btn listener (now handled by open-multiple-choice-settings-btn from B menu)

            // Other teacher mode selection buttons (unchanged, directly set mode)
            document.querySelectorAll('#teacher-menu-view button[data-mode]').forEach(button => {
                button.addEventListener('click', async () => {
                    const mode = button.dataset.mode;
                    // MODIFIED: Check dispatch settings for url_dispatch
                    if (mode === 'url_dispatch') {
                        if (dispatchSettings.type === 'url' && !dispatchSettings.url) {
                            showMessage('è«‹å…ˆè¨­å®šè¦æ´¾é€çš„ç¶²å€ï¼', 'error');
                            showUrlDispatchSettingsModal();
                            return;
                        } else if (dispatchSettings.type === 'html' && !dispatchSettings.htmlContent) {
                            showMessage('è«‹å…ˆä¸Šå‚³è¦æ´¾é€çš„ HTML æª”æ¡ˆï¼', 'error');
                            showUrlDispatchSettingsModal();
                            return;
                        }
                    }
                    showView('teacherMonitor');
                    await setInteractionMode(mode); // Set mode and handle student responses listener
                });
            });

            // End interaction button.
            document.getElementById('end-interaction-btn').addEventListener('click', async () => {
                // NEW: Clear peer review data when ending interaction (not just stopping)
                try {
                    // Clear peer review settings
                    const peerReviewRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'peerReview');
                    await setDoc(peerReviewRef, { active: false });
                    
                    // Clear all votes - THIS IS THE KEY DIFFERENCE FROM STOPPING
                    const votesRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'peerReviewVotes');
                    const votesSnapshot = await getDocs(votesRef);
                    const deletePromises = votesSnapshot.docs.map(doc => deleteDoc(doc.ref));
                    await Promise.all(deletePromises);
                    
                    peerReviewActive = false;
                    document.getElementById('peer-review-stats-container').classList.add('hidden');
                    
                    // Reset peer review button text
                    const startPeerReviewBtn = document.getElementById('start-peer-review-btn');
                    startPeerReviewBtn.innerHTML = '<i class="fas fa-heart mr-2"></i> é–‹å§‹äº’è©• â¤ï¸';
                    
                    // Clear student voted works
                    allPeerReviewVotes = {};
                    studentVotedWorks.clear();
                    
                    // Clear saved canvas state
                    savedCanvasState = null;
                    
                    if (peerReviewUnsubscribe) {
                        peerReviewUnsubscribe();
                        peerReviewUnsubscribe = null;
                    }
                } catch (error) {
                    console.error('Error clearing peer review data:', error);
                }
                
                await setInteractionMode('waiting');
                lastSelectedStudentCard = null;

                // Clear sequencing and matching input fields
                document.getElementById('sequencing-items-textarea').value = '';
                document.getElementById('matching-pairs-textarea').value = '';

                showView('teacherMenu');
                manualRefreshCounts(); // This will refresh the count display, but the listener is already active.
                // Clear URL/HTML settings and teacher background image when ending interaction
                clearDispatchSettings(); // Use the combined clear function
                teacherUploadedBackgroundImageDataURL = null;
                document.getElementById('teacher-image-status').textContent = 'ç›®å‰æ²’æœ‰èƒŒæ™¯åœ–ç‰‡ã€‚å¯é¸æ“‡æª”æ¡ˆæˆ–ç›´æ¥è²¼ä¸Š(Ctrl+V)ã€‚';
                document.getElementById('teacher-image-preview').src = '';
                document.getElementById('teacher-image-preview-container').classList.add('hidden');
                isResponsePaused = false; // NEW: Reset pause state
                updateTeacherPauseButtonUI(); // NEW: Update pause button UI
                customMultipleChoiceQuestions = []; // NEW: Clear custom MC questions on end interaction
            });
            
            // Student answer buttons for default multiple choice.
            document.querySelectorAll('#interaction-true-false .answer-btn, #default-mc-options .answer-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    // NEW: Check pause state before submitting
                    if (isResponsePaused) {
                        showMessage('è€å¸«å·²æš«åœå›è¦†ï¼Œç„¡æ³•é€å‡ºç­”æ¡ˆã€‚', 'error');
                        return;
                    }
                    const answer = e.currentTarget.dataset.answer;
                    await submitAnswer(answer);
                    e.currentTarget.closest('div').querySelectorAll('.answer-btn').forEach(b => {
                        b.disabled = true;
                        b.classList.add('btn-gray');
                    });
                    e.currentTarget.disabled = false;
                    e.currentTarget.classList.remove('btn-gray');
                });
            });

            // Text input submission.
            document.getElementById('submit-text-btn').addEventListener('click', async (e) => {
                // NEW: Check pause state before submitting
                if (isResponsePaused) {
                    showMessage('è€å¸«å·²æš«åœå›è¦†ï¼Œç„¡æ³•é€å‡ºç­”æ¡ˆã€‚', 'error');
                    return;
                }
                const text = document.getElementById('text-input-area').value;
                await submitAnswer(text);
                e.currentTarget.disabled = true;
                e.currentTarget.classList.replace('btn-primary', 'btn-gray');
            });
            
            // Drawing submission.
            document.getElementById('submit-drawing-btn').addEventListener('click', async (e) => {
                // NEW: Check pause state before submitting
                if (isResponsePaused) {
                    showMessage('è€å¸«å·²æš«åœå›è¦†ï¼Œç„¡æ³•é€å‡ºç­”æ¡ˆã€‚', 'error');
                    return;
                }
                const dataUrl = canvas.toDataURL('image/jpeg', JPEG_QUALITY);
                await submitAnswer(dataUrl);
                e.currentTarget.disabled = true;
                e.currentTarget.classList.replace('btn-primary', 'btn-gray');
            });

            // Sequencing submission.
            document.getElementById('submit-sequencing-btn').addEventListener('click', async (e) => {
                if (isResponsePaused) {
                    showMessage('è€å¸«å·²æš«åœå›è¦†ï¼Œç„¡æ³•é€å‡ºç­”æ¡ˆã€‚', 'error');
                    return;
                }
                const container = document.getElementById('sequencing-items-container');
                const items = Array.from(container.children).map(item => item.dataset.text);
                await submitAnswer(JSON.stringify(items));
                e.currentTarget.disabled = true;
                e.currentTarget.classList.replace('btn-primary', 'btn-gray');
                showMessage('ç­”æ¡ˆå·²é€å‡ºï¼', 'success');
            });

            // Matching submission.
            document.getElementById('submit-matching-btn').addEventListener('click', async (e) => {
                if (isResponsePaused) {
                    showMessage('è€å¸«å·²æš«åœå›è¦†ï¼Œç„¡æ³•é€å‡ºç­”æ¡ˆã€‚', 'error');
                    return;
                }
                const matches = [];
                document.querySelectorAll('.matching-item.matched').forEach(item => {
                    if (item.dataset.side === 'left' && item.dataset.matchedWith) {
                        matches.push({
                            left: item.dataset.text,
                            right: item.dataset.matchedWith
                        });
                    }
                });

                if (matches.length === 0) {
                    showMessage('è«‹è‡³å°‘å®Œæˆä¸€å€‹é…å°ï¼', 'error');
                    return;
                }

                await submitAnswer(JSON.stringify(matches));
                e.currentTarget.disabled = true;
                e.currentTarget.classList.replace('btn-primary', 'btn-gray');
                showMessage('ç­”æ¡ˆå·²é€å‡ºï¼', 'success');
            });

            // Drawing board events.
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseleave', stopDrawing);
            canvas.addEventListener('touchstart', startDrawing, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchend', stopDrawing);
            window.addEventListener('resize', () => {
                if (!views.studentInteraction.classList.contains('hidden') && !interactionUIs.drawing.classList.contains('hidden')) {
                    setupCanvas();
                    loadBackgroundImage();
                    loadStudentImage();
                }
            });

            // Drawing tool controls.
            const colorSelect = document.getElementById('color-select');
            const sizeSelect = document.getElementById('size-select');
            const penToolBtn = document.getElementById('pen-tool-btn');
            const eraserBtn = document.getElementById('eraser-btn');
            colorSelect.addEventListener('change', (e) => {
                drawingCtx.strokeStyle = e.target.value; 
                drawingCtx.globalCompositeOperation = 'source-over'; 
                updateColorSwatch(e.target.value); 
                penToolBtn.classList.add('border-blue-500'); 
                eraserBtn.classList.remove('border-blue-500');
            });
            sizeSelect.addEventListener('change', (e) => { drawingCtx.lineWidth = parseInt(e.target.value); });
            penToolBtn.addEventListener('click', () => {
                drawingCtx.globalCompositeOperation = 'source-over'; 
                drawingCtx.strokeStyle = colorSelect.value; 
                drawingCtx.lineWidth = parseInt(sizeSelect.value); 
                penToolBtn.classList.add('border-blue-500'); 
                eraserBtn.classList.remove('border-blue-500'); 
            });
            eraserBtn.addEventListener('click', () => {
                drawingCtx.globalCompositeOperation = 'destination-out';
                drawingCtx.lineWidth = 15;
                penToolBtn.classList.remove('border-blue-500'); 
                eraserBtn.classList.add('border-blue-500'); 
            });
            document.getElementById('clear-canvas-btn').addEventListener('click', clearDrawingCanvas);
            
            // Image upload handlers (teacher and student).
            setupImageUpload('teacher-image-upload-input', 'teacher-image-status', 'teacher-image-preview-container', 'teacher-image-preview', 'clear-teacher-background-btn', true);
            setupImageUpload('student-image-upload-input', null, null, null, 'clear-student-image-btn', false);

            // NEW: Paste event listener for teacher background image
            document.addEventListener('paste', e => {
                // Only allow pasting when the teacher menu is visible
                if (views.teacherMenu.classList.contains('hidden')) {
                    return;
                }
                
                // Don't interfere if the user is typing in an input field
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }

                const items = (e.clipboardData || window.clipboardData).items;
                for (const item of items) {
                    if (item.kind === 'file' && item.type.startsWith('image/')) {
                        const file = item.getAsFile();
                        if (file) {
                            // Call the specific teacher image handler
                            handleImageFileForTeacher(file, 'teacher-image-status', 'teacher-image-preview-container', 'teacher-image-preview');
                            e.preventDefault(); // Prevent the image from being pasted as a file object
                            return; // Exit after handling the first image
                        }
                    }
                }
            });

            // Modal close buttons.
            document.getElementById('student-status-area').addEventListener('click', showStudentListModal);
            studentListModalCloseBtn.addEventListener('click', hideStudentListModal);
            document.getElementById('show-statistics-btn').addEventListener('click', showStatisticsModal);
            
            // NEW: View Questions Button
            document.getElementById('view-questions-btn').addEventListener('click', showViewQuestionsModal);
            document.getElementById('view-questions-modal-close-btn').addEventListener('click', hideViewQuestionsModal);
            document.getElementById('cancel-questions-view-btn').addEventListener('click', hideViewQuestionsModal);
            document.getElementById('save-correct-answers-btn').addEventListener('click', saveCorrectAnswers);
            
            // NEW: Download Responses Button
            document.getElementById('download-responses-btn').addEventListener('click', downloadStudentResponses);
            
            // NEW: Start Peer Review Button
            document.getElementById('start-peer-review-btn').addEventListener('click', startPeerReview);
            
            // NEW: Exit Peer Review Button (Student)
            document.getElementById('exit-peer-review-btn').addEventListener('click', exitPeerReview);
            chartModalCloseBtn.addEventListener('click', hideStatisticsModal);
            magnifiedImageModalCloseBtn.addEventListener('click', hideMagnifiedDrawing);
            magnifiedImageModal.addEventListener('click', (e) => { if (e.target === magnifiedImageModal) hideMagnifiedDrawing(); });
            document.getElementById('close-message-btn').addEventListener('click', hideMessage);

            // NEW: Unsubmitted Students Modal Listeners
            document.getElementById('show-unsubmitted-students-btn').addEventListener('click', showUnsubmittedStudentsModal);
            unsubmittedStudentsModalCloseBtn.addEventListener('click', hideUnsubmittedStudentsModal);
            unsubmittedStudentsModal.addEventListener('click', (e) => { if (e.target === unsubmittedStudentsModal) hideUnsubmittedStudentsModal(); });


            // Teacher utility buttons.
            document.getElementById('refresh-student-count-btn').addEventListener('click', manualRefreshCounts);
            // Original lottery button in monitor view (now replaced by modal one)
            document.getElementById('draw-lottery-btn').addEventListener('click', () => {
                if (allStudentResponses.length === 0) return showMessage('ç›®å‰æ²’æœ‰å­¸ç”Ÿæäº¤ç­”æ¡ˆå¯ä¾›æŠ½ç±¤ã€‚', 'info');
                if (lastSelectedStudentCard) lastSelectedStudentCard.classList.remove('selected-student-border');
                const randomIndex = Math.floor(Math.random() * allStudentResponses.length);
                const selectedStudentName = allStudentResponses[randomIndex].name;
                const studentCards = document.querySelectorAll('#student-responses-container .student-response-item');
                const foundCard = Array.from(studentCards).find(card => card.querySelector('.name-box').textContent === selectedStudentName);
                if (foundCard) {
                    foundCard.classList.add('selected-student-border');
                    lastSelectedStudentCard = foundCard;
                    showMessage(`æ­å–œï¼æŠ½ä¸­å­¸ç”Ÿï¼š${selectedStudentName}`, 'success');
                }
            });
            // NEW: Lottery button inside the student list modal
            document.getElementById('modal-draw-lottery-btn').addEventListener('click', () => {
                if (activeStudentNames.length === 0) {
                    return showMessage('ç›®å‰æ²’æœ‰å­¸ç”Ÿåœ¨ç·šå¯ä¾›æŠ½ç±¤ã€‚', 'info');
                }

                // Remove highlight from previously selected student in the modal
                if (lastSelectedModalStudent) {
                    lastSelectedModalStudent.classList.remove('modal-selected-student-border');
                }

                // Randomly select a student from all active online students
                const randomIndex = Math.floor(Math.random() * activeStudentNames.length);
                const selectedStudentName = activeStudentNames[randomIndex];

                // Find the corresponding <p> element in the modal
                const studentNameElements = document.querySelectorAll('#modal-student-names p');
                const foundElement = Array.from(studentNameElements).find(p => p.textContent === selectedStudentName);

                if (foundElement) {
                    foundElement.classList.add('modal-selected-student-border');
                    lastSelectedModalStudent = foundElement; // Store the currently selected element
                    showMessage(`æ­å–œï¼æŠ½ä¸­å­¸ç”Ÿï¼š${selectedStudentName}`, 'success');
                } else {
                    // This case should ideally not happen if activeStudentNames is correctly populated
                    // and the modal list is correctly rendered.
                    showMessage(`æŠ½ä¸­å­¸ç”Ÿï¼š${selectedStudentName} (æœªåœ¨åˆ—è¡¨ä¸­æ‰¾åˆ°)`, 'info');
                }
            });


            document.getElementById('download-media-btn').addEventListener('click', async (e) => { // Changed ID
                const btn = e.currentTarget;
                if (btn.disabled) return;
                
                let mediaResponses = [];
                let filenamePrefix = '';
                let fileExtension = '';

                if (currentInteractionMode === 'drawing') {
                    mediaResponses = allStudentResponses.filter(r => r.answer && r.answer.startsWith('data:image'));
                    filenamePrefix = 'å­¸ç”Ÿç¹ªåœ–ç­”æ¡ˆ';
                    fileExtension = 'jpg';
                } else if (currentInteractionMode === 'recording') {
                    mediaResponses = allStudentResponses.filter(r => r.answer && r.answer.startsWith('data:audio'));
                    filenamePrefix = 'å­¸ç”ŸéŒ„éŸ³ç­”æ¡ˆ';
                    // Determine file extension based on the actual mimeType used for recording
                    const firstAudioResponse = mediaResponses.find(r => r.answer);
                    if (firstAudioResponse) {
                        const mime = firstAudioResponse.answer.split(',')[0].match(/:(.*?);/)?.[1];
                        if (mime) {
                            if (mime.includes('webm')) fileExtension = 'webm';
                            else if (mime.includes('mp4')) fileExtension = 'mp4';
                            else if (mime.includes('ogg')) fileExtension = 'ogg';
                            else if (mime.includes('wav')) fileExtension = 'wav';
                            else fileExtension = 'bin'; // Fallback for unknown
                        } else {
                            fileExtension = 'bin'; // Fallback if mime type not found in data URL
                        }
                    } else {
                        fileExtension = 'webm'; // Default if no audio responses
                    }
                } else {
                    return showMessage('ç›®å‰æ¨¡å¼ä¸æ”¯æ´ä¸‹è¼‰åª’é«”ã€‚', 'info');
                }

                if (mediaResponses.length === 0) return showMessage(`ç›®å‰æ²’æœ‰${filenamePrefix}å¯ä¾›ä¸‹è¼‰ã€‚`, 'info');
                
                btn.disabled = true;
                showMessage(`æ­£åœ¨æ‰“åŒ…${filenamePrefix}...`, 'info');
                const zip = new JSZip();
                const dataURLToBlob = (dataurl) => {
                    const [header, body] = dataurl.split(',');
                    const mime = header.match(/:(.*?);/)[1];
                    const bstr = atob(body);
                    let n = bstr.length;
                    const u8arr = new Uint8Array(n);
                    while(n--) u8arr[n] = bstr.charCodeAt(n);
                    return new Blob([u8arr], {type:mime});
                };
                
                mediaResponses.forEach(r => {
                    // Ensure unique filenames for students with same name but different recordings if needed
                    // For now, just use student name.
                    zip.file(`${r.name}.${fileExtension}`, dataURLToBlob(r.answer));
                });

                try {
                    const content = await zip.generateAsync({type:"blob"});
                    saveAs(content, `${filenamePrefix}_${new Date().toLocaleDateString('zh-TW')}.zip`);
                    showMessage(`å·²æˆåŠŸæ‰“åŒ… ${mediaResponses.length} å€‹æª”æ¡ˆä¸¦é–‹å§‹ä¸‹è¼‰ã€‚`, 'success');
                } catch (error) {
                    console.error("æ‰“åŒ…åª’é«”å¤±æ•—:", error);
                    showMessage("æ‰“åŒ…åª’é«”å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ”¯æ´æˆ–æª”æ¡ˆå¤§å°ã€‚", "error");
                } finally {
                    btn.disabled = false;
                }
            });
            
            // AI-related buttons and modals.
            document.getElementById('ai-text-summary-btn').addEventListener('click', async () => {
                const textResponses = allStudentResponses.filter(r => currentInteractionMode === 'text_input' && r.answer && r.answer.trim()).map(r => r.answer);
                if (textResponses.length === 0) return showMessage('ç›®å‰æ²’æœ‰æ–‡å­—å›ç­”å¯ä¾› AI åˆ†æã€‚', 'info');
                const aiSummaryModal = document.getElementById('ai-summary-modal');
                const aiLoadingSpinner = document.getElementById('ai-loading-spinner');
                const aiSummaryResultList = document.getElementById('ai-summary-result-list');
                aiSummaryModal.classList.remove('hidden');
                aiLoadingSpinner.classList.remove('hidden');
                aiSummaryResultList.innerHTML = '';
                const prompt = `è«‹åˆ†æä»¥ä¸‹å­¸ç”Ÿå›ç­”çš„æ–‡æœ¬å…§å®¹ï¼Œè­˜åˆ¥å‡ºèªç¾©ä¸Šç›¸ä¼¼çš„è©èªæˆ–çŸ­èªï¼Œæ­¸é¡ç‚ºä¸»è¦è©å½™ä¸¦çµ±è¨ˆç¸½å‡ºç¾æ¬¡æ•¸ã€‚åˆ—å‡ºæœ€å¸¸å‡ºç¾çš„10å€‹ä¸»è¦è©å½™ã€‚è«‹ä»¥ç¹é«”ä¸­æ–‡å›æ‡‰ï¼Œæ’é™¤å¸¸è¦‹åŠ©è©ã€é€£æ¥è©ã€æ¨™é»ç¬¦è™Ÿã€‚ä½¿ç”¨JSONæ ¼å¼è¿”å›çµæœï¼š[{"word": "ä¸»è¦è©å½™1", "count": 10}]ã€‚è‹¥ç„¡æœ‰æ„ç¾©è©å½™ï¼Œè¿”å›ç©ºé™£åˆ—[]ã€‚æ–‡æœ¬å…§å®¹ï¼š\n${textResponses.join('\n\n')}`;
                try {
                    const payload = {
                        contents: [{ role: "user", parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json", responseSchema: { type: "ARRAY", items: { type: "OBJECT", properties: { "word": { "type": "STRING" }, "count": { "type": "NUMBER" } }, "propertyOrdering": ["word", "count"] } } }
                    };
                    const apiKey = (aiSettings.aiSource === 'gemini-custom' && aiSettings.geminiApiKey) ? aiSettings.geminiApiKey : "";
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API request failed: ${response.status}`);
                    const result = await response.json();
                    aiLoadingSpinner.classList.add('hidden');
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    const parsedResults = jsonText ? JSON.parse(jsonText) : [];
                    if (parsedResults.length > 0) {
                        parsedResults.sort((a, b) => b.count - a.count).forEach(item => {
                            const li = document.createElement('li');
                            li.textContent = `${item.word} (${item.count}æ¬¡)`;
                            aiSummaryResultList.appendChild(li);
                        });
                    } else {
                        aiSummaryResultList.innerHTML = '<li>æ²’æœ‰æ‰¾åˆ°å¸¸ç”¨è©å½™ã€‚</li>';
                    }
                } catch (error) {
                    console.error("AI æ–‡å­—åˆ†æå¤±æ•—:", error);
                    aiLoadingSpinner.classList.add('hidden');
                    aiSummaryResultList.innerHTML = '<li class="error-message">AI åˆ†æå¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key æˆ–ç¶²è·¯é€£ç·šã€‚</li>';
                }
            });
            document.getElementById('ai-summary-modal-close-btn').addEventListener('click', () => document.getElementById('ai-summary-modal').classList.add('hidden'));
            document.getElementById('ai-settings-btn').addEventListener('click', showAISettingsModal);
            aiSettingsModalCloseBtn.addEventListener('click', hideAISettingsModal);
            saveAiSettingsBtn.addEventListener('click', saveAISettings);
            aiSourceSelect.addEventListener('change', (e) => geminiApiKeyGroup.classList.toggle('hidden', e.target.value !== 'gemini-custom'));

            // New: URL/HTML Dispatch Settings Modal listeners.
            document.getElementById('url-dispatch-settings-btn').addEventListener('click', showUrlDispatchSettingsModal);
            urlDispatchModalCloseBtn.addEventListener('click', hideUrlDispatchSettingsModal);
            document.getElementById('save-dispatch-settings-btn').addEventListener('click', saveDispatchSettings); // Renamed
            document.getElementById('clear-dispatch-settings-btn').addEventListener('click', clearDispatchSettings); // Renamed

            // Sequencing Settings Modal listeners
            document.getElementById('sequencing-settings-modal-close-btn').addEventListener('click', () => {
                document.getElementById('sequencing-settings-modal').classList.add('hidden');
            });
            document.getElementById('cancel-sequencing-settings-btn').addEventListener('click', () => {
                document.getElementById('sequencing-settings-modal').classList.add('hidden');
            });
            document.getElementById('start-sequencing-interaction-btn').addEventListener('click', async () => {
                const question = 'æ’åºé¡Œ';
                const itemsText = document.getElementById('sequencing-items-textarea').value.trim();

                if (!itemsText) {
                    showMessage('è«‹è¼¸å…¥æ’åºé …ç›®ï¼', 'error');
                    return;
                }

                const items = itemsText.split('\n').map(item => item.trim()).filter(item => item);
                if (items.length < 2) {
                    showMessage('è‡³å°‘éœ€è¦å…©å€‹æ’åºé …ç›®ï¼', 'error');
                    return;
                }

                sequencingData.question = question;
                sequencingData.correctOrder = items;

                document.getElementById('sequencing-settings-modal').classList.add('hidden');
                showView('teacherMonitor');
                await setInteractionMode('sequencing', {
                    question: question,
                    correctOrder: items
                });
            });

            // Matching Settings Modal listeners
            document.getElementById('matching-settings-modal-close-btn').addEventListener('click', () => {
                document.getElementById('matching-settings-modal').classList.add('hidden');
            });
            document.getElementById('cancel-matching-settings-btn').addEventListener('click', () => {
                document.getElementById('matching-settings-modal').classList.add('hidden');
            });
            document.getElementById('start-matching-interaction-btn').addEventListener('click', async () => {
                const question = 'é…å°é¡Œ';
                const pairsText = document.getElementById('matching-pairs-textarea').value.trim();

                if (!pairsText) {
                    showMessage('è«‹è¼¸å…¥é…å°é …ç›®ï¼', 'error');
                    return;
                }

                const lines = pairsText.split('\n').map(line => line.trim()).filter(line => line);
                const pairs = [];

                for (const line of lines) {
                    const parts = line.split(/[,\t]/).map(p => p.trim()).filter(p => p);
                    if (parts.length >= 2) {
                        pairs.push({ left: parts[0], right: parts[1] });
                    }
                }

                if (pairs.length < 2) {
                    showMessage('è‡³å°‘éœ€è¦å…©å°é…å°é …ç›®ï¼', 'error');
                    return;
                }

                matchingData.question = question;
                matchingData.pairs = pairs;

                document.getElementById('matching-settings-modal').classList.add('hidden');
                showView('teacherMonitor');
                await setInteractionMode('matching', {
                    question: question,
                    pairs: pairs
                });
            });

            // Quick Poll Settings Modal listeners
            document.getElementById('quick-poll-settings-btn').addEventListener('click', showQuickPollSettingsModal);
            document.getElementById('quick-poll-settings-modal-close-btn').addEventListener('click', hideQuickPollSettingsModal);
            document.getElementById('cancel-quick-poll-settings-btn').addEventListener('click', hideQuickPollSettingsModal);
            document.getElementById('start-quick-poll-btn').addEventListener('click', startQuickPoll);

            // Quick Poll Stats Modal listeners
            document.getElementById('quick-poll-stats-modal-close-btn').addEventListener('click', hideQuickPollStatsModal);
            document.getElementById('end-quick-poll-btn').addEventListener('click', endQuickPoll);
            document.getElementById('download-poll-results-btn').addEventListener('click', downloadPollResults);
            document.getElementById('chart-type-bar-btn').addEventListener('click', () => switchChartType('bar'));
            document.getElementById('chart-type-pie-btn').addEventListener('click', () => switchChartType('pie'));

            // Poll type radio button listeners
            document.querySelectorAll('input[name="pollType"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const customSection = document.getElementById('custom-poll-options-section');
                    customSection.classList.toggle('hidden', e.target.value !== 'custom');
                });
            });

            // NEW: Event listeners for dispatch type radio buttons
            dispatchTypeRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const selectedType = e.target.value;
                    urlDispatchSection.classList.toggle('hidden', selectedType === 'html');
                    htmlDispatchSection.classList.toggle('hidden', selectedType === 'url');
                });
            });

            // NEW: HTML upload/clear listeners within the dispatch settings modal
            dispatchHtmlUploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                e.target.value = ''; // Reset input
                if (file) {
                    handleDispatchHtmlFile(file);
                }
            });
            clearDispatchHtmlBtn.addEventListener('click', () => {
                dispatchSettings.htmlContent = null; // Clear content in global state
                dispatchHtmlUploadInput.value = ''; // Clear file input
                dispatchHtmlStatus.textContent = 'ç›®å‰æ²’æœ‰ HTML æª”æ¡ˆã€‚';
                showMessage('HTML æª”æ¡ˆå·²æ¸…é™¤ï¼', 'info');
            });


            // New: Recording button event listeners
            startRecordingBtn.addEventListener('click', async () => {
                // NEW: Check pause state before starting recording
                if (isResponsePaused) {
                    showMessage('è€å¸«å·²æš«åœå›è¦†ï¼Œç„¡æ³•é–‹å§‹éŒ„éŸ³ã€‚', 'error');
                    return;
                }
                startRecording();
            });
            stopRecordingBtn.addEventListener('click', stopRecording);
            playRecordingBtn.addEventListener('click', playRecording);
            resetRecordingBtn.addEventListener('click', resetRecording);
            submitRecordingBtn.addEventListener('click', async () => {
                // NEW: Check pause state before submitting recording
                if (isResponsePaused) {
                    showMessage('è€å¸«å·²æš«åœå›è¦†ï¼Œç„¡æ³•é€å‡ºéŒ„éŸ³ã€‚', 'error');
                    return;
                }
                if (audioDataURL) {
                    await submitAnswer(audioDataURL);
                    submitRecordingBtn.disabled = true;
                    submitRecordingBtn.classList.replace('btn-primary', 'btn-gray');
                } else {
                    showMessage('æ²’æœ‰éŒ„éŸ³å¯é€å‡º', 'error');
                }
            });

            // NEW: Toggle Pause Button Event Listener
            togglePauseBtn.addEventListener('click', toggleResponsePause);


            // End Class Session Buttons.
            document.getElementById('end-class-session-menu-btn').addEventListener('click', endClassSession);
            document.getElementById('end-class-session-monitor-btn').addEventListener('click', endClassSession);

            // NEW: Multiple Choice Settings Modal Listeners
            const multipleChoiceSettingsModal = document.getElementById('multiple-choice-settings-modal');
            const multipleChoiceSettingsModalCloseBtn = document.getElementById('multiple-choice-settings-modal-close-btn');
            const mcQuestionTypeRadios = document.querySelectorAll('input[name="mcQuestionType"]');
            const customMcQuestionsSection = document.getElementById('custom-mc-questions-section');
            const customMcQuestionsTextarea = document.getElementById('custom-mc-questions-textarea');
            const customMcQuestionsStatus = document.getElementById('custom-mc-questions-status');
            const startMcInteractionBtn = document.getElementById('start-mc-interaction-btn');
            const cancelMcSettingsBtn = document.getElementById('cancel-mc-settings-btn');
            
            // AI Question Generation elements
            const aiGenerateMcBtn = document.getElementById('ai-generate-mc-btn');
            const aiMcTopicTextarea = document.getElementById('ai-mc-topic-textarea');
            const aiMcCountInput = document.getElementById('ai-mc-count-input');
            const aiMcLoadingSpinner = document.getElementById('ai-mc-loading-spinner');
            const aiMcBtnText = document.getElementById('ai-mc-btn-text');
            const aiMcBtnIcon = document.getElementById('ai-mc-btn-icon');

            // Question Bank Management elements
            const questionBankFileInput = document.getElementById('question-bank-file-input');
            const loadQuestionBankBtn = document.getElementById('load-question-bank-btn');
            const questionBankNameInput = document.getElementById('question-bank-name-input');
            const saveQuestionBankBtn = document.getElementById('save-question-bank-btn');
            const questionBankList = document.getElementById('question-bank-list');


            multipleChoiceSettingsModalCloseBtn.addEventListener('click', () => multipleChoiceSettingsModal.classList.add('hidden'));
            cancelMcSettingsBtn.addEventListener('click', () => multipleChoiceSettingsModal.classList.add('hidden'));

            // Question Bank Management Event Listeners
            loadQuestionBankBtn.addEventListener('click', loadQuestionBankFromFile);
            saveQuestionBankBtn.addEventListener('click', saveQuestionBankFromTextarea);

            // Teacher Password Modal Event Listeners
            const teacherPasswordModal = document.getElementById('teacher-password-modal');
            const teacherPasswordModalCloseBtn = document.getElementById('teacher-password-modal-close-btn');
            const teacherPasswordInput = document.getElementById('teacher-password-input');
            const teacherPasswordSubmitBtn = document.getElementById('teacher-password-submit-btn');
            const teacherPasswordCancelBtn = document.getElementById('teacher-password-cancel-btn');

            teacherPasswordModalCloseBtn.addEventListener('click', () => {
                teacherPasswordModal.classList.add('hidden');
                teacherPasswordInput.value = '';
            });
            teacherPasswordCancelBtn.addEventListener('click', () => {
                teacherPasswordModal.classList.add('hidden');
                teacherPasswordInput.value = '';
            });
            teacherPasswordSubmitBtn.addEventListener('click', () => {
                const password = teacherPasswordInput.value.trim();
                if (password === 'tpet') {
                    teacherPasswordModal.classList.add('hidden');
                    teacherPasswordInput.value = '';
                    showView('teacherClassroomCode');
                } else {
                    showMessage('å¯†ç¢¼éŒ¯èª¤ï¼', 'error');
                    teacherPasswordInput.value = '';
                    teacherPasswordInput.focus();
                }
            });
            teacherPasswordInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    teacherPasswordSubmitBtn.click();
                }
            });

            mcQuestionTypeRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const isCustomMode = e.target.value === 'custom';
                    customMcQuestionsSection.classList.toggle('hidden', !isCustomMode);
                    document.getElementById('question-bank-management-section').classList.toggle('hidden', !isCustomMode);
                    customMcQuestionsStatus.classList.add('hidden'); // Hide status when changing radio
                });
            });

            startMcInteractionBtn.addEventListener('click', async () => {
                const selectedType = document.querySelector('input[name="mcQuestionType"]:checked').value;
                let questionsToDispatch = null;

                if (selectedType === 'custom') {
                    const parsedQuestions = parseCustomQuestions(customMcQuestionsTextarea.value);
                    if (!parsedQuestions) {
                        customMcQuestionsStatus.classList.remove('hidden');
                        return; // Stop if parsing failed
                    }
                    questionsToDispatch = parsedQuestions;
                    customMultipleChoiceQuestions = parsedQuestions; // Update global for teacher UI
                } else {
                    customMultipleChoiceQuestions = []; // Clear global if switching to none
                }
                
                customMcQuestionsStatus.classList.add('hidden'); // Hide status on successful dispatch
                multipleChoiceSettingsModal.classList.add('hidden');
                showView('teacherMonitor');
                await setInteractionMode('multiple_choice', { customQuestions: questionsToDispatch });
            });

            // AI Question Generation Button Listener
            aiGenerateMcBtn.addEventListener('click', async () => {
                const topic = aiMcTopicTextarea.value.trim();
                const count = parseInt(aiMcCountInput.value);

                if (!topic) {
                    showMessage('è«‹è¼¸å…¥å‡ºé¡Œä¸»é¡Œæˆ–è¦æ±‚ï¼', 'error');
                    return;
                }
                if (!count || count < 1 || count > 10) {
                    showMessage('å‡ºé¡Œæ•¸é‡å¿…é ˆä»‹æ–¼ 1 åˆ° 10 ä¹‹é–“ï¼', 'error');
                    return;
                }
                
                // Show loading state
                aiGenerateMcBtn.disabled = true;
                aiMcBtnText.textContent = 'AI æ€è€ƒä¸­...';
                aiMcBtnIcon.classList.remove('fa-magic');
                aiMcBtnIcon.classList.add('fa-spinner', 'fa-spin');
                aiMcLoadingSpinner.classList.remove('hidden');

                const prompt = `è«‹æ ¹æ“šä»¥ä¸‹è¦æ±‚ï¼Œç”Ÿæˆ ${count} é¡Œé¸æ“‡é¡Œã€‚
                è¦æ±‚ï¼š${topic}
                è«‹åš´æ ¼éµå®ˆä»¥ä¸‹æ ¼å¼ï¼Œæ¯é¡Œä¸€è¡Œï¼Œä¸¦ç”¨é€—è™Ÿåˆ†éš”æ¯å€‹æ¬„ä½ï¼š
                é¡Œç›®,æ­£ç¢ºç­”æ¡ˆ(1-4),é¸é …1,é¸é …2,é¸é …3,é¸é …4
                è«‹å‹¿åŒ…å«é¡Œè™Ÿã€ä»»ä½•å¤šé¤˜çš„èªªæ˜æ–‡å­—æˆ–ç¨‹å¼ç¢¼å€å¡Šæ¨™è¨˜ã€‚`;

                try {
                    const payload = {
                        contents: [{ role: "user", parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.7 } // Adjust temperature for creativity
                    };
                    const apiKey = aiSettings.geminiApiKey;
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                    if (!response.ok) {
                        throw new Error(`AI API request failed with status ${response.status}`);
                    }

                    const result = await response.json();
                    const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (generatedText) {
                        // Append to existing content, adding a newline if needed
                        const existingText = customMcQuestionsTextarea.value.trim();
                        customMcQuestionsTextarea.value = existingText ? `${existingText}\n${generatedText.trim()}` : generatedText.trim();
                        showMessage('AI é¡Œç›®å·²æˆåŠŸç”Ÿæˆä¸¦å¡«å…¥å·¦æ–¹ï¼', 'success');
                    } else {
                        throw new Error('AI æœªè¿”å›æœ‰æ•ˆå…§å®¹ã€‚');
                    }

                } catch (error) {
                    console.error("AI é¡Œç›®ç”Ÿæˆå¤±æ•—:", error);
                    showMessage('AI é¡Œç›®ç”Ÿæˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key æˆ–ç¶²è·¯é€£ç·šã€‚', 'error');
                } finally {
                    // Hide loading state
                    aiGenerateMcBtn.disabled = false;
                    aiMcBtnText.textContent = 'AI é–‹å§‹å‡ºé¡Œ';
                    aiMcBtnIcon.classList.add('fa-magic');
                    aiMcBtnIcon.classList.remove('fa-spinner', 'fa-spin');
                    aiMcLoadingSpinner.classList.add('hidden');
                }
            });

            // AI Sequencing Question Generation Button Listener
            const aiGenerateSeqBtn = document.getElementById('ai-generate-seq-btn');
            const aiSeqTopicTextarea = document.getElementById('ai-seq-topic-textarea');
            const aiSeqCountInput = document.getElementById('ai-seq-count-input');
            const aiSeqBtnText = document.getElementById('ai-seq-btn-text');
            const aiSeqBtnIcon = document.getElementById('ai-seq-btn-icon');
            const aiSeqLoadingSpinner = document.getElementById('ai-seq-loading-spinner');

            aiGenerateSeqBtn.addEventListener('click', async () => {
                const topic = aiSeqTopicTextarea.value.trim();
                const count = parseInt(aiSeqCountInput.value);

                if (!topic) {
                    showMessage('è«‹è¼¸å…¥å‡ºé¡Œä¸»é¡Œæˆ–è¦æ±‚ï¼', 'error');
                    return;
                }
                if (!count || count < 3 || count > 10) {
                    showMessage('é …ç›®æ•¸é‡å¿…é ˆä»‹æ–¼ 3 åˆ° 10 ä¹‹é–“ï¼', 'error');
                    return;
                }

                // Show loading state
                aiGenerateSeqBtn.disabled = true;
                aiSeqBtnText.textContent = 'AI æ€è€ƒä¸­...';
                aiSeqBtnIcon.classList.remove('fa-magic');
                aiSeqBtnIcon.classList.add('fa-spinner', 'fa-spin');
                aiSeqLoadingSpinner.classList.remove('hidden');

                const prompt = `è«‹æ ¹æ“šä»¥ä¸‹ä¸»é¡Œï¼Œç”Ÿæˆ ${count} å€‹æ’åºé …ç›®ã€‚
ä¸»é¡Œï¼š${topic}
è«‹æŒ‰æ­£ç¢ºé †åºåˆ—å‡ºï¼Œæ¯å€‹é …ç›®ä¸€è¡Œï¼Œä¸è¦æœ‰é¡Œè™Ÿæˆ–ä»»ä½•æ¨™è¨˜ã€‚
åªéœ€æä¾›é …ç›®å…§å®¹ï¼Œä¸è¦åŒ…å«èªªæ˜æ–‡å­—æˆ–ç¨‹å¼ç¢¼å€å¡Šæ¨™è¨˜ã€‚`;

                try {
                    const payload = {
                        contents: [{ role: "user", parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.7 }
                    };
                    const apiKey = aiSettings.geminiApiKey;
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                    if (!response.ok) {
                        throw new Error(`AI API request failed with status ${response.status}`);
                    }

                    const result = await response.json();
                    const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (generatedText) {
                        const sequencingItemsTextarea = document.getElementById('sequencing-items-textarea');
                        sequencingItemsTextarea.value = generatedText.trim();
                        showMessage('AI æ’åºé¡Œå·²æˆåŠŸç”Ÿæˆä¸¦å¡«å…¥ï¼', 'success');
                    } else {
                        throw new Error('AI æœªè¿”å›æœ‰æ•ˆå…§å®¹ã€‚');
                    }

                } catch (error) {
                    console.error("AI æ’åºé¡Œç”Ÿæˆå¤±æ•—:", error);
                    showMessage('AI æ’åºé¡Œç”Ÿæˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key æˆ–ç¶²è·¯é€£ç·šã€‚', 'error');
                } finally {
                    // Hide loading state
                    aiGenerateSeqBtn.disabled = false;
                    aiSeqBtnText.textContent = 'AI é–‹å§‹å‡ºé¡Œ';
                    aiSeqBtnIcon.classList.add('fa-magic');
                    aiSeqBtnIcon.classList.remove('fa-spinner', 'fa-spin');
                    aiSeqLoadingSpinner.classList.add('hidden');
                }
            });

            // AI Matching Question Generation Button Listener
            const aiGenerateMatchBtn = document.getElementById('ai-generate-match-btn');
            const aiMatchTopicTextarea = document.getElementById('ai-match-topic-textarea');
            const aiMatchCountInput = document.getElementById('ai-match-count-input');
            const aiMatchBtnText = document.getElementById('ai-match-btn-text');
            const aiMatchBtnIcon = document.getElementById('ai-match-btn-icon');
            const aiMatchLoadingSpinner = document.getElementById('ai-match-loading-spinner');

            aiGenerateMatchBtn.addEventListener('click', async () => {
                const topic = aiMatchTopicTextarea.value.trim();
                const count = parseInt(aiMatchCountInput.value);

                if (!topic) {
                    showMessage('è«‹è¼¸å…¥å‡ºé¡Œä¸»é¡Œæˆ–è¦æ±‚ï¼', 'error');
                    return;
                }
                if (!count || count < 3 || count > 10) {
                    showMessage('é…å°æ•¸é‡å¿…é ˆä»‹æ–¼ 3 åˆ° 10 ä¹‹é–“ï¼', 'error');
                    return;
                }

                // Show loading state
                aiGenerateMatchBtn.disabled = true;
                aiMatchBtnText.textContent = 'AI æ€è€ƒä¸­...';
                aiMatchBtnIcon.classList.remove('fa-magic');
                aiMatchBtnIcon.classList.add('fa-spinner', 'fa-spin');
                aiMatchLoadingSpinner.classList.remove('hidden');

                const prompt = `è«‹æ ¹æ“šä»¥ä¸‹ä¸»é¡Œï¼Œç”Ÿæˆ ${count} çµ„é…å°é¡Œã€‚
ä¸»é¡Œï¼š${topic}
æ¯è¡Œæ ¼å¼ï¼šå·¦å´é …ç›®,å³å´é …ç›®
ä¸è¦æœ‰é¡Œè™Ÿã€èªªæ˜æ–‡å­—æˆ–ç¨‹å¼ç¢¼å€å¡Šæ¨™è¨˜ã€‚
ç›´æ¥æä¾›é…å°å…§å®¹ï¼Œæ¯è¡Œä¸€çµ„ã€‚`;

                try {
                    const payload = {
                        contents: [{ role: "user", parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.7 }
                    };
                    const apiKey = aiSettings.geminiApiKey;
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                    if (!response.ok) {
                        throw new Error(`AI API request failed with status ${response.status}`);
                    }

                    const result = await response.json();
                    const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (generatedText) {
                        const matchingPairsTextarea = document.getElementById('matching-pairs-textarea');
                        matchingPairsTextarea.value = generatedText.trim();
                        showMessage('AI é…å°é¡Œå·²æˆåŠŸç”Ÿæˆä¸¦å¡«å…¥ï¼', 'success');
                    } else {
                        throw new Error('AI æœªè¿”å›æœ‰æ•ˆå…§å®¹ã€‚');
                    }

                } catch (error) {
                    console.error("AI é…å°é¡Œç”Ÿæˆå¤±æ•—:", error);
                    showMessage('AI é…å°é¡Œç”Ÿæˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key æˆ–ç¶²è·¯é€£ç·šã€‚', 'error');
                } finally {
                    // Hide loading state
                    aiGenerateMatchBtn.disabled = false;
                    aiMatchBtnText.textContent = 'AI é–‹å§‹å‡ºé¡Œ';
                    aiMatchBtnIcon.classList.add('fa-magic');
                    aiMatchBtnIcon.classList.remove('fa-spinner', 'fa-spin');
                    aiMatchLoadingSpinner.classList.add('hidden');
                }
            });

            // Sequencing Question Bank Management Listeners
            document.getElementById('load-seq-bank-btn').addEventListener('click', loadSequencingBankFromFile);
            document.getElementById('save-seq-bank-btn').addEventListener('click', saveSequencingBank);

            // Matching Question Bank Management Listeners
            document.getElementById('load-match-bank-btn').addEventListener('click', loadMatchingBankFromFile);
            document.getElementById('save-match-bank-btn').addEventListener('click', saveMatchingBank);

            // Reading Comprehension Listeners
            document.getElementById('reading-comprehension-settings-btn')?.addEventListener('click', showReadingComprehensionModal);
            document.getElementById('reading-comprehension-settings-modal-close-btn')?.addEventListener('click', hideReadingComprehensionModal);
            document.getElementById('cancel-reading-settings-btn')?.addEventListener('click', hideReadingComprehensionModal);
            document.getElementById('start-reading-interaction-btn')?.addEventListener('click', startReadingComprehension);
            document.getElementById('submit-reading-btn')?.addEventListener('click', submitReadingAnswer);
            document.getElementById('ai-generate-reading-btn')?.addEventListener('click', generatePIRLSQuestions);
            document.getElementById('load-reading-files-btn')?.addEventListener('click', loadReadingFiles);
            document.getElementById('save-reading-question-bank-btn')?.addEventListener('click', saveReadingQuestionBank);

            // View Reading Questions Modal Listeners
            document.getElementById('view-reading-questions-btn')?.addEventListener('click', showViewReadingQuestionsModal);
            document.getElementById('view-reading-questions-modal-close-btn')?.addEventListener('click', hideViewReadingQuestionsModal);
            document.getElementById('close-reading-questions-view-btn')?.addEventListener('click', hideViewReadingQuestionsModal);


            // NEW: Student side custom multiple choice submission
            document.getElementById('submit-custom-mc-btn').addEventListener('click', async (e) => {
                // NEW: Check pause state before submitting
                if (isResponsePaused) {
                    showMessage('è€å¸«å·²æš«åœå›è¦†ï¼Œç„¡æ³•é€å‡ºç­”æ¡ˆã€‚', 'error');
                    return;
                }

                // NEW: æª¢æŸ¥æ˜¯å¦å·²ç¶“æäº¤éç­”æ¡ˆ
                const hasSubmitted = await checkIfStudentSubmitted();
                if (hasSubmitted) {
                    showMessage('æ‚¨å·²ç¶“æäº¤éç­”æ¡ˆï¼Œç„¡æ³•é‡è¤‡æäº¤ã€‚', 'error');
                    return;
                }

                const studentAnswers = [];
                const questionContainers = document.querySelectorAll('#custom-mc-questions-container .mc-question-item');
                let allAnswered = true;

                questionContainers.forEach((qContainer, index) => {
                    const selectedOption = qContainer.querySelector(`input[name="question-${index}"]:checked`);
                    if (selectedOption) {
                        studentAnswers.push({ qIndex: index, ans: selectedOption.value });
                    } else {
                        allAnswered = false;
                    }
                });

                if (!allAnswered) {
                    showMessage('è«‹å›ç­”æ‰€æœ‰é¡Œç›®ï¼', 'error');
                    return;
                }

                await submitAnswer(studentAnswers);
                
                // NEW: æ›´æ–°UIé¡¯ç¤ºå·²æäº¤ç‹€æ…‹
                e.currentTarget.disabled = true;
                e.currentTarget.classList.replace('btn-primary', 'btn-gray');
                e.currentTarget.textContent = 'å·²æäº¤ç­”æ¡ˆ âœ“';
                
                // Disable all radio buttons after submission
                document.querySelectorAll('#custom-mc-questions-container input[type="radio"]').forEach(radio => {
                    radio.disabled = true;
                });
            });
        }

        /**
         * NEW: Parses custom multiple choice questions from a textarea string.
         * Expected format per line: Question,CorrectAnswer(1-4/A-D),Option1,Option2,Option3,Option4
         * @param {string} rawText - The raw string from the textarea.
         * @returns {Array|null} An array of question objects, or null if parsing fails.
         */
        function parseCustomQuestions(rawText) {
            const lines = rawText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            const questions = [];

            for (const line of lines) {
                // Try splitting by comma first, then by tab if comma yields too few parts
                let parts = line.split(',');
                if (parts.length < 6) {
                    parts = line.split('\t');
                }

                if (parts.length !== 6) {
                    console.error("Invalid line format:", line);
                    return null; // Invalid format
                }

                const questionText = parts[0].trim();
                let correctAnswer = parts[1].trim().toUpperCase();
                const options = parts.slice(2, 6).map(opt => opt.trim());

                // Normalize correct answer to 1, 2, 3, 4
                if (correctAnswer === 'A') correctAnswer = '1';
                else if (correctAnswer === 'B') correctAnswer = '2';
                else if (correctAnswer === 'C') correctAnswer = '3';
                else if (correctAnswer === 'D') correctAnswer = '4';

                if (!['1', '2', '3', '4'].includes(correctAnswer)) {
                    console.error("Invalid correct answer format:", correctAnswer);
                    return null; // Invalid correct answer
                }

                if (questionText === '' || options.some(opt => opt === '')) {
                    console.error("Empty question or option:", line);
                    return null; // Empty question or option
                }

                questions.push({
                    questionText: questionText,
                    correctAnswer: correctAnswer,
                    options: options
                });
            }

            if (questions.length === 0) {
                return null; // No valid questions parsed
            }

            return questions;
        }

        /**
         * NEW: Renders custom multiple choice questions on the student side.
         * @param {Array} questions - An array of question objects.
         */
        async function renderMultipleChoiceQuestions(questions) {
            const defaultMcOptions = document.getElementById('default-mc-options');
            const customMcQuestionsContainer = document.getElementById('custom-mc-questions-container');
            const submitCustomMcBtn = document.getElementById('submit-custom-mc-btn');
            const interactionMultipleChoice = document.getElementById('interaction-multiple-choice');

            if (questions && questions.length > 0) {
                defaultMcOptions.classList.add('hidden');
                customMcQuestionsContainer.classList.remove('hidden');
                submitCustomMcBtn.classList.remove('hidden');
                customMcQuestionsContainer.innerHTML = ''; // Clear previous questions
                interactionMultipleChoice.classList.remove('enlarged-buttons'); // Remove enlarged class for custom questions

                // NEW: æª¢æŸ¥å­¸ç”Ÿæ˜¯å¦å·²ç¶“æäº¤éç­”æ¡ˆ
                const hasSubmitted = await checkIfStudentSubmitted();
                
                questions.forEach((q, qIndex) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'mc-question-item bg-white p-4 rounded-lg shadow-md';
                    questionDiv.innerHTML = `
                        <p class="font-bold text-lg mb-3 text-gray-800">Q${qIndex + 1}. ${q.questionText}</p>
                        <div class="space-y-2">
                            ${q.options.map((option, optIndex) => `
                                <label class="flex items-center p-2 border border-gray-200 rounded-md cursor-pointer hover:bg-gray-50 transition-colors">
                                    <input type="radio" name="question-${qIndex}" value="${optIndex + 1}" class="form-radio text-blue-600 h-5 w-5" ${hasSubmitted ? 'disabled' : ''}>
                                    <span class="ml-3 text-gray-700">${option}</span>
                                </label>
                            `).join('')}
                        </div>
                    `;
                    customMcQuestionsContainer.appendChild(questionDiv);
                });

                // NEW: å¦‚æœå·²æäº¤ï¼Œæ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                if (hasSubmitted) {
                    submitCustomMcBtn.disabled = true;
                    submitCustomMcBtn.classList.replace('btn-primary', 'btn-gray');
                    submitCustomMcBtn.textContent = 'å·²æäº¤ç­”æ¡ˆ âœ“';
                    
                    // é¡¯ç¤ºå·²æäº¤çš„ç­”æ¡ˆ
                    await displaySubmittedAnswers();
                }
            } else {
                defaultMcOptions.classList.remove('hidden');
                customMcQuestionsContainer.classList.add('hidden');
                submitCustomMcBtn.classList.add('hidden');
                interactionMultipleChoice.classList.add('enlarged-buttons'); // Add enlarged class for no custom questions
            }
        }

        // NEW: æª¢æŸ¥å­¸ç”Ÿæ˜¯å¦å·²ç¶“æäº¤éç­”æ¡ˆ
        async function checkIfStudentSubmitted() {
            if (!studentName || !classroomCode) return false;
            
            try {
                const studentRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses', studentName);
                const docSnap = await getDoc(studentRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // æª¢æŸ¥æ˜¯å¦æœ‰é™£åˆ—æ ¼å¼çš„ç­”æ¡ˆï¼ˆè‡ªè¨‚é¸æ“‡é¡Œï¼‰
                    return Array.isArray(data.answer) && data.answer.length > 0;
                }
                return false;
            } catch (error) {
                console.error('æª¢æŸ¥æäº¤ç‹€æ…‹å¤±æ•—:', error);
                return false;
            }
        }

        // NEW: é¡¯ç¤ºå­¸ç”Ÿå·²æäº¤çš„ç­”æ¡ˆ
        async function displaySubmittedAnswers() {
            if (!studentName || !classroomCode) return;
            
            try {
                const studentRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses', studentName);
                const docSnap = await getDoc(studentRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (Array.isArray(data.answer)) {
                        // æ¨™è¨˜å·²é¸æ“‡çš„ç­”æ¡ˆ
                        data.answer.forEach(qAns => {
                            const radio = document.querySelector(`input[name="question-${qAns.qIndex}"][value="${qAns.ans}"]`);
                            if (radio) {
                                radio.checked = true;
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('è¼‰å…¥å·²æäº¤ç­”æ¡ˆå¤±æ•—:', error);
            }
        }


        // --- Canvas State Management Functions ---
        
        /**
         * Saves the current canvas state when switching to peer review.
         */
        function saveCanvasState() {
            if (canvas && currentInteractionMode === 'drawing') {
                try {
                    savedCanvasState = {
                        mainCanvas: canvas.toDataURL(),
                        drawingCanvas: drawingCanvas.toDataURL(),
                        studentImageCanvas: studentImageCanvas.toDataURL(),
                        canvasWidth: canvas.width,
                        canvasHeight: canvas.height
                    };
                    console.log('Canvas state saved');
                } catch (error) {
                    console.error('Error saving canvas state:', error);
                }
            }
        }
        
        /**
         * Restores the canvas state when returning from peer review.
         */
        function restoreCanvasState() {
            if (savedCanvasState && canvas && currentInteractionMode === 'drawing') {
                try {
                    // Ensure canvas setup is complete
                    if (canvas.width === 0 || canvas.height === 0) {
                        setupCanvas();
                    }
                    
                    // Restore canvas dimensions
                    canvas.width = savedCanvasState.canvasWidth;
                    canvas.height = savedCanvasState.canvasHeight;
                    drawingCanvas.width = savedCanvasState.canvasWidth;
                    drawingCanvas.height = savedCanvasState.canvasHeight;
                    studentImageCanvas.width = savedCanvasState.canvasWidth;
                    studentImageCanvas.height = savedCanvasState.canvasHeight;
                    
                    let imagesLoaded = 0;
                    const totalImages = 2; // drawing and student image
                    
                    function checkAllImagesLoaded() {
                        imagesLoaded++;
                        if (imagesLoaded === totalImages) {
                            // All images loaded, recompose the final canvas
                            redrawCanvas();
                            console.log('Canvas state restored');
                        }
                    }
                    
                    // Restore drawing canvas content
                    if (savedCanvasState.drawingCanvas && savedCanvasState.drawingCanvas !== 'data:,') {
                        const drawingImg = new Image();
                        drawingImg.onload = function() {
                            drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                            drawingCtx.drawImage(drawingImg, 0, 0);
                            checkAllImagesLoaded();
                        };
                        drawingImg.onerror = function() {
                            console.warn('Failed to load drawing canvas');
                            checkAllImagesLoaded();
                        };
                        drawingImg.src = savedCanvasState.drawingCanvas;
                    } else {
                        drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                        checkAllImagesLoaded();
                    }
                    
                    // Restore student image canvas content
                    if (savedCanvasState.studentImageCanvas && savedCanvasState.studentImageCanvas !== 'data:,') {
                        const studentImg = new Image();
                        studentImg.onload = function() {
                            studentImageCtx.clearRect(0, 0, studentImageCanvas.width, studentImageCanvas.height);
                            studentImageCtx.drawImage(studentImg, 0, 0);
                            checkAllImagesLoaded();
                        };
                        studentImg.onerror = function() {
                            console.warn('Failed to load student image canvas');
                            checkAllImagesLoaded();
                        };
                        studentImg.src = savedCanvasState.studentImageCanvas;
                    } else {
                        studentImageCtx.clearRect(0, 0, studentImageCanvas.width, studentImageCanvas.height);
                        checkAllImagesLoaded();
                    }
                    
                } catch (error) {
                    console.error('Error restoring canvas state:', error);
                    // Fallback: just redraw what we can
                    redrawCanvas();
                }
            }
        }
        
        /**
         * Redraws the main canvas by compositing all layers.
         */
        function redrawCanvas() {
            if (!canvas || !ctx) return;
            
            // Clear main canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw background (teacher's background image)
            if (teacherUploadedBackgroundImageDataURL && backgroundCanvas) {
                try {
                    ctx.drawImage(backgroundCanvas, 0, 0);
                } catch (error) {
                    console.warn('Error drawing background canvas:', error);
                }
            }
            
            // Draw student's uploaded image
            if (studentUploadedImageDataURL && studentImageCanvas) {
                try {
                    ctx.drawImage(studentImageCanvas, 0, 0);
                } catch (error) {
                    console.warn('Error drawing student image canvas:', error);
                }
            }
            
            // Draw student's drawing strokes
            if (drawingCanvas) {
                try {
                    ctx.drawImage(drawingCanvas, 0, 0);
                } catch (error) {
                    console.warn('Error drawing drawing canvas:', error);
                }
            }
        }

        // --- Peer Review Functions ---
        
        /**
         * Toggles the peer review process for the current interaction.
         * Only works for text_input and drawing modes.
         */
        async function startPeerReview() {
            if (!currentInteractionMode || (!['text_input', 'drawing'].includes(currentInteractionMode))) {
                showMessage('äº’è©•åŠŸèƒ½åªæ”¯æ´æ–‡å­—é¡Œå’Œç¹ªåœ–é¡Œï¼', 'error');
                return;
            }
            
            const startPeerReviewBtn = document.getElementById('start-peer-review-btn');
            
            if (peerReviewActive) {
                // Stop peer review
                try {
                    const peerReviewRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'peerReview');
                    await setDoc(peerReviewRef, { active: false });
                    
                    peerReviewActive = false;
                    showMessage('äº’è©•å·²åœæ­¢ï¼å­¸ç”Ÿå›åˆ°åŸäº’å‹•æ¨¡å¼ã€‚', 'info');
                    
                    // Hide voting statistics container
                    document.getElementById('peer-review-stats-container').classList.add('hidden');
                    
                    // Update button text
                    startPeerReviewBtn.innerHTML = '<i class="fas fa-heart mr-2"></i> é–‹å§‹äº’è©• â¤ï¸';
                    
                } catch (error) {
                    console.error('Error stopping peer review:', error);
                    showMessage('åœæ­¢äº’è©•æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
                }
            } else {
                // Start peer review
                if (allStudentResponses.length === 0) {
                    showMessage('ç›®å‰æ²’æœ‰å­¸ç”Ÿä½œç­”ï¼Œç„¡æ³•é–‹å§‹äº’è©•ï¼', 'error');
                    return;
                }
                
                try {
                    // Set peer review status in Firebase
                    const peerReviewRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'peerReview');
                    await setDoc(peerReviewRef, {
                        active: true,
                        mode: currentInteractionMode,
                        works: allStudentResponses,
                        timestamp: Date.now()
                    });
                    
                    peerReviewActive = true;
                    showMessage('äº’è©•å·²é–‹å§‹ï¼å­¸ç”Ÿå¯ä»¥é–‹å§‹è§€æ‘©æŠ•ç¥¨ã€‚', 'success');
                    
                    // Show voting statistics container
                    document.getElementById('peer-review-stats-container').classList.remove('hidden');
                    
                    // Start listening for votes
                    listenToPeerReviewVotes();
                    
                    // Update button text
                    startPeerReviewBtn.innerHTML = '<i class="fas fa-stop mr-2"></i> åœæ­¢äº’è©• â¹ï¸';
                    
                } catch (error) {
                    console.error('Error starting peer review:', error);
                    showMessage('é–‹å§‹äº’è©•æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
                }
            }
        }
        
        /**
         * Exits peer review mode for students and returns to original interaction mode.
         */
        function exitPeerReview() {
            if (currentInteractionMode && currentInteractionMode !== 'waiting') {
                // Return to the original interaction mode
                showView('studentInteraction');
                showInteractionUI(currentInteractionMode);
                
                // Restore canvas state if returning to drawing mode
                if (currentInteractionMode === 'drawing') {
                    // Use a small delay to ensure canvas is ready
                    setTimeout(() => {
                        restoreCanvasState();
                    }, 100);
                }
            } else {
                // Return to waiting if no active interaction
                showView('studentWaiting');
            }
        }
        
        /**
         * Listens for peer review status changes and updates student UI accordingly.
         */
        function listenToPeerReviewStatus() {
            if (!classroomCode) return;
            
            const peerReviewRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'peerReview');
            onSnapshot(peerReviewRef, (doc) => {
                if (doc.exists() && doc.data().active) {
                    const data = doc.data();
                    if (currentRole === 'student') {
                        // Save canvas state before switching to peer review (if in drawing mode)
                        if (currentInteractionMode === 'drawing') {
                            saveCanvasState();
                        }
                        
                        // Switch student to peer review view
                        showView('studentPeerReview');
                        displayPeerReviewWorks(data.works, data.mode);
                        
                        // Restore student's voting history from Firebase
                        restoreStudentVotingHistory().then(() => {
                            listenToPeerReviewVotes();
                        });
                    }
                } else {
                    // Peer review ended, return to original interaction mode
                    if (currentRole === 'student' && !views.studentPeerReview.classList.contains('hidden')) {
                        if (currentInteractionMode && currentInteractionMode !== 'waiting') {
                            // Return to the original interaction mode
                            showView('studentInteraction');
                            showInteractionUI(currentInteractionMode);
                            
                            // Restore canvas state if returning to drawing mode
                            if (currentInteractionMode === 'drawing') {
                                // Use a small delay to ensure canvas is ready
                                setTimeout(() => {
                                    restoreCanvasState();
                                }, 100);
                            }
                        } else {
                            // Return to waiting if no active interaction
                            showView('studentWaiting');
                        }
                    }
                }
            });
        }
        
        /**
         * Displays peer review works for students to vote on.
         */
        function displayPeerReviewWorks(works, mode) {
            const worksGrid = document.getElementById('peer-review-works-grid');
            worksGrid.innerHTML = '';
            
            works.forEach((work, index) => {
                // Create a more stable unique identifier using timestamp and student name
                const workId = `${work.name}-${work.timestamp || index}`;
                
                const workDiv = document.createElement('div');
                workDiv.className = 'peer-review-work-item';
                workDiv.dataset.workId = workId;
                
                let contentHtml = '';
                if (mode === 'drawing') {
                    contentHtml = `<img src="${work.answer}" alt="å­¸ç”Ÿä½œå“">`;
                } else {
                    contentHtml = `<p>${work.answer}</p>`;
                }
                
                workDiv.innerHTML = `
                    <div class="work-author">${work.name}</div>
                    <div class="work-content">${contentHtml}</div>
                    <div class="vote-section">
                        <button class="vote-btn" data-work-id="${workId}" data-tooltip="é»æ“ŠæŠ•ç¥¨/å–æ¶ˆæŠ•ç¥¨">
                            <i class="fas fa-heart"></i>
                        </button>
                        <span class="vote-count zero">0</span>
                    </div>
                `;
                
                worksGrid.appendChild(workDiv);
            });
            
            // Add vote button listeners and update vote display
            document.querySelectorAll('.vote-btn').forEach(btn => {
                btn.addEventListener('click', handleVote);
                
                // Check if student has already voted for this work
                const workId = btn.dataset.workId;
                if (studentVotedWorks.has(workId)) {
                    btn.classList.add('voted');
                }
            });
            
            // Update vote counts if available
            if (Object.keys(allPeerReviewVotes).length > 0) {
                updateStudentVoteUI(allPeerReviewVotes);
            }
            
            // Update student's vote count display
            updateVoteCountDisplay();
        }
        
        /**
         * Handles voting on a work (toggle vote/unvote).
         */
        async function handleVote(e) {
            const workId = e.currentTarget.dataset.workId;
            const voteBtn = e.currentTarget;
            const voteCountSpan = voteBtn.nextElementSibling;
            
            try {
                if (studentVotedWorks.has(workId)) {
                    // Remove vote (unvote)
                    const voteRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'peerReviewVotes', `${studentName}-${workId}`);
                    await deleteDoc(voteRef);
                    
                    // Remove from local tracking
                    studentVotedWorks.delete(workId);
                    voteBtn.classList.remove('voted');
                    updateVoteCountDisplay();
                    showMessage('å·²å–æ¶ˆæŠ•ç¥¨ï¼', 'info');
                    
                } else {
                    // Add vote
                    if (studentVotedWorks.size >= MAX_VOTES_PER_STUDENT) {
                        showMessage(`æœ€å¤šåªèƒ½æŠ•ç¥¨ ${MAX_VOTES_PER_STUDENT} å€‹ä½œå“ï¼è«‹å…ˆå–æ¶ˆå…¶ä»–æŠ•ç¥¨ã€‚`, 'warning');
                        return;
                    }
                    
                    const voteRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'peerReviewVotes', `${studentName}-${workId}`);
                    await setDoc(voteRef, {
                        voterName: studentName,
                        workId: workId,
                        timestamp: Date.now()
                    });
                    
                    // Mark as voted locally
                    studentVotedWorks.add(workId);
                    voteBtn.classList.add('voted');
                    updateVoteCountDisplay();
                    showMessage('æŠ•ç¥¨æˆåŠŸï¼', 'success');
                }
                
            } catch (error) {
                console.error('Error handling vote:', error);
                showMessage('æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
            }
        }
        
        /**
         * Listens for peer review votes and updates UI.
         */
        function listenToPeerReviewVotes() {
            if (!classroomCode) return;
            
            const votesRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'peerReviewVotes');
            
            if (peerReviewUnsubscribe) {
                peerReviewUnsubscribe();
            }
            
            peerReviewUnsubscribe = onSnapshot(votesRef, (snapshot) => {
                const votes = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (!votes[data.workId]) {
                        votes[data.workId] = 0;
                    }
                    votes[data.workId]++;
                });
                
                allPeerReviewVotes = votes;
                
                // Update student UI
                if (currentRole === 'student' && !views.studentPeerReview.classList.contains('hidden')) {
                    updateStudentVoteUI(votes);
                    updateVoteCountDisplay();
                }
                
                // Update teacher UI
                if (currentRole === 'teacher' && !document.getElementById('peer-review-stats-container').classList.contains('hidden')) {
                    updateTeacherVoteStats(votes);
                }
            });
        }
        
        /**
         * Updates the vote counts in student UI.
         */
        function updateStudentVoteUI(votes) {
            document.querySelectorAll('.vote-count').forEach(span => {
                const workId = span.previousElementSibling.dataset.workId;
                const count = votes[workId] || 0;
                span.textContent = count;
                span.classList.toggle('zero', count === 0);
            });
        }
        
        /**
         * Updates the student's current vote count display.
         */
        function updateVoteCountDisplay() {
            const voteCountElement = document.getElementById('current-vote-count');
            if (voteCountElement) {
                voteCountElement.textContent = studentVotedWorks.size;
                
                // Change color based on vote count
                const container = voteCountElement.parentElement;
                container.className = 'inline-block px-4 py-2 rounded-full text-sm font-medium';
                
                if (studentVotedWorks.size === 0) {
                    container.classList.add('bg-gray-100', 'text-gray-600');
                } else if (studentVotedWorks.size < MAX_VOTES_PER_STUDENT) {
                    container.classList.add('bg-blue-100', 'text-blue-800');
                } else {
                    container.classList.add('bg-green-100', 'text-green-800');
                }
            }
        }
        
        /**
         * Restores student's voting history from Firebase.
         */
        async function restoreStudentVotingHistory() {
            if (!classroomCode || !studentName) return;
            
            try {
                const votesRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'peerReviewVotes');
                const votesSnapshot = await getDocs(votesRef);
                
                // Clear existing voting history
                studentVotedWorks.clear();
                
                // Find votes made by this student
                votesSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.voterName === studentName) {
                        studentVotedWorks.add(data.workId);
                    }
                });
                
                console.log('Restored student voting history:', Array.from(studentVotedWorks));
                
                // Update vote count display after restoration
                updateVoteCountDisplay();
            } catch (error) {
                console.error('Error restoring student voting history:', error);
            }
        }

        /**
         * Updates the teacher's vote statistics display.
         */
        function updateTeacherVoteStats(votes) {
            const statsGrid = document.getElementById('peer-review-stats-grid');
            statsGrid.innerHTML = '';
            
            // Sort works by vote count (descending)
            const sortedWorks = allStudentResponses.map(work => {
                const workId = `${work.name}-${work.timestamp || allStudentResponses.indexOf(work)}`;
                return {
                    ...work,
                    workId: workId,
                    votes: votes[workId] || 0
                };
            }).sort((a, b) => b.votes - a.votes);
            
            sortedWorks.forEach((work, index) => {
                const statsDiv = document.createElement('div');
                statsDiv.className = 'vote-stats-item';
                
                let contentHtml = '';
                if (currentInteractionMode === 'drawing') {
                    contentHtml = `<img src="${work.answer}" alt="å­¸ç”Ÿä½œå“">`;
                } else {
                    contentHtml = `<p>${work.answer}</p>`;
                }
                
                statsDiv.innerHTML = `
                    <div class="stats-author">${work.name}</div>
                    <div class="stats-content">${contentHtml}</div>
                    <div class="stats-votes">
                        <i class="fas fa-heart vote-icon"></i>
                        <span class="vote-count ${work.votes === 0 ? 'zero' : ''}">${work.votes}</span>
                    </div>
                `;
                
                statsGrid.appendChild(statsDiv);
            });
        }

        // --- Initialization Function ---
        async function initialize() {
            loadAISettings(); 
            loadDispatchSettings(); // Load saved combined dispatch settings

            onAuthStateChanged(auth, async user => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id-display').textContent = userId;
                    console.log("Authenticated User ID:", userId);
                    // setupEventListeners(); // Moved this call outside onAuthStateChanged

                    // Check if teacher has a persisted classroom code
                    const savedTeacherClassroomCode = localStorage.getItem('teacherClassroomCode');
                    if (savedTeacherClassroomCode) {
                        classroomCode = savedTeacherClassroomCode;
                        currentRole = 'teacher';
                        document.getElementById('end-class-button-text').textContent = `ä¸‹èª² æ•™å®¤ä»£ç¢¼: ${classroomCode}`; // Update button text
                        document.getElementById('end-class-monitor-button-text').textContent = `ä¸‹èª² æ•™å®¤ä»£ç¢¼: ${classroomCode}`; // Update button text for monitor view
                        
                        // NEW: Fetch initial pause state and dispatch settings for teacher
                        const controlRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
                        const docSnap = await getDoc(controlRef);
                        if (docSnap.exists()) {
                            isResponsePaused = docSnap.data().isPaused || false;
                            // MODIFIED: Load dispatchSettings from Firestore
                            const fetchedDispatchSettings = docSnap.data().dispatchSettings;
                            if (fetchedDispatchSettings) {
                                dispatchSettings.type = fetchedDispatchSettings.type || 'url';
                                dispatchSettings.url = fetchedDispatchSettings.url || '';
                                dispatchSettings.isYoutube = fetchedDispatchSettings.isYoutube || false;
                                dispatchSettings.htmlContent = fetchedDispatchSettings.htmlContent || null;
                            }
                            // NEW: Load custom multiple choice questions from Firestore
                            currentMultipleChoiceQuestions = docSnap.data().multiple_choice_questions || null;
                            customMultipleChoiceQuestions = currentMultipleChoiceQuestions || []; // Sync for teacher UI
                        } else {
                            isResponsePaused = false; // Default to not paused if control doc doesn't exist
                            // dispatchSettings remains at its default or loaded localStorage value
                            currentMultipleChoiceQuestions = null;
                            customMultipleChoiceQuestions = [];
                        }
                        updateTeacherPauseButtonUI(); // Update button UI based on fetched state

                        listenToClassroomPresence(); // Ensure presence listener is established here and remains active
                        showView('teacherMenu');
                    } else {
                        showView('entry');
                    }
                } else {
                    console.error("Authentication failed, user is null.");
                    // If user is null (e.g., after signOut), ensure we are on the entry view.
                    showView('entry'); 
                }
            });

            document.getElementById('app-id-display').textContent = baseAppId; // Display the base app ID
            
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }
            } catch (error) {
                console.error("Firebase Authentication failed:", error);
                document.body.innerHTML = `<div class="text-center p-8 text-red-600"><h1 class="text-2xl font-bold">é©—è­‰å¤±æ•—</h1><p>ç„¡æ³•é€£æ¥è‡³äº’å‹•æœå‹™ï¼Œè«‹æª¢æŸ¥ Firebase è¨­å®šæˆ–ç¶²è·¯é€£ç·šã€‚</p><p class=\"text-sm mt-2\">${error.message}</p></div>`;
            }
        }

        // Add beforeunload handler to warn user about closing window
        let hasEndedClass = false;
        
        // Track when user clicks the end class button
        function markClassEnded() {
            hasEndedClass = true;
        }
        
        // Set up window close warning
        window.onbeforeunload = function() {
            if (!hasEndedClass) {
                return 'è«‹å…ˆæŒ‰ä¸‹ç´…è‰²ä¸‹èª²éµï¼Œå†é—œé–‰è¦–çª—ï¼Œæœ¬æç¤ºè«‹å…ˆæŒ‰å–æ¶ˆ';
            }
        };

        // --- Quick Answer Functions ---
        let quickAnswerActive = false;
        let quickAnswerWinner = null;
        let quickAnswerWinnerDisplayed = false;

        function startQuickAnswer() {
            quickAnswerActive = true;
            quickAnswerWinner = null;
            quickAnswerWinnerDisplayed = false;

            // Update status text
            document.getElementById('quick-answer-status-text').textContent = 'æ¶ç­”é–‹å§‹ï¼å¿«é»æ“ŠæŒ‰éˆ•ï¼';

            // Generate random position for the button
            const container = document.getElementById('quick-answer-button-container');
            container.innerHTML = '';
            container.classList.remove('pointer-events-none');

            // Create the quick answer button
            const button = document.createElement('button');
            button.className = 'quick-answer-btn';
            button.textContent = 'å¿«é»æˆ‘';

            // Calculate random position (ensure button is fully visible)
            const containerRect = container.getBoundingClientRect();
            const buttonSize = 200; // 200px width and height
            const maxLeft = containerRect.width - buttonSize;
            const maxTop = containerRect.height - buttonSize;

            const randomLeft = Math.random() * Math.max(0, maxLeft);
            const randomTop = Math.random() * Math.max(0, maxTop);

            button.style.left = randomLeft + 'px';
            button.style.top = randomTop + 'px';

            // Add click handler
            button.addEventListener('click', handleQuickAnswerClick);

            container.appendChild(button);
        }

        async function handleQuickAnswerClick() {
            if (!quickAnswerActive || quickAnswerWinner) return;

            try {
                // Submit the quick answer to Firebase
                const response = `æ¶ç­”æˆåŠŸï¼š${studentName}`;
                console.log('Submitting quick answer:', response);
                await submitAnswer(response);
                console.log('Quick answer submitted successfully');

                // Show success message
                document.getElementById('quick-answer-result').classList.remove('hidden');
                document.getElementById('quick-answer-status-text').textContent = 'ä½ æ¶ç­”æˆåŠŸäº†ï¼';

                // Lock the button
                lockQuickAnswerButton();

            } catch (error) {
                console.error('Failed to submit quick answer:', error);
                showMessage('æ¶ç­”æäº¤å¤±æ•—ï¼', 'error');
            }
        }

        function lockQuickAnswerButton() {
            const button = document.querySelector('.quick-answer-btn');
            if (button) {
                button.classList.add('locked');
                button.disabled = true;
                button.removeEventListener('click', handleQuickAnswerClick);
            }

            // Show locked message for other students
            document.getElementById('quick-answer-locked').classList.remove('hidden');
            document.getElementById('quick-answer-result').classList.add('hidden');
        }

        // Listen for quick answer winner updates
        function listenToQuickAnswerUpdates() {
            if (currentRole !== 'student' || currentInteractionMode !== 'quick_answer') return;

            const responsesRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses');
            onSnapshot(responsesRef, (snapshot) => {
                if (snapshot.empty) return;

                const responses = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.answer && data.answer.includes('æ¶ç­”æˆåŠŸ')) {
                        responses.push(data);
                    }
                });

                // If someone already answered and it's not this student, lock the button
                if (responses.length > 0 && !quickAnswerWinner) {
                    const winner = responses[0];
                    if (winner.name !== studentName) {
                        quickAnswerWinner = winner.name;
                        lockQuickAnswerButton();
                        document.getElementById('quick-answer-status-text').textContent = `${winner.name} æ¶ç­”æˆåŠŸï¼`;
                    }
                }
            });
        }

        function showQuickAnswerWinner(winnerName) {
            console.log('showQuickAnswerWinner called with:', winnerName);
            if (quickAnswerWinnerDisplayed) {
                console.log('Winner already displayed, skipping');
                return; // Prevent showing multiple times
            }
            quickAnswerWinnerDisplayed = true;
            console.log('Displaying winner overlay');

            // Create a big overlay notification for the teacher
            const overlay = document.createElement('div');
            overlay.id = 'quick-answer-winner-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                animation: fadeIn 0.5s ease-in-out;
            `;

            overlay.innerHTML = `
                <div style="text-align: center; color: white; font-size: 3rem; font-weight: bold;">
                    <i class="fas fa-trophy" style="color: #ffd700; font-size: 6rem; margin-bottom: 20px;"></i>
                    <h1 style="margin: 20px 0; color: #4ade80;">æ¶ç­”æˆåŠŸï¼</h1>
                    <h2 style="margin: 20px 0; color: #60a5fa; font-size: 4rem;">${winnerName}</h2>
                    <p style="font-size: 1.5rem; color: #d1d5db;">é»æ“Šä»»æ„ä½ç½®é—œé–‰</p>
                </div>
                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; transform: scale(0.8); }
                        to { opacity: 1; transform: scale(1); }
                    }
                </style>
            `;

            // Add click handler to close the overlay
            overlay.addEventListener('click', () => {
                overlay.remove();
                quickAnswerWinnerDisplayed = false; // Reset for next round
            });

            document.body.appendChild(overlay);

            // Auto close after 5 seconds
            setTimeout(() => {
                if (overlay.parentElement) {
                    overlay.remove();
                    quickAnswerWinnerDisplayed = false;
                }
            }, 5000);
        }

        // --- Quick Poll Functions ---

        /**
         * Shows the quick poll settings modal
         */
        function showQuickPollSettingsModal() {
            document.getElementById('quick-poll-settings-modal').classList.remove('hidden');
            // Reset form
            document.querySelector('input[name="pollType"][value="emoji"]').checked = true;
            document.getElementById('custom-poll-options-section').classList.add('hidden');
            document.getElementById('custom-poll-options-input').value = '';
            document.getElementById('quick-poll-anonymous-checkbox').checked = true;
        }

        /**
         * Hides the quick poll settings modal
         */
        function hideQuickPollSettingsModal() {
            document.getElementById('quick-poll-settings-modal').classList.add('hidden');
        }

        /**
         * Gets poll options based on selected type
         */
        function getPollOptions(pollType, customOptions = '') {
            switch(pollType) {
                case 'emoji':
                    return ['ğŸ˜Š', 'ğŸ˜', 'ğŸ˜•'];
                case 'simple':
                    return ['åŒæ„', 'ä¸åŒæ„', 'ä¸ç¢ºå®š'];
                case 'rating5':
                    return ['1', '2', '3', '4', '5'];
                case 'rating10':
                    return ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10'];
                case 'custom':
                    return customOptions.split('\n').filter(opt => opt.trim() !== '').map(opt => opt.trim());
                default:
                    return [];
            }
        }

        /**
         * Starts a quick poll
         */
        async function startQuickPoll() {
            const question = 'å¿«é€ŸæŠ•ç¥¨';
            const pollType = document.querySelector('input[name="pollType"]:checked').value;
            const anonymous = document.getElementById('quick-poll-anonymous-checkbox').checked;
            const customOptions = document.getElementById('custom-poll-options-input').value;

            // Validation
            const options = getPollOptions(pollType, customOptions);
            if (options.length === 0) {
                showMessage('è«‹è¨­å®šæœ‰æ•ˆçš„æŠ•ç¥¨é¸é …ï¼', 'error');
                return;
            }

            try {
                // Initialize vote counts
                const voteCounts = {};
                options.forEach(opt => voteCounts[opt] = 0);

                // Save poll configuration to Firebase
                quickPollData = {
                    question,
                    pollType,
                    options,
                    anonymous,
                    voteCounts,
                    active: true,
                    timestamp: Date.now()
                };

                const pollRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'quickPoll', 'config');
                await setDoc(pollRef, quickPollData);

                // Clear previous votes
                const votesRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'quickPollVotes');
                const votesSnapshot = await getDocs(votesRef);
                const deletePromises = votesSnapshot.docs.map(doc => deleteDoc(doc.ref));
                await Promise.all(deletePromises);

                // Set interaction mode to quick_poll
                await setInteractionMode('quick_poll');

                quickPollActive = true;
                hideQuickPollSettingsModal();

                // Show stats modal for teacher
                showQuickPollStatsModal();

                // Start listening to votes
                listenToQuickPollVotes();

                showMessage('å¿«é€ŸæŠ•ç¥¨å·²é–‹å§‹ï¼', 'success');
            } catch (error) {
                console.error('Error starting quick poll:', error);
                showMessage('å•Ÿå‹•å¿«é€ŸæŠ•ç¥¨æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
            }
        }

        /**
         * Shows the quick poll statistics modal
         */
        function showQuickPollStatsModal() {
            const modal = document.getElementById('quick-poll-stats-modal');
            modal.classList.remove('hidden');

            // Display question
            document.getElementById('quick-poll-stats-question').textContent = quickPollData.question;

            // Display online student count
            document.getElementById('poll-online-students').textContent = activeStudentNames.length;

            // Initialize chart
            currentChartType = 'bar';
            updateChartButtonStyles();
            updateQuickPollChart();
        }

        /**
         * Hides the quick poll statistics modal
         */
        function hideQuickPollStatsModal() {
            document.getElementById('quick-poll-stats-modal').classList.add('hidden');
        }

        /**
         * Ends the current quick poll
         */
        async function endQuickPoll() {
            try {
                // Set poll as inactive
                const pollRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'quickPoll', 'config');
                await setDoc(pollRef, { active: false }, { merge: true });

                // Stop interaction
                await setInteractionMode('waiting');

                quickPollActive = false;
                hideQuickPollStatsModal();

                // Unsubscribe from votes listener
                if (quickPollVotesUnsubscribe) {
                    quickPollVotesUnsubscribe();
                    quickPollVotesUnsubscribe = null;
                }

                showMessage('å¿«é€ŸæŠ•ç¥¨å·²çµæŸï¼', 'info');
            } catch (error) {
                console.error('Error ending quick poll:', error);
                showMessage('çµæŸæŠ•ç¥¨æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
            }
        }

        /**
         * Listens for vote updates
         */
        function listenToQuickPollVotes() {
            if (!classroomCode || !quickPollData) return;

            const votesRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'quickPollVotes');

            if (quickPollVotesUnsubscribe) {
                quickPollVotesUnsubscribe();
            }

            quickPollVotesUnsubscribe = onSnapshot(votesRef, (snapshot) => {
                // Aggregate votes
                const voteCounts = {};
                quickPollData.options.forEach(opt => voteCounts[opt] = 0);

                snapshot.forEach(doc => {
                    const voteData = doc.data();
                    if (voteData.option && voteCounts.hasOwnProperty(voteData.option)) {
                        voteCounts[voteData.option]++;
                    }
                });

                // Update quickPollData
                quickPollData.voteCounts = voteCounts;

                // Update UI if teacher is viewing stats
                if (currentRole === 'teacher' && !document.getElementById('quick-poll-stats-modal').classList.contains('hidden')) {
                    updateQuickPollChart();
                    updateQuickPollTable();
                }
            });
        }

        /**
         * Updates the quick poll chart
         */
        function updateQuickPollChart() {
            if (!quickPollData) return;

            const svg = d3.select("#quick-poll-chart-svg");
            svg.selectAll("*").remove(); // Clear previous chart

            const data = quickPollData.options.map(opt => ({
                label: opt,
                value: quickPollData.voteCounts[opt] || 0
            }));

            const totalVotes = data.reduce((sum, d) => sum + d.value, 0);
            document.getElementById('poll-total-votes').textContent = totalVotes;

            if (currentChartType === 'bar') {
                drawQuickPollBarChart(svg, data);
            } else {
                drawQuickPollPieChart(svg, data);
            }
        }

        /**
         * Draws a bar chart for quick poll
         */
        function drawQuickPollBarChart(svg, data) {
            const width = 800;
            const height = 450;
            const margin = {top: 20, right: 20, bottom: 60, left: 60};
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;

            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            // X scale
            const x = d3.scaleBand()
                .range([0, chartWidth])
                .padding(0.2)
                .domain(data.map(d => d.label));

            // Y scale
            const maxValue = d3.max(data, d => d.value) || 1;
            const y = d3.scaleLinear()
                .range([chartHeight, 0])
                .domain([0, maxValue]);

            // Color scale
            const color = d3.scaleOrdinal()
                .domain(data.map(d => d.label))
                .range(['#84cc16', '#22c55e', '#10b981', '#14b8a6', '#06b6d4', '#0ea5e9', '#3b82f6', '#6366f1', '#8b5cf6', '#a855f7']);

            // X axis
            g.append("g")
                .attr("transform", `translate(0,${chartHeight})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .style("font-size", "14px")
                .attr("transform", "rotate(-45)")
                .style("text-anchor", "end");

            // Y axis
            g.append("g")
                .call(d3.axisLeft(y).ticks(5))
                .selectAll("text")
                .style("font-size", "14px");

            // Bars
            g.selectAll(".bar")
                .data(data)
                .enter()
                .append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.label))
                .attr("y", d => y(d.value))
                .attr("width", x.bandwidth())
                .attr("height", d => chartHeight - y(d.value))
                .attr("fill", d => color(d.label))
                .attr("rx", 4);

            // Value labels on top of bars
            g.selectAll(".label")
                .data(data)
                .enter()
                .append("text")
                .attr("class", "label")
                .attr("x", d => x(d.label) + x.bandwidth() / 2)
                .attr("y", d => y(d.value) - 5)
                .attr("text-anchor", "middle")
                .style("font-size", "16px")
                .style("font-weight", "bold")
                .style("fill", "#374151")
                .text(d => d.value);
        }

        /**
         * Draws a pie chart for quick poll
         */
        function drawQuickPollPieChart(svg, data) {
            const width = 800;
            const height = 450;
            const radius = Math.min(width, height) / 2 - 40;

            const g = svg.append("g").attr("transform", `translate(${width / 2},${height / 2})`);

            // Color scale
            const color = d3.scaleOrdinal()
                .domain(data.map(d => d.label))
                .range(['#84cc16', '#22c55e', '#10b981', '#14b8a6', '#06b6d4', '#0ea5e9', '#3b82f6', '#6366f1', '#8b5cf6', '#a855f7']);

            const pie = d3.pie().value(d => d.value).sort(null);
            const arc = d3.arc().innerRadius(0).outerRadius(radius);
            const labelArc = d3.arc().innerRadius(radius * 0.6).outerRadius(radius * 0.6);

            const arcs = g.selectAll(".arc")
                .data(pie(data))
                .enter()
                .append("g")
                .attr("class", "arc");

            arcs.append("path")
                .attr("d", arc)
                .attr("fill", d => color(d.data.label))
                .attr("stroke", "white")
                .attr("stroke-width", 2);

            // Labels
            arcs.append("text")
                .attr("transform", d => `translate(${labelArc.centroid(d)})`)
                .attr("text-anchor", "middle")
                .style("font-size", "14px")
                .style("font-weight", "bold")
                .style("fill", "white")
                .each(function(d) {
                    const text = d3.select(this);
                    text.append("tspan")
                        .attr("x", 0)
                        .attr("dy", "-0.2em")
                        .text(d.data.label);
                    text.append("tspan")
                        .attr("x", 0)
                        .attr("dy", "1.2em")
                        .text(d.data.value);
                });
        }

        /**
         * Updates the quick poll data table
         */
        function updateQuickPollTable() {
            if (!quickPollData) return;

            const tbody = document.getElementById('quick-poll-stats-table-body');
            tbody.innerHTML = '';

            const totalVotes = Object.values(quickPollData.voteCounts).reduce((sum, val) => sum + val, 0);

            quickPollData.options.forEach(opt => {
                const count = quickPollData.voteCounts[opt] || 0;
                const percentage = totalVotes > 0 ? ((count / totalVotes) * 100).toFixed(1) : '0.0';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="border px-4 py-2">${opt}</td>
                    <td class="border px-4 py-2 text-right font-bold">${count}</td>
                    <td class="border px-4 py-2 text-right">${percentage}%</td>
                `;
                tbody.appendChild(row);
            });
        }

        /**
         * Switches between chart types
         */
        function switchChartType(type) {
            currentChartType = type;
            updateChartButtonStyles();
            updateQuickPollChart();
        }

        /**
         * Updates chart type button styles
         */
        function updateChartButtonStyles() {
            const barBtn = document.getElementById('chart-type-bar-btn');
            const pieBtn = document.getElementById('chart-type-pie-btn');

            if (currentChartType === 'bar') {
                barBtn.classList.remove('btn-gray');
                barBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                pieBtn.classList.add('btn-gray');
                pieBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            } else {
                pieBtn.classList.remove('btn-gray');
                pieBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                barBtn.classList.add('btn-gray');
                barBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            }
        }

        /**
         * Downloads poll results as CSV
         */
        async function downloadPollResults() {
            if (!quickPollData) return;

            const totalVotes = Object.values(quickPollData.voteCounts).reduce((sum, val) => sum + val, 0);

            let csv = '\uFEFF'; // BOM for Excel UTF-8 support
            csv += `å¿«é€ŸæŠ•ç¥¨çµæœ\n`;
            csv += `å•é¡Œ,${quickPollData.question}\n`;
            csv += `ç¸½æŠ•ç¥¨æ•¸,${totalVotes}\n`;
            csv += `æŠ•ç¥¨æ¨¡å¼,${quickPollData.anonymous ? 'åŒ¿å' : 'è¨˜å'}\n`;
            csv += `\n`;

            // Summary table
            csv += `é¸é …çµ±è¨ˆ\n`;
            csv += `é¸é …,ç¥¨æ•¸,ç™¾åˆ†æ¯”\n`;
            quickPollData.options.forEach(opt => {
                const count = quickPollData.voteCounts[opt] || 0;
                const percentage = totalVotes > 0 ? ((count / totalVotes) * 100).toFixed(1) : '0.0';
                csv += `${opt},${count},${percentage}%\n`;
            });

            // Detailed votes if not anonymous
            if (!quickPollData.anonymous) {
                csv += `\nè©³ç´°æŠ•ç¥¨è¨˜éŒ„\n`;
                csv += `å­¸ç”Ÿå§“å,é¸é …,æŠ•ç¥¨æ™‚é–“\n`;

                try {
                    const votesRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'quickPollVotes');
                    const votesSnapshot = await getDocs(votesRef);

                    votesSnapshot.forEach(doc => {
                        const voteData = doc.data();
                        const studentName = voteData.studentName || 'æœªçŸ¥';
                        const option = voteData.option || '';
                        const timestamp = voteData.timestamp ? new Date(voteData.timestamp).toLocaleString('zh-TW') : '';
                        csv += `${studentName},${option},${timestamp}\n`;
                    });
                } catch (error) {
                    console.error('Error fetching vote details:', error);
                }
            }

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `å¿«é€ŸæŠ•ç¥¨çµæœ_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();

            showMessage('æŠ•ç¥¨çµæœå·²ä¸‹è¼‰ï¼', 'success');
        }

        /**
         * Student submits a vote
         */
        async function submitQuickPollVote(option) {
            if (!classroomCode || !studentName) return;

            const pollKey = `quickPoll_${classroomCode}_${quickPollData.timestamp}`;

            // Check if already voted (using localStorage)
            if (localStorage.getItem(pollKey)) {
                showMessage('æ‚¨å·²ç¶“æŠ•éç¥¨äº†ï¼', 'info');
                return;
            }

            try {
                // Generate unique vote ID (anonymous or with student name based on settings)
                const voteId = quickPollData.anonymous
                    ? `anonymous_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                    : `${studentName}_${Date.now()}`;

                const voteRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'quickPollVotes', voteId);
                const voteData = {
                    option,
                    timestamp: Date.now()
                };

                // Add student name if not anonymous
                if (!quickPollData.anonymous) {
                    voteData.studentName = studentName;
                }

                await setDoc(voteRef, voteData);

                // Mark as voted in localStorage
                localStorage.setItem(pollKey, 'true');

                // Hide options, show success message
                document.getElementById('quick-poll-options-container').classList.add('hidden');
                document.getElementById('quick-poll-voted-status').classList.remove('hidden');

                showMessage('æŠ•ç¥¨æˆåŠŸï¼æ„Ÿè¬æ‚¨çš„åƒèˆ‡', 'success');
            } catch (error) {
                console.error('Error submitting vote:', error);
                showMessage('æŠ•ç¥¨å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
            }
        }

        /**
         * Displays quick poll for students
         */
        function displayQuickPollForStudent(pollData) {
            if (!pollData || !pollData.active) return;

            quickPollData = pollData;

            // Use timestamp to create unique key for each poll session
            const pollKey = `quickPoll_${classroomCode}_${pollData.timestamp}`;
            const hasVoted = localStorage.getItem(pollKey);

            // Display question
            document.getElementById('quick-poll-question-display').textContent = pollData.question;

            const optionsContainer = document.getElementById('quick-poll-options-container');
            optionsContainer.innerHTML = '';

            if (hasVoted) {
                // Already voted - show success message
                optionsContainer.classList.add('hidden');
                document.getElementById('quick-poll-voted-status').classList.remove('hidden');
            } else {
                // Not voted yet - show options
                optionsContainer.classList.remove('hidden');
                document.getElementById('quick-poll-voted-status').classList.add('hidden');

                // Create buttons based on poll type
                if (pollData.pollType === 'emoji') {
                    optionsContainer.className = 'flex justify-center gap-6';
                    pollData.options.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = 'text-8xl hover:scale-110 transition-transform duration-200 p-4 rounded-lg hover:bg-gray-100';
                        btn.textContent = opt;
                        btn.addEventListener('click', () => submitQuickPollVote(opt));
                        optionsContainer.appendChild(btn);
                    });
                } else if (pollData.pollType === 'rating5' || pollData.pollType === 'rating10') {
                    optionsContainer.className = 'flex justify-center gap-3 flex-wrap';
                    pollData.options.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = 'btn bg-lime-500 hover:bg-lime-600 !w-20 !h-20 text-4xl font-bold';
                        btn.textContent = opt;
                        btn.addEventListener('click', () => submitQuickPollVote(opt));
                        optionsContainer.appendChild(btn);
                    });
                } else {
                    optionsContainer.className = 'space-y-3';
                    pollData.options.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = 'btn bg-lime-500 hover:bg-lime-600 w-full h-16 text-2xl';
                        btn.textContent = opt;
                        btn.addEventListener('click', () => submitQuickPollVote(opt));
                        optionsContainer.appendChild(btn);
                    });
                }
            }
        }

        /**
         * Listens for quick poll configuration changes (for students)
         */
        function listenToQuickPollConfig() {
            if (!classroomCode) return;

            const pollRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'quickPoll', 'config');
            onSnapshot(pollRef, (doc) => {
                if (doc.exists()) {
                    const pollData = doc.data();
                    if (pollData.active && currentRole === 'student' && currentInteractionMode === 'quick_poll') {
                        displayQuickPollForStudent(pollData);
                    }
                }
            });
        }

        // === Reading Comprehension Functions ===

        /**
         * Show reading comprehension settings modal
         */
        function showReadingComprehensionModal() {
            document.getElementById('reading-comprehension-settings-modal').classList.remove('hidden');
            // Populate with existing data if any
            document.getElementById('reading-text-textarea').value = readingComprehensionData.text || '';
            if (readingComprehensionData.questions && readingComprehensionData.questions.length > 0) {
                document.getElementById('reading-questions-textarea').value = readingComprehensionData.questions.map(q => {
                    return `${q.question},${q.correctAnswer},${q.options.join(',')},${q.level}`;
                }).join('\n');
            } else {
                document.getElementById('reading-questions-textarea').value = '';
            }
        }

        /**
         * Hide reading comprehension settings modal
         */
        function hideReadingComprehensionModal() {
            document.getElementById('reading-comprehension-settings-modal').classList.add('hidden');
        }

        /**
         * Parse reading comprehension questions
         * Supports both comma and tab delimiters
         */
        function parseReadingQuestions(text) {
            const lines = text.trim().split('\n').filter(line => line.trim().length > 0);
            const questions = [];

            for (const line of lines) {
                // Try to detect delimiter: if line contains tab, use tab; otherwise use comma
                const delimiter = line.includes('\t') ? '\t' : ',';
                const parts = line.split(delimiter).map(p => p.trim());

                if (parts.length < 6) {
                    return null; // Invalid format - need at least question, answer, and 4 options
                }

                const question = parts[0];
                let correctAnswer = parts[1];
                const options = [parts[2], parts[3], parts[4], parts[5]];
                // Level is optional, default to 1 if not provided
                const level = parts[6] ? parseInt(parts[6]) : 1;

                // Convert A-D to 1-4
                if (correctAnswer.match(/^[A-Da-d]$/)) {
                    correctAnswer = correctAnswer.toUpperCase().charCodeAt(0) - 64; // A=1, B=2, C=3, D=4
                } else {
                    correctAnswer = parseInt(correctAnswer);
                }

                if (!question || isNaN(correctAnswer) || correctAnswer < 1 || correctAnswer > 4 ||
                    options.length !== 4 || isNaN(level) || level < 1 || level > 4) {
                    return null; // Invalid format
                }

                questions.push({ question, correctAnswer, options, level });
            }

            return questions.length > 0 ? questions : null;
        }

        /**
         * Start reading comprehension interaction
         */
        async function startReadingComprehension() {
            const readingText = document.getElementById('reading-text-textarea').value.trim();
            const questionsText = document.getElementById('reading-questions-textarea').value.trim();

            if (!readingText || !questionsText) {
                showMessage('è«‹è¼¸å…¥é–±è®€æ–‡æœ¬å’Œé¡Œç›®ï¼', 'error');
                return;
            }

            const questions = parseReadingQuestions(questionsText);
            if (!questions) {
                document.getElementById('reading-questions-status').classList.remove('hidden');
                return;
            }

            readingComprehensionData = { text: readingText, questions: questions };
            document.getElementById('reading-questions-status').classList.add('hidden');
            hideReadingComprehensionModal();

            // Set mode and dispatch to Firebase
            const mode = 'reading_comprehension';
            await setInteractionMode(mode, { readingData: readingComprehensionData });
            showView('teacherMonitor');
        }

        /**
         * Display reading comprehension for student
         */
        async function displayReadingComprehensionForStudent(readingData) {
            console.log('[displayReadingComprehensionForStudent] Called with data:', readingData);
            const textDisplay = document.getElementById('reading-text-display');
            const questionsContainer = document.getElementById('reading-questions-container');

            if (!textDisplay || !questionsContainer) {
                console.error('[displayReadingComprehensionForStudent] Elements not found!');
                return;
            }

            // Store reading data for student to use when submitting
            if (currentRole === 'student') {
                readingComprehensionData = readingData;
            }

            textDisplay.textContent = readingData.text;
            questionsContainer.innerHTML = '';
            console.log('[displayReadingComprehensionForStudent] Set text:', readingData.text);

            // Determine which answers to restore
            let answersToRestore = [];

            // Priority 1: Use current local answers (not yet submitted)
            if (currentReadingAnswers.length > 0) {
                answersToRestore = currentReadingAnswers;
                console.log('[displayReadingComprehensionForStudent] Restoring local answers:', answersToRestore);
            }
            // Priority 2: Check if student has already submitted answers to Firebase
            else if (currentRole === 'student' && studentName && classroomCode) {
                try {
                    const studentRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses', studentName);
                    const docSnap = await getDoc(studentRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        // Check if answer is a JSON string or array
                        if (typeof data.answer === 'string') {
                            try {
                                answersToRestore = JSON.parse(data.answer);
                            } catch (e) {
                                answersToRestore = [];
                            }
                        } else if (Array.isArray(data.answer)) {
                            answersToRestore = data.answer;
                        }
                        console.log('[displayReadingComprehensionForStudent] Restoring submitted answers:', answersToRestore);
                    }
                } catch (error) {
                    console.error('Error fetching previous answers:', error);
                }
            }

            // Initialize currentReadingAnswers if empty
            if (currentReadingAnswers.length === 0) {
                currentReadingAnswers = new Array(readingData.questions.length).fill(0);
            }

            readingData.questions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'bg-white p-4 rounded-lg border';

                // Get answer for this question (if exists)
                const selectedAnswer = answersToRestore[index] || 0;

                questionDiv.innerHTML = `
                    <p class="font-bold text-lg mb-3">${index + 1}. ${q.question}</p>
                    <div class="space-y-2">
                        ${q.options.map((opt, i) => {
                            const isChecked = selectedAnswer === (i + 1) ? 'checked' : '';
                            return `
                            <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="radio" name="reading_q${index}" value="${i + 1}" class="mr-3" ${isChecked} data-question-index="${index}">
                                <span>${i + 1}. ${opt}</span>
                            </label>
                        `}).join('')}
                    </div>
                `;
                questionsContainer.appendChild(questionDiv);
            });

            // Add event listeners to track answer changes
            const radioInputs = questionsContainer.querySelectorAll('input[type="radio"]');
            radioInputs.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const questionIndex = parseInt(e.target.dataset.questionIndex);
                    const selectedValue = parseInt(e.target.value);
                    currentReadingAnswers[questionIndex] = selectedValue;
                    console.log('[Reading] Answer updated:', questionIndex, '=', selectedValue);
                });
            });
        }

        /**
         * Submit reading comprehension answer
         */
        async function submitReadingAnswer() {
            const questionsContainer = document.getElementById('reading-questions-container');
            const answers = [];

            // Collect all answers
            for (let i = 0; i < readingComprehensionData.questions.length; i++) {
                const selected = document.querySelector(`input[name="reading_q${i}"]:checked`);
                if (selected) {
                    answers.push(parseInt(selected.value));
                } else {
                    answers.push(0); // No answer
                }
            }

            if (answers.filter(a => a > 0).length === 0) {
                showMessage('è«‹è‡³å°‘å›ç­”ä¸€é¡Œï¼', 'error');
                return;
            }

            await submitAnswer(JSON.stringify(answers));
            showMessage('ç­”æ¡ˆå·²æäº¤ï¼', 'success');
            document.getElementById('submit-reading-btn').disabled = true;

            // Clear local answers after successful submission
            currentReadingAnswers = [];
        }

        /**
         * AI generate PIRLS reading questions
         */
        async function generatePIRLSQuestions() {
            const aiTopicTextarea = document.getElementById('ai-reading-topic-textarea');
            const readingTextTextarea = document.getElementById('reading-text-textarea');
            const questionsTextarea = document.getElementById('reading-questions-textarea');
            const aiBtn = document.getElementById('ai-generate-reading-btn');
            const aiIcon = document.getElementById('ai-reading-btn-icon');
            const aiText = document.getElementById('ai-reading-btn-text');
            const aiSpinner = document.getElementById('ai-reading-loading-spinner');

            const topic = aiTopicTextarea.value.trim();
            const existingText = readingTextTextarea.value.trim();

            if (!topic) {
                showMessage('è«‹è¼¸å…¥å‡ºé¡Œè¦æ±‚ï¼', 'error');
                return;
            }

            // Show loading
            aiBtn.disabled = true;
            aiText.textContent = 'ç”Ÿæˆä¸­...';
            aiIcon.classList.remove('fa-magic');
            aiIcon.classList.add('fa-spinner', 'fa-spin');
            aiSpinner.classList.remove('hidden');

            try {
                const prompt = existingText
                    ? `æ ¹æ“šä»¥ä¸‹æ–‡æœ¬ï¼Œä¾ç…§ PIRLS é–±è®€ç†è§£çš„ 4 å€‹å±¤æ¬¡ç”Ÿæˆ 10 é¡Œé¸æ“‡é¡Œï¼š
å±¤æ¬¡1ï¼ˆç›´æ¥æå–è³‡è¨Šï¼‰ï¼š3é¡Œ
å±¤æ¬¡2ï¼ˆç›´æ¥æ¨è«–ï¼‰ï¼š3é¡Œ
å±¤æ¬¡3ï¼ˆè©®é‡‹æ•´åˆè³‡è¨Šï¼‰ï¼š2é¡Œ
å±¤æ¬¡4ï¼ˆæ¯”è¼ƒè©•ä¼°å…§å®¹ï¼‰ï¼š2é¡Œ

æ–‡æœ¬ï¼š
${existingText}

è¦æ±‚ï¼š${topic}

è«‹æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¼¸å‡ºï¼Œæ¯è¡Œä¸€é¡Œï¼š
é¡Œç›®,æ­£ç¢ºç­”æ¡ˆ(1-4),é¸é …1,é¸é …2,é¸é …3,é¸é …4,å±¤æ¬¡(1-4)

ç¯„ä¾‹ï¼š
ä¸»è§’çš„åå­—æ˜¯ä»€éº¼?,2,å°æ˜,å°è¯,å°ç¾,å°å¼·,1`
                    : `è«‹æ ¹æ“šä»¥ä¸‹ä¸»é¡Œç”Ÿæˆä¸€ç¯‡é©åˆçš„é–±è®€æ–‡æœ¬ï¼Œä¸¦ä¾ç…§ PIRLS é–±è®€ç†è§£çš„ 4 å€‹å±¤æ¬¡ç”Ÿæˆ 10 é¡Œé¸æ“‡é¡Œï¼š
å±¤æ¬¡1ï¼ˆç›´æ¥æå–è³‡è¨Šï¼‰ï¼š3é¡Œ
å±¤æ¬¡2ï¼ˆç›´æ¥æ¨è«–ï¼‰ï¼š3é¡Œ
å±¤æ¬¡3ï¼ˆè©®é‡‹æ•´åˆè³‡è¨Šï¼‰ï¼š2é¡Œ
å±¤æ¬¡4ï¼ˆæ¯”è¼ƒè©•ä¼°å…§å®¹ï¼‰ï¼š2é¡Œ

ä¸»é¡Œï¼š${topic}

è«‹å…ˆè¼¸å‡ºæ–‡æœ¬ï¼Œç„¶å¾Œè¼¸å‡ºã€Œ---é¡Œç›®---ã€ï¼Œå†æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¼¸å‡ºé¡Œç›®ï¼Œæ¯è¡Œä¸€é¡Œï¼š
é¡Œç›®,æ­£ç¢ºç­”æ¡ˆ(1-4),é¸é …1,é¸é …2,é¸é …3,é¸é …4,å±¤æ¬¡(1-4)`;

                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: { temperature: 0.7 }
                };

                const apiKey = aiSettings.geminiApiKey;
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`AI API request failed with status ${response.status}`);
                }

                const result = await response.json();
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim();

                if (generatedText) {
                    if (!existingText) {
                        // Parse text and questions
                        const parts = generatedText.split('---é¡Œç›®---');
                        if (parts.length === 2) {
                            readingTextTextarea.value = parts[0].trim();
                            questionsTextarea.value = parts[1].trim();
                        } else {
                            questionsTextarea.value = generatedText;
                        }
                    } else {
                        questionsTextarea.value = generatedText;
                    }
                    showMessage('AI é–±è®€æ¸¬é©—å·²æˆåŠŸç”Ÿæˆï¼', 'success');
                } else {
                    throw new Error('AI æœªè¿”å›æœ‰æ•ˆå…§å®¹ã€‚');
                }

            } catch (error) {
                console.error("AI é–±è®€æ¸¬é©—ç”Ÿæˆå¤±æ•—:", error);
                showMessage('AI ç”Ÿæˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key æˆ–ç¶²è·¯é€£ç·šã€‚', 'error');
            } finally {
                aiBtn.disabled = false;
                aiText.textContent = 'AI é–‹å§‹å‡ºé¡Œ';
                aiIcon.classList.add('fa-magic');
                aiIcon.classList.remove('fa-spinner', 'fa-spin');
                aiSpinner.classList.add('hidden');
            }
        }

        /**
         * Show reading comprehension questions modal for teacher
         */
        function showViewReadingQuestionsModal() {
            if (!readingComprehensionData || !readingComprehensionData.questions || readingComprehensionData.questions.length === 0) {
                showMessage('ç›®å‰æ²’æœ‰é–±è®€æ¸¬é©—é¡Œç›®å¯ä»¥æŸ¥çœ‹ã€‚', 'info');
                return;
            }

            const modal = document.getElementById('view-reading-questions-modal');
            const textDisplay = document.getElementById('view-reading-text-display');
            const questionsDisplay = document.getElementById('view-reading-questions-display');

            // Display text
            textDisplay.textContent = readingComprehensionData.text || '(ç„¡æ–‡æœ¬)';

            // Display questions
            questionsDisplay.innerHTML = '';
            readingComprehensionData.questions.forEach((q, index) => {
                const levelIcon = ['ğŸ“–', 'ğŸ’­', 'ğŸ”—', 'âš–ï¸'][q.level - 1];
                const levelText = ['ç›´æ¥æå–', 'ç›´æ¥æ¨è«–', 'è©®é‡‹æ•´åˆ', 'æ¯”è¼ƒè©•ä¼°'][q.level - 1];

                const questionDiv = document.createElement('div');
                questionDiv.className = 'bg-white p-4 rounded-lg border';
                questionDiv.innerHTML = `
                    <div class="flex items-center gap-2 mb-2">
                        <span class="font-bold text-lg">ç¬¬ ${index + 1} é¡Œ</span>
                        <span class="text-sm bg-blue-100 text-blue-700 px-2 py-1 rounded">${levelIcon} å±¤æ¬¡${q.level}: ${levelText}</span>
                    </div>
                    <p class="font-medium text-gray-800 mb-3">${q.question}</p>
                    <div class="space-y-1 ml-4">
                        ${q.options.map((opt, i) => `
                            <div class="flex items-center gap-2">
                                <span class="font-bold ${i + 1 === q.correctAnswer ? 'text-green-600' : 'text-gray-600'}">${i + 1}.</span>
                                <span class="${i + 1 === q.correctAnswer ? 'text-green-600 font-bold' : 'text-gray-700'}">${opt}</span>
                                ${i + 1 === q.correctAnswer ? '<i class="fas fa-check-circle text-green-600 ml-2"></i>' : ''}
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-2 text-sm text-gray-600">
                        <span class="font-bold">æ­£ç¢ºç­”æ¡ˆï¼š</span><span class="text-green-600 font-bold">${q.correctAnswer}</span>
                    </div>
                `;
                questionsDisplay.appendChild(questionDiv);
            });

            modal.classList.remove('hidden');
        }

        /**
         * Hide reading comprehension questions modal
         */
        function hideViewReadingQuestionsModal() {
            document.getElementById('view-reading-questions-modal').classList.add('hidden');
        }

        // === Reading Comprehension Question Bank Functions ===

        /**
         * Load text and questions from separate files
         */
        async function loadReadingFiles() {
            const textFileInput = document.getElementById('reading-text-file-input');
            const questionsFileInput = document.getElementById('reading-questions-file-input');
            const textTextarea = document.getElementById('reading-text-textarea');
            const questionsTextarea = document.getElementById('reading-questions-textarea');

            const textFile = textFileInput.files[0];
            const questionsFile = questionsFileInput.files[0];

            if (!textFile && !questionsFile) {
                showMessage('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æª”æ¡ˆï¼', 'error');
                return;
            }

            try {
                if (textFile) {
                    const textContent = await textFile.text();
                    textTextarea.value = textContent.trim();
                }

                if (questionsFile) {
                    const questionsContent = await questionsFile.text();
                    questionsTextarea.value = questionsContent.trim();
                }

                showMessage('æª”æ¡ˆè¼‰å…¥æˆåŠŸï¼', 'success');

                // Clear file inputs
                textFileInput.value = '';
                questionsFileInput.value = '';
            } catch (error) {
                console.error('è®€å–æª”æ¡ˆå¤±æ•—:', error);
                showMessage('è®€å–æª”æ¡ˆå¤±æ•—ï¼', 'error');
            }
        }

        /**
         * Save reading question bank to localStorage
         */
        function saveReadingQuestionBank() {
            const nameInput = document.getElementById('reading-question-bank-name-input');
            const bankName = nameInput.value.trim();
            const textContent = document.getElementById('reading-text-textarea').value.trim();
            const questionsContent = document.getElementById('reading-questions-textarea').value.trim();

            if (!bankName) {
                showMessage('è«‹è¼¸å…¥é¡Œåº«åç¨±ï¼', 'error');
                return;
            }

            if (!textContent || !questionsContent) {
                showMessage('è«‹å…ˆè¼¸å…¥æ–‡æœ¬å’Œé¡Œç›®ï¼', 'error');
                return;
            }

            // Check if questions are valid
            const questions = parseReadingQuestions(questionsContent);
            if (!questions) {
                showMessage('é¡Œç›®æ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ï¼', 'error');
                return;
            }

            const bank = {
                name: bankName,
                text: textContent,
                questions: questionsContent,
                timestamp: new Date().toISOString()
            };

            // Check if bank name already exists
            const existingIndex = readingQuestionBanks.findIndex(b => b.name === bankName);
            if (existingIndex >= 0) {
                if (!confirm(`é¡Œåº«ã€Œ${bankName}ã€å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†è“‹ï¼Ÿ`)) {
                    return;
                }
                readingQuestionBanks[existingIndex] = bank;
            } else {
                readingQuestionBanks.push(bank);
            }

            localStorage.setItem('readingQuestionBanks', JSON.stringify(readingQuestionBanks));
            updateReadingBankList();
            showMessage(`é¡Œåº«ã€Œ${bankName}ã€å·²å„²å­˜ï¼`, 'success');
            nameInput.value = '';
        }

        /**
         * Update reading question bank list display
         */
        function updateReadingBankList() {
            const listContainer = document.getElementById('reading-question-bank-list');

            if (readingQuestionBanks.length === 0) {
                listContainer.innerHTML = '<div class="text-gray-500 text-sm italic text-center">ç›®å‰æ²’æœ‰å„²å­˜çš„é¡Œåº«</div>';
                return;
            }

            listContainer.innerHTML = readingQuestionBanks.map((bank, index) => `
                <div class="flex items-center justify-between p-2 bg-white border rounded hover:bg-gray-50">
                    <button onclick="loadReadingBankToTextarea(${index})" class="text-left flex-1 text-sm text-blue-600 hover:underline">
                        ${bank.name}
                    </button>
                    <button onclick="deleteReadingBank(${index})" class="text-red-500 hover:text-red-700 ml-2">
                        <i class="fas fa-trash text-xs"></i>
                    </button>
                </div>
            `).join('');
        }

        /**
         * Load reading bank to textarea
         */
        function loadReadingBankToTextarea(index) {
            if (index >= 0 && index < readingQuestionBanks.length) {
                const bank = readingQuestionBanks[index];
                document.getElementById('reading-text-textarea').value = bank.text;
                document.getElementById('reading-questions-textarea').value = bank.questions;
                showMessage(`é¡Œåº«ã€Œ${bank.name}ã€å·²è¼‰å…¥`, 'success');
            }
        }

        /**
         * Delete reading bank
         */
        function deleteReadingBank(index) {
            if (index >= 0 && index < readingQuestionBanks.length) {
                const bankName = readingQuestionBanks[index].name;
                if (confirm(`ç¢ºå®šè¦åˆªé™¤é¡Œåº«ã€Œ${bankName}ã€å—ï¼Ÿ`)) {
                    readingQuestionBanks.splice(index, 1);
                    localStorage.setItem('readingQuestionBanks', JSON.stringify(readingQuestionBanks));
                    updateReadingBankList();
                    showMessage(`é¡Œåº«ã€Œ${bankName}ã€å·²åˆªé™¤`, 'success');
                }
            }
        }

        // Make functions globally accessible
        window.loadReadingBankToTextarea = loadReadingBankToTextarea;
        window.deleteReadingBank = deleteReadingBank;

        // Load reading question banks from localStorage on init
        const savedReadingBanks = localStorage.getItem('readingQuestionBanks');
        if (savedReadingBanks) {
            try {
                readingQuestionBanks = JSON.parse(savedReadingBanks);
                updateReadingBankList();
            } catch (e) {
                console.error('Failed to parse reading question banks:', e);
            }
        }

        // --- Start Application ---
        initialize();
        setupEventListeners(); // Call setupEventListeners only once here.

    </script>
</body>
</html>